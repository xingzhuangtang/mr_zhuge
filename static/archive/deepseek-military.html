<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>å†›äº‹å†å²AIåŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f1419;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }
        
        /* ä¸»å®¹å™¨ */
        .main-container {
            display: flex;
            height: 100vh;
        }
        
        /* å·¦ä¾§å¯¹è¯å†å²é¢æ¿ */
        .chat-history {
            width: 280px;
            background: #141a23;
            border-right: 1px solid #2a2f3a;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        
        .chat-history.collapsed {
            width: 0;
            overflow: hidden;
        }
        
        .history-header {
            padding: 20px;
            border-bottom: 1px solid #2a2f3a;
            background: #1a2029;
        }
        
        .history-title {
            font-size: 16px;
            font-weight: 600;
            color: #ffd700;
            margin-bottom: 10px;
        }
        
        .new-chat-btn {
            width: 100%;
            padding: 10px;
            background: #2a2f3a;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .new-chat-btn:hover {
            background: #364152;
        }
        
        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .history-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #1a2029;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }
        
        .history-item:hover {
            background: #222a36;
            border-left-color: #ffd700;
        }
        
        .history-item.active {
            background: #252d3c;
            border-left-color: #ffd700;
        }
        
        .history-item-title {
            font-size: 13px;
            color: #e2e8f0;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .history-item-time {
            font-size: 11px;
            color: #64748b;
        }
        
        /* èŠå¤©åŒºåŸŸ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .chat-header {
            padding: 20px;
            background: #141a23;
            border-bottom: 1px solid #2a2f3a;
            text-align: center;
        }
        
        .chat-title {
            font-size: 20px;
            font-weight: 600;
            color: #ffd700;
            margin-bottom: 5px;
        }
        
        .chat-subtitle {
            font-size: 14px;
            color: #94a3b8;
        }
        
        .collapse-history-btn {
            position: absolute;
            left: 290px;
            top: 20px;
            background: #2a2f3a;
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            z-index: 1000;
        }
        
        .collapse-history-btn:hover {
            background: #364152;
        }
        
        .collapse-history-btn.collapsed {
            left: 10px;
        }
        
        /* å¯¹è¯åŒºåŸŸ */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #0f1419;
        }
        
        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .message.user .message-avatar {
            background: #ffd700;
            color: #0f1419;
        }
        
        .message.ai .message-avatar {
            background: #2a2f3a;
            color: #ffd700;
        }
        
        .message-content {
            max-width: 70%;
            padding: 15px 18px;
            border-radius: 16px;
            line-height: 1.6;
            word-wrap: break-word;
        }
        
        .message.user .message-content {
            background: #ffd700;
            color: #0f1419;
        }
        
        .message.ai .message-content {
            background: #1a2029;
            color: #e2e8f0;
            border: 1px solid #2a2f3a;
        }
        
        .message.thinking .message-content {
            background: #2a2f3a;
            color: #94a3b8;
            font-style: italic;
        }
        
        /* å›¾ç‰‡æ ·å¼ */
        .message-image {
            margin: 10px 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .message-image img {
            width: 100%;
            height: auto;
            display: block;
            max-height: 300px;
            object-fit: cover;
        }
        
        .image-caption {
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.7);
            color: #e2e8f0;
            font-size: 13px;
            text-align: center;
        }
        
        /* å¯è§†åŒ–æŒ‰é’® */
        .visualization-button {
            margin-top: 15px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .visualization-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }
        
        .visualization-button:active {
            transform: translateY(0);
        }
        
        .visualization-button.hidden {
            display: none;
        }
        
        /* è¾“å…¥åŒºåŸŸ */
        .chat-input-area {
            padding: 20px;
            background: #141a23;
            border-top: 1px solid #2a2f3a;
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .input-container {
            flex: 1;
            position: relative;
            background: #1a2029;
            border: 1px solid #2a2f3a;
            border-radius: 20px;
            padding: 12px 16px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            transition: border-color 0.2s ease;
        }
        
        .input-container:focus-within {
            border-color: #ffd700;
            box-shadow: 0 0 0 1px rgba(255, 215, 0, 0.3);
        }
        
        .chat-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: #fff;
            font-size: 14px;
            line-height: 1.4;
            resize: none;
            max-height: 120px;
            min-height: 20px;
        }
        
        .chat-input::placeholder {
            color: #64748b;
        }
        
        .send-button {
            background: #ffd700;
            color: #0f1419;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .send-button:hover {
            background: #ffed4e;
            transform: scale(1.05);
        }
        
        .send-button:disabled {
            background: #2a2f3a;
            color: #64748b;
            cursor: not-allowed;
            transform: none;
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        .chat-messages::-webkit-scrollbar,
        .history-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-track,
        .history-list::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chat-messages::-webkit-scrollbar-thumb,
        .history-list::-webkit-scrollbar-thumb {
            background: #2a2f3a;
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover,
        .history-list::-webkit-scrollbar-thumb:hover {
            background: #364152;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .chat-history {
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 1000;
                transform: translateX(-100%);
            }
            
            .chat-history.show {
                transform: translateX(0);
            }
            
            .collapse-history-btn {
                display: none;
            }
            
            .message-content {
                max-width: 85%;
            }
        }
        
        /* åŠ¨ç”» */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message {
            animation: fadeIn 0.4s ease;
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #94a3b8;
            font-size: 13px;
        }
        
        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }
        
        .loading-dot {
            width: 6px;
            height: 6px;
            background: #94a3b8;
            border-radius: 50%;
            animation: loadingPulse 1.4s infinite ease-in-out;
        }
        
        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes loadingPulse {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- å·¦ä¾§å¯¹è¯å†å² -->
        <div class="chat-history" id="chatHistory">
            <div class="history-header">
                <div class="history-title">å¯¹è¯å†å²</div>
                <button class="new-chat-btn" onclick="startNewChat()">+ æ–°å¯¹è¯</button>
            </div>
            <div class="history-list" id="historyList">
                <!-- å†å²å¯¹è¯åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- ä¸»è¦èŠå¤©åŒºåŸŸ -->
        <div class="chat-area">
            <button class="collapse-history-btn" onclick="toggleHistory()">â† æ”¶èµ·å†å²</button>
            
            <div class="chat-header">
                <div class="chat-title">ğŸ›ï¸ å†›äº‹å†å²AIåŠ©æ‰‹</div>
                <div class="chat-subtitle">ä¸“ä¸šçš„å†›äº‹å†å²çŸ¥è¯†åº“ Â· æ”¯æŒ3Dæˆ˜å½¹é‡ç°</div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <!-- æ¬¢è¿æ¶ˆæ¯ -->
                <div class="message ai">
                    <div class="message-avatar">ğŸ¤–</div>
                    <div class="message-content">
                        æ¬¢è¿ä½¿ç”¨å†›äº‹å†å²AIåŠ©æ‰‹ï¼<br><br>
                        æˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›ï¼š<br>
                        â€¢ ğŸ“š è¯¦ç»†çš„å†›äº‹å†å²çŸ¥è¯†<br>
                        â€¢ ğŸ—ºï¸ æˆ˜å½¹åœ°å½¢åœ°è²Œåˆ†æ<br>
                        â€¢ âš”ï¸ æˆ˜ç•¥æˆ˜æœ¯è§£è¯»<br>
                        â€¢ ğŸ–¼ï¸ ç›¸å…³å†å²å›¾ç‰‡<br>
                        â€¢ ğŸ® 3Dæˆ˜å½¹é‡ç°<br><br>
                        è¯·è¾“å…¥æ‚¨æƒ³äº†è§£çš„æˆ˜å½¹æˆ–å†›äº‹å†å²é—®é¢˜ï¼Œæˆ‘å°†ä¸ºæ‚¨æä¾›ä¸“ä¸šçš„è§£ç­”ï¼
                    </div>
                </div>
            </div>
            
            <div class="chat-input-area">
                <div class="input-container">
                    <textarea 
                        id="chatInput" 
                        class="chat-input" 
                        placeholder="è¯·è¾“å…¥æ‚¨æƒ³äº†è§£çš„æˆ˜å½¹æˆ–å†›äº‹å†å²é—®é¢˜..."
                        rows="1"
                        oninput="autoResizeTextarea(this)"
                        onkeydown="handleKeyDown(event)"
                    ></textarea>
                </div>
                <button class="send-button" id="sendBtn" onclick="sendMessage()">
                    â¤
                </button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentChatId = generateChatId();
        let chatHistory = JSON.parse(localStorage.getItem('militaryChatHistory') || '[]');
        let isProcessing = false;
        let battleContext = null; // ä¿å­˜æˆ˜å½¹ä¸Šä¸‹æ–‡
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadChatHistory();
            loadCurrentChatHistory();
            autoResizeTextarea(document.getElementById('chatInput'));
        });
        
        // ç”ŸæˆèŠå¤©ID
        function generateChatId() {
            return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // ä¿å­˜èŠå¤©å†å²åˆ°æœ¬åœ°å­˜å‚¨
        function saveChatHistory() {
            localStorage.setItem('militaryChatHistory', JSON.stringify(chatHistory));
        }
        
        // åŠ è½½èŠå¤©å†å²
        function loadChatHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            if (chatHistory.length === 0) {
                historyList.innerHTML = '<div style="padding: 20px; text-align: center; color: #64748b;">æš‚æ— å¯¹è¯å†å²</div>';
                return;
            }
            
            chatHistory.forEach((chat, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                if (chat.id === currentChatId) {
                    historyItem.classList.add('active');
                }
                
                historyItem.innerHTML = `
                    <div class="history-item-title">${chat.title || 'æ— æ ‡é¢˜å¯¹è¯'}</div>
                    <div class="history-item-time">${formatTime(chat.timestamp)}</div>
                `;
                
                historyItem.addEventListener('click', () => switchToChat(chat.id));
                historyList.appendChild(historyItem);
            });
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 1000 * 60 * 60 * 24) {
                return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString('zh-CN');
            }
        }
        
        // åˆ‡æ¢èŠå¤©
        function switchToChat(chatId) {
            currentChatId = chatId;
            loadCurrentChatHistory();
            loadChatHistory();
        }
        
        // åŠ è½½å½“å‰èŠå¤©å†å²
        function loadCurrentChatHistory() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            
            const currentChat = chatHistory.find(chat => chat.id === currentChatId);
            if (currentChat && currentChat.messages) {
                currentChat.messages.forEach(message => {
                    addMessageToDOM(message.content, message.type);
                });
            }
            
            // å¦‚æœæ˜¯ç©ºèŠå¤©ï¼Œæ·»åŠ æ¬¢è¿æ¶ˆæ¯
            if (!currentChat || !currentChat.messages || currentChat.messages.length === 0) {
                addWelcomeMessage();
            }
        }
        
        // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
        function addWelcomeMessage() {
            const messagesContainer = document.getElementById('chatMessages');
            const welcomeMessage = document.createElement('div');
            welcomeMessage.className = 'message ai';
            welcomeMessage.innerHTML = `
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-content">
                    æ¬¢è¿ä½¿ç”¨å†›äº‹å†å²AIåŠ©æ‰‹ï¼<br><br>
                    æˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›ï¼š<br>
                    â€¢ ğŸ“š è¯¦ç»†çš„å†›äº‹å†å²çŸ¥è¯†<br>
                    â€¢ ğŸ—ºï¸ æˆ˜å½¹åœ°å½¢åœ°è²Œåˆ†æ<br>
                    â€¢ âš”ï¸ æˆ˜ç•¥æˆ˜æœ¯è§£è¯»<br>
                    â€¢ ğŸ–¼ï¸ ç›¸å…³å†å²å›¾ç‰‡<br>
                    â€¢ ğŸ® 3Dæˆ˜å½¹é‡ç°<br><br>
                    è¯·è¾“å…¥æ‚¨æƒ³äº†è§£çš„æˆ˜å½¹æˆ–å†›äº‹å†å²é—®é¢˜ï¼Œæˆ‘å°†ä¸ºæ‚¨æä¾›ä¸“ä¸šçš„è§£ç­”ï¼
                </div>
            `;
            messagesContainer.appendChild(welcomeMessage);
        }
        
        // æ–°å¯¹è¯
        function startNewChat() {
            currentChatId = generateChatId();
            document.getElementById('chatMessages').innerHTML = '';
            addWelcomeMessage();
            document.getElementById('chatInput').value = '';
            battleContext = null; // é‡ç½®æˆ˜å½¹ä¸Šä¸‹æ–‡
            loadChatHistory();
        }
        
        // æ”¶èµ·/å±•å¼€å†å²é¢æ¿
        function toggleHistory() {
            const history = document.getElementById('chatHistory');
            const btn = document.querySelector('.collapse-history-btn');
            
            if (history.classList.contains('collapsed')) {
                history.classList.remove('collapsed');
                btn.classList.remove('collapsed');
                btn.textContent = 'â† æ”¶èµ·å†å²';
            } else {
                history.classList.add('collapsed');
                btn.classList.add('collapsed');
                btn.textContent = 'â†’ å±•å¼€å†å²';
            }
        }
        
        // è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = !textarea.value.trim();
        }
        
        // é”®ç›˜äº‹ä»¶å¤„ç†
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message || isProcessing) return;
            
            isProcessing = true;
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessageToDOM(message, 'user');
            input.value = '';
            autoResizeTextarea(input);
            
            // æ·»åŠ AIæ€è€ƒçŠ¶æ€
            const thinkingMessage = addMessageToDOM('æ­£åœ¨åˆ†ææ‚¨çš„é—®é¢˜...', 'thinking');
            
            try {
                // ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°å†å²
                saveMessageToHistory(message, 'user');
                
                // è°ƒç”¨AIæœåŠ¡
                const aiResponse = await callAIService(message);
                
                // ç§»é™¤æ€è€ƒæ¶ˆæ¯
                thinkingMessage.remove();
                
                // æ·»åŠ AIå›å¤
                const aiMessage = addMessageToDOM(aiResponse.content, 'ai');
                
                // å¦‚æœåŒ…å«å›¾ç‰‡ï¼Œæ˜¾ç¤ºå›¾ç‰‡
                if (aiResponse.images && aiResponse.images.length > 0) {
                    displayImages(aiResponse.images, aiMessage);
                }
                
                // å¦‚æœè¯†åˆ«åˆ°æˆ˜å½¹é—®é¢˜ï¼Œæ˜¾ç¤ºå¯è§†åŒ–æŒ‰é’®
                if (aiResponse.isBattle) {
                    showVisualizationButton(aiResponse.battleName, aiMessage);
                }
                
                // ä¿å­˜AIå›å¤åˆ°å†å²
                saveMessageToHistory(aiMessage.innerHTML, 'ai');
                
            } catch (error) {
                thinkingMessage.remove();
                addMessageToDOM('æŠ±æ­‰ï¼ŒAIåŠ©æ‰‹æš‚æ—¶æ— æ³•å“åº”ï¼Œè¯·ç¨åå†è¯•ã€‚', 'ai');
                console.error('AIæœåŠ¡é”™è¯¯:', error);
            }
            
            isProcessing = false;
            sendBtn.disabled = false;
        }
        
        // è°ƒç”¨AIæœåŠ¡ - è¿æ¥çœŸå®å¤§è¯­è¨€æ¨¡å‹
        async function callAIService(message) {
            try {
                // è°ƒç”¨çœŸå®çš„å¤§è¯­è¨€æ¨¡å‹API
                const response = await fetch('/api/v1/llm/military-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: message
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // æ£€æµ‹æ˜¯å¦æ˜¯æˆ˜å½¹ç›¸å…³é—®é¢˜
                const battleName = detectBattleName(message);
                
                if (battleName) {
                    battleContext = { name: battleName, info: getBattleInfo(battleName) };
                    return {
                        content: data.response,
                        isBattle: true,
                        battleName: battleName
                    };
                } else {
                    return {
                        content: data.response,
                        isBattle: false,
                        images: []
                    };
                }
                
            } catch (error) {
                console.error('AIæœåŠ¡è°ƒç”¨å¤±è´¥:', error);
                
                // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œè¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯
                return {
                    content: 'æŠ±æ­‰ï¼ŒAIåŠ©æ‰‹æš‚æ—¶æ— æ³•å“åº”ï¼Œè¯·ç¨åå†è¯•æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚',
                    isBattle: false,
                    images: []
                };
            }
        }
        
        // æ£€æµ‹æˆ˜å½¹åç§°
        function detectBattleName(message) {
            const knownBattles = ['èµ¤å£ä¹‹æˆ˜', 'é©¬æ‹‰æ¾æˆ˜å½¹', 'é»‘æ–¯å»·æ–¯æˆ˜å½¹', 'æ»‘é“å¢æˆ˜å½¹', 'è‘›åº•æ–¯å ¡æˆ˜å½¹'];
            
            for (let battle of knownBattles) {
                if (message.includes(battle)) {
                    return battle;
                }
            }
            
            // æ¨¡ç³ŠåŒ¹é…
            if (message.includes('èµ¤å£')) return 'èµ¤å£ä¹‹æˆ˜';
            if (message.includes('é©¬æ‹‰æ¾')) return 'é©¬æ‹‰æ¾æˆ˜å½¹';
            if (message.includes('é»‘æ–¯å»·æ–¯')) return 'é»‘æ–¯å»·æ–¯æˆ˜å½¹';
            if (message.includes('æ»‘é“å¢')) return 'æ»‘é“å¢æˆ˜å½¹';
            if (message.includes('è‘›åº•æ–¯å ¡')) return 'è‘›åº•æ–¯å ¡æˆ˜å½¹';
            
            return null;
        }
        
        // è·å–æˆ˜å½¹ä¿¡æ¯
        function getBattleInfo(battleName) {
            const battles = {
                'èµ¤å£ä¹‹æˆ˜': {
                    year: 208,
                    location: 'é•¿æ±Ÿèµ¤å£',
                    participants: 'æ›¹æ“å†› vs å­™åˆ˜è”å†›',
                    description: 'ä¸‰å›½æ—¶æœŸæœ€è‘—åçš„æ°´æˆ˜ï¼Œå­™åˆ˜è”å†›ä»¥ç«æ”»å¤§è´¥æ›¹æ“80ä¸‡å¤§å†›ï¼Œå¥ å®šäº†ä¸‰å›½é¼ç«‹çš„åŸºç¡€ã€‚'
                },
                'é©¬æ‹‰æ¾æˆ˜å½¹': {
                    year: -490,
                    location: 'é©¬æ‹‰æ¾å¹³åŸ',
                    participants: 'æ³¢æ–¯å†› vs å¸Œè…Šè”å†›',
                    description: 'å¤å¸Œè…Šé‡è£…æ­¥å…µæ–¹é˜µé¦–æ¬¡å‡»è´¥æ³¢æ–¯å¸å›½çš„å¼“ç®­æ‰‹ï¼Œæ ‡å¿—ç€å¸Œè…Šæ–‡æ˜çš„èƒœåˆ©ã€‚'
                },
                'é»‘æ–¯å»·æ–¯æˆ˜å½¹': {
                    year: 1066,
                    location: 'é»‘æ–¯å»·æ–¯',
                    participants: 'ç›æ ¼é²-æ’’å…‹é€Šå†› vs è¯ºæ›¼å†›',
                    description: 'è¯ºæ›¼å¾æœè‹±æ ¼å…°çš„å†³å®šæ€§æˆ˜å½¹ï¼Œå¨å»‰å¾æœè€…å‡»è´¥å“ˆç½—å¾·äºŒä¸–ï¼Œæ”¹å˜äº†è‹±å›½å†å²ã€‚'
                },
                'æ»‘é“å¢æˆ˜å½¹': {
                    year: 1815,
                    location: 'æ»‘é“å¢',
                    participants: 'æ‹¿ç ´ä»‘å¸å›½å†› vs åæ³•åŒç›Ÿå†›',
                    description: 'æ‹¿ç ´ä»‘çš„æœ€åä¸€æˆ˜ï¼Œå¨çµé¡¿å…¬çˆµä¸å¸ƒå•æ­‡å°”å°†å†›è”æ‰‹å‡»è´¥çš‡å¸ï¼Œç»“æŸäº†æ‹¿ç ´ä»‘æ—¶ä»£ã€‚'
                },
                'è‘›åº•æ–¯å ¡æˆ˜å½¹': {
                    year: 1863,
                    location: 'è‘›åº•æ–¯å ¡',
                    participants: 'å—æ–¹å†› vs è”é‚¦å†›',
                    description: 'ç¾å›½å†…æˆ˜çš„è½¬æŠ˜ç‚¹ï¼Œè”é‚¦å†›å‡»è´¥å—æ–¹å†›ï¼Œé˜»æ­¢äº†å—æ–¹ç‹¬ç«‹çš„ä¼å›¾ã€‚'
                }
            };
            
            return battles[battleName] || null;
        }
        
        // ç”Ÿæˆæˆ˜å½¹å›å¤ï¼ˆå¸¦å›¾ç‰‡æœç´¢åŠŸèƒ½ï¼‰
        async function generateBattleResponseWithImages(message, battleName) {
            const battleInfo = getBattleInfo(battleName);
            if (!battleInfo) {
                return {
                    content: 'æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ²¡æœ‰å…³äºè¿™åœºæˆ˜å½¹çš„è¯¦ç»†ä¿¡æ¯ã€‚',
                    isBattle: false,
                    images: []
                };
            }
            
            // æ¨¡æ‹ŸAIæ­£åœ¨æœç´¢ç›¸å…³å›¾ç‰‡
            await new Promise(resolve => setTimeout(resolve, 800));
            
            let response = `
                <strong>ğŸ›ï¸ ${battleName} - è¯¦ç»†åˆ†æ</strong><br><br>
                
                <strong>ğŸ“… åŸºæœ¬ä¿¡æ¯ï¼š</strong><br>
                â€¢ æ—¶é—´ï¼š${battleInfo.year > 0 ? battleInfo.year + 'å¹´' : 'å‰' + Math.abs(battleInfo.year) + 'å¹´'}<br>
                â€¢ åœ°ç‚¹ï¼š${battleInfo.location}<br>
                â€¢ å‚æˆ˜åŒæ–¹ï¼š${battleInfo.participants}<br><br>
                
                <strong>ğŸ“– å†å²èƒŒæ™¯ï¼š</strong><br>
                ${battleInfo.description}<br><br>
                
                <strong>âš”ï¸ æˆ˜æœ¯åˆ†æï¼š</strong><br>
            `;
            
            // æ ¹æ®ä¸åŒæˆ˜å½¹æ·»åŠ å…·ä½“æˆ˜æœ¯åˆ†æ
            switch (battleName) {
                case 'èµ¤å£ä¹‹æˆ˜':
                    response += `
                        â€¢ ğŸ”¥ ç«æ”»æˆ˜æœ¯çš„ç»å…¸è¿ç”¨<br>
                        â€¢ âš“ è¿ç¯èˆ¹çš„åˆ©å¼Šåˆ†æ<br>
                        â€¢ ğŸŒªï¸ ä¸œå—é£å‘å¯¹æˆ˜å½¹çš„å½±å“<br>
                        â€¢ ğŸ‘¥ å­™åˆ˜è”å†›åè°ƒä½œæˆ˜çš„ç­–ç•¥<br><br>
                        
                        <strong>ğŸ¯ å…³é”®è½¬æŠ˜ï¼š</strong><br>
                        ä¸œå—é£çš„çªç„¶å‡ºç°ä¸ºç«æ”»æä¾›äº†æ¡ä»¶ï¼Œè¿™æ˜¯å­™åˆ˜è”å†›èƒœåˆ©çš„å…³é”®å› ç´ ã€‚å‘¨ç‘œå’Œè¯¸è‘›äº®çš„å¤©æ–‡çŸ¥è¯†ï¼Œä»¥åŠé»„ç›–çš„è‹¦è‚‰è®¡ï¼Œå…±åŒä¿ƒæˆäº†è¿™åœºå†³å®šæ€§çš„èƒœåˆ©ã€‚
                    `;
                    break;
                    
                case 'é©¬æ‹‰æ¾æˆ˜å½¹':
                    response += `
                        â€¢ ğŸ›¡ï¸ é‡è£…æ­¥å…µæ–¹é˜µçš„æˆ˜æœ¯ä¼˜åŠ¿<br>
                        â€¢ ğŸ¹ æ³¢æ–¯å¼“ç®­æ‰‹vså¸Œè…Šç›¾ç‰Œçš„å¯¹æŠ—<br>
                        â€¢ ğŸ’ª å¸Œè…Šäººçš„å‹‡æ•¢ç²¾ç¥ä¸è®­ç»ƒ<br>
                        â€¢ â›°ï¸ åœ°å½¢å¯¹å¸Œè…Šæœ‰åˆ©çš„åˆ†æ<br><br>
                        
                        <strong>ğŸ¯ å…³é”®è½¬æŠ˜ï¼š</strong><br>
                        å¸Œè…Šé‡è£…æ­¥å…µçš„ç›¾ç‰Œæ–¹é˜µåœ¨è¿‘æˆ˜ä¸­å……åˆ†å‘æŒ¥ä¼˜åŠ¿ï¼Œè€Œæ³¢æ–¯äººåœ¨å¤±å»è¿œè·ç¦»ä¼˜åŠ¿åé™·å…¥è¢«åŠ¨ã€‚
                    `;
                    break;
                    
                case 'é»‘æ–¯å»·æ–¯æˆ˜å½¹':
                    response += `
                        â€¢ ğŸ è¯ºæ›¼éª‘å…µçš„å†²å‡»åŠ›<br>
                        â€¢ ğŸ° ç›æ ¼é²-æ’’å…‹é€Šç›¾ç‰Œå¢™çš„åšå›ºæ€§<br>
                        â€¢ ğŸ¹ è¯ºæ›¼å¼“ç®­æ‰‹çš„è¿œç¨‹æ‰“å‡»<br>
                        â€¢ âš”ï¸ å“ˆç½—å¾·æˆ˜æ­»å¯¹æˆ˜å½¹çš„å½±å“<br><br>
                        
                        <strong>ğŸ¯ å…³é”®è½¬æŠ˜ï¼š</strong><br>
                        å“ˆç½—å¾·å›½ç‹åœ¨æˆ˜æ–—ä¸­çš„é˜µäº¡ä½¿å¾—ç›æ ¼é²-æ’’å…‹é€Šå†›é˜Ÿå¤±å»æŒ‡æŒ¥ï¼Œæœ€ç»ˆå¯¼è‡´äº†è‹±æ ¼å…°çš„å¾æœã€‚
                    `;
                    break;
                    
                case 'æ»‘é“å¢æˆ˜å½¹':
                    response += `
                        â€¢ ğŸ’£ æ‹¿ç ´ä»‘çš„ç‚®å…µä¼˜åŠ¿<br>
                        â€¢ ğŸ›¡ï¸ åæ³•åŒç›Ÿçš„åšå›ºé˜²å¾¡<br>
                        â€¢ ğŸš© æ™®é²å£«æ´å†›çš„é‡è¦æ€§<br>
                        â€¢ â›°ï¸ åœ°å½¢å¯¹é˜²å¾¡æ–¹çš„æœ‰åˆ©å½±å“<br><br>
                        
                        <strong>ğŸ¯ å…³é”®è½¬æŠ˜ï¼š</strong><br>
                        å¸ƒå•æ­‡å°”å°†å†›çš„æ™®é²å£«æ´å†›çš„åŠæ—¶åˆ°è¾¾ï¼Œæˆä¸ºå‡»è´¥æ‹¿ç ´ä»‘çš„å†³å®šæ€§å› ç´ ã€‚
                    `;
                    break;
                    
                case 'è‘›åº•æ–¯å ¡æˆ˜å½¹':
                    response += `
                        â€¢ ğŸ éª‘å…µä¾¦å¯Ÿä¸æƒ…æŠ¥ä¼˜åŠ¿<br>
                        â€¢ â›°ï¸ é«˜åœ°é˜²å¾¡æˆ˜æœ¯<br>
                        â€¢ âš”ï¸ è¿›æ”»æ–¹ä¸é˜²å¾¡æ–¹çš„åœ°å½¢é€‰æ‹©<br>
                        â€¢ ğŸ“… è¿ç»­ä¸‰å¤©çš„æ¿€çƒˆäº‰å¤º<br><br>
                        
                        <strong>ğŸ¯ å…³é”®è½¬æŠ˜ï¼š</strong><br>
                        å—æ–¹å†›çš®å…‹ç‰¹çš„"è¿›å†›è‘›åº•æ–¯å ¡"è¡ŒåŠ¨å¤±è´¥ï¼Œæ ‡å¿—ç€å—æ–¹å†›é˜Ÿçš„è½¬æŠ˜ç‚¹ã€‚
                    `;
                    break;
            }
            
            response += `<br><br>ğŸ’¡ æƒ³è¦è§‚çœ‹è¿™åœºæˆ˜å½¹çš„3Dé‡ç°å—ï¼Ÿç‚¹å‡»ä¸‹æ–¹çš„æŒ‰é’®å³å¯å¼€å§‹ï¼`;
            
            // è‡ªåŠ¨æœç´¢ç›¸å…³å†å²å†›äº‹å›¾ç‰‡
            const images = await searchBattleImages(battleName);
            
            return {
                content: response,
                isBattle: true,
                battleName: battleName,
                images: images
            };
        }
        
        // æœç´¢æˆ˜å½¹ç›¸å…³å›¾ç‰‡ - ä½¿ç”¨æ›´ç›¸å…³çš„å†›äº‹å†å²å›¾ç‰‡
        async function searchBattleImages(battleName) {
            // æ¨¡æ‹Ÿå›¾ç‰‡æœç´¢å»¶è¿Ÿ
            await new Promise(resolve => setTimeout(resolve, 800));
            
            // æ ¹æ®ä¸åŒæˆ˜å½¹ä½¿ç”¨ç›¸å…³çš„å†å²å›¾ç‰‡
            const battleImageMap = {
                'èµ¤å£ä¹‹æˆ˜': [
                    {
                        url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=250&fit=crop',
                        caption: 'ğŸ›ï¸ é•¿æ±Ÿèµ¤å£åœ°å½¢å›¾ - ä¸‰å›½æ—¶æœŸè‘—åæ°´æˆ˜åœ°ç‚¹',
                        category: 'terrain'
                    },
                    {
                        url: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=250&fit=crop',
                        caption: 'âš”ï¸ ä¸‰å›½æˆ˜èˆ¹å’Œå…µå™¨ - å¤ä»£æ°´æˆ˜è£…å¤‡',
                        category: 'troops'
                    },
                    {
                        url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=250&fit=crop',
                        caption: 'ğŸ”¥ ç«æ”»æˆ˜æœ¯ç¤ºæ„å›¾ - èµ¤å£ä¹‹æˆ˜å…³é”®æˆ˜æœ¯',
                        category: 'tactics'
                    },
                    {
                        url: 'https://images.unsplash.com/photo-1544966503-7cc5ac882d5a?w=400&h=250&fit=crop',
                        caption: 'ğŸ›ï¸ ä¸‰å›½å†å²æ–‡ç‰© - å¤ä»£é’é“œå…µå™¨å’Œé’±å¸',
                        category: 'artifacts'
                    }
                ],
                'é©¬æ‹‰æ¾æˆ˜å½¹': [
                    {
                        url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=250&fit=crop',
                        caption: 'ğŸ—ºï¸ å¸Œè…Šé©¬æ‹‰æ¾å¹³åŸåœ°å½¢ - å¸Œæ³¢æˆ˜äº‰ä¸»æˆ˜åœº',
                        category: 'terrain'
                    },
                    {
                        url: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=250&fit=crop',
                        caption: 'âš”ï¸ å¸Œè…Šé‡è£…æ­¥å…µ - å¤å…¸å¸Œè…Šå†›äº‹åŠ›é‡',
                        category: 'troops'
                    },
                    {
                        url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=250&fit=crop',
                        caption: 'ğŸ“‹ ç›¾ç‰Œæ–¹é˜µæˆ˜æœ¯ - å¸Œè…Šå†›äº‹æˆ˜æœ¯ç»å…¸',
                        category: 'tactics'
                    },
                    {
                        url: 'https://images.unsplash.com/photo-1544966503-7cc5ac882d5a?w=400&h=250&fit=crop',
                        caption: 'ğŸ›ï¸ å¤å¸Œè…Šæ–‡ç‰© - é’é“œç›¾ç‰Œå’Œé•¿çŸ›',
                        category: 'artifacts'
                    }
                ],
                'æ»‘é“å¢æˆ˜å½¹': [
                    {
                        url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=250&fit=crop',
                        caption: 'ğŸ—ºï¸ æ¯”åˆ©æ—¶æ»‘é“å¢å¹³åŸ - æ‹¿ç ´ä»‘æœ€åæˆ˜åœº',
                        category: 'terrain'
                    },
                    {
                        url: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=250&fit=crop',
                        caption: 'âš”ï¸ æ‹¿ç ´ä»‘å¸å›½å†› - 19ä¸–çºªæ¬§æ´²å†›é˜Ÿ',
                        category: 'troops'
                    },
                    {
                        url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=250&fit=crop',
                        caption: 'ğŸ’£ å¤§ç‚®é˜µåœ°æˆ˜æœ¯ - æ‹¿ç ´ä»‘æ—¶ä»£ç‚®å…µ',
                        category: 'tactics'
                    },
                    {
                        url: 'https://images.unsplash.com/photo-1544966503-7cc5ac882d5a?w=400&h=250&fit=crop',
                        caption: 'ğŸ›ï¸ æ‹¿ç ´ä»‘æ—¶ä»£æ–‡ç‰© - å¸å›½å‹‹ç« å’Œæ­¦å™¨',
                        category: 'artifacts'
                    }
                ],
                'é»‘æ–¯å»·æ–¯æˆ˜å½¹': [
                    {
                        url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=250&fit=crop',
                        caption: 'ğŸ—ºï¸ è‹±å›½é»‘æ–¯å»·æ–¯æˆ˜åœº - è¯ºæ›¼å¾æœå†³å®šåœ°',
                        category: 'terrain'
                    },
                    {
                        url: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=250&fit=crop',
                        caption: 'âš”ï¸ è¯ºæ›¼éª‘å£« - ä¸­ä¸–çºªé‡è£…éª‘å…µ',
                        category: 'troops'
                    },
                    {
                        url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=250&fit=crop',
                        caption: 'ğŸ° ç›¾ç‰Œå¢™é˜²å¾¡ - ä¸­ä¸–çºªå†›äº‹æˆ˜æœ¯',
                        category: 'tactics'
                    },
                    {
                        url: 'https://images.unsplash.com/photo-1544966503-7cc5ac882d5a?w=400&h=250&fit=crop',
                        caption: 'ğŸ›ï¸ ä¸­ä¸–çºªæ–‡ç‰© - éª‘å£«ç›”ç”²å’Œé•¿å‰‘',
                        category: 'artifacts'
                    }
                ],
                'è‘›åº•æ–¯å ¡æˆ˜å½¹': [
                    {
                        url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=250&fit=crop',
                        caption: 'ğŸ—ºï¸ ç¾å›½è‘›åº•æ–¯å ¡æˆ˜åœº - å†…æˆ˜è½¬æŠ˜ç‚¹',
                        category: 'terrain'
                    },
                    {
                        url: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=250&fit=crop',
                        caption: 'âš”ï¸ ç¾å›½å†…æˆ˜å†›é˜Ÿ - 19ä¸–çºªæ­¥å…µå’Œéª‘å…µ',
                        category: 'troops'
                    },
                    {
                        url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=250&fit=crop',
                        caption: 'ğŸ”« æ­¥æªæ–¹é˜µæˆ˜æœ¯ - ç¾å›½å†…æˆ˜å†›äº‹æŠ€æœ¯',
                        category: 'tactics'
                    },
                    {
                        url: 'https://images.unsplash.com/photo-1544966503-7cc5ac882d5a?w=400&h=250&fit=crop',
                        caption: 'ğŸ›ï¸ å†…æˆ˜æ–‡ç‰© - å—åŒ—æˆ˜äº‰å‹‹ç« å’Œæ­¦å™¨',
                        category: 'artifacts'
                    }
                ]
            };
            
            // è¿”å›å¯¹åº”çš„æˆ˜å½¹å›¾ç‰‡ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ™è¿”å›é€šç”¨å›¾ç‰‡
            return battleImageMap[battleName] || [
                {
                    url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=250&fit=crop',
                    caption: `ğŸ—ºï¸ ${battleName}æˆ˜åœºåœ°å½¢å›¾`,
                    category: 'terrain'
                },
                {
                    url: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=250&fit=crop',
                    caption: `âš”ï¸ ${battleName}å‚æˆ˜å†›é˜Ÿ`,
                    category: 'troops'
                },
                {
                    url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=250&fit=crop',
                    caption: `ğŸ“‹ ${battleName}æˆ˜æœ¯åˆ†æ`,
                    category: 'tactics'
                },
                {
                    url: 'https://images.unsplash.com/photo-1544966503-7cc5ac882d5a?w=400&h=250&fit=crop',
                    caption: `ğŸ›ï¸ ${battleName}å†å²æ–‡ç‰©`,
                    category: 'artifacts'
                }
            ];
        }
        
        // ç®€å•çš„å“ˆå¸Œå‡½æ•°
        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return hash;
        }
        
        // ç”Ÿæˆé€šç”¨å›å¤
        function generateGeneralResponse(message) {
            return {
                content: `å…³äº"${message}"è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘éœ€è¦æ›´å…·ä½“çš„ä¿¡æ¯æ‰èƒ½ä¸ºæ‚¨æä¾›å‡†ç¡®çš„å›ç­”ã€‚è¯·æ‚¨ï¼š<br><br>
                
                1. ğŸ›ï¸ æŒ‡å®šå…·ä½“çš„æˆ˜å½¹åç§°ï¼ˆå¦‚ï¼šèµ¤å£ä¹‹æˆ˜ã€æ»‘é“å¢æˆ˜å½¹ç­‰ï¼‰<br>
                2. âš”ï¸ è¯¢é—®ç‰¹å®šçš„å†›äº‹ç­–ç•¥æˆ–æˆ˜æœ¯<br>
                3. ğŸ“š äº†è§£æŸä¸ªå†å²æ—¶æœŸçš„å†›äº‹ç‰¹ç‚¹<br><br>
                
                æˆ‘å°†æ ¹æ®æ‚¨çš„å…·ä½“é—®é¢˜æä¾›è¯¦ç»†çš„å†›äº‹å†å²åˆ†æå’Œç›¸å…³å›¾ç‰‡èµ„æ–™ã€‚`,
                isBattle: false,
                images: []
            };
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°DOM
        function addMessageToDOM(content, type) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const avatarIcon = type === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
            const messageContent = type === 'thinking' 
                ? `<div class="loading-indicator">
                     <span>${content}</span>
                     <div class="loading-dots">
                       <div class="loading-dot"></div>
                       <div class="loading-dot"></div>
                       <div class="loading-dot"></div>
                     </div>
                   </div>`
                : content;
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatarIcon}</div>
                <div class="message-content">${messageContent}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageDiv.querySelector('.message-content');
        }
        
        // æ˜¾ç¤ºå›¾ç‰‡
        function displayImages(images, container) {
            images.forEach(image => {
                const imageDiv = document.createElement('div');
                imageDiv.className = 'message-image';
                imageDiv.innerHTML = `
                    <img src="${image.url}" alt="${image.caption}" loading="lazy">
                    <div class="image-caption">${image.caption}</div>
                `;
                container.appendChild(imageDiv);
            });
        }
        
        // æ˜¾ç¤ºå¯è§†åŒ–æŒ‰é’®
        function showVisualizationButton(battleName, container) {
            const button = document.createElement('button');
            button.className = 'visualization-button';
            button.innerHTML = 'ğŸ® å¼€å¯3Dæˆ˜å½¹é‡ç°';
            button.onclick = () => openVisualization(battleName);
            container.appendChild(button);
        }
        
        // æ‰“å¼€å¯è§†åŒ–é¡µé¢
        function openVisualization(battleName) {
            // ä¿å­˜å½“å‰å¯¹è¯åˆ°å†å²
            const currentChat = chatHistory.find(chat => chat.id === currentChatId);
            if (currentChat) {
                currentChat.title = currentChat.messages && currentChat.messages.length > 0 
                    ? currentChat.messages[0].content.substring(0, 30) + '...'
                    : battleName;
                currentChat.timestamp = Date.now();
                saveChatHistory();
            }
            
            // è·å–æˆ˜å½¹ID
            const battleMap = {
                'èµ¤å£ä¹‹æˆ˜': 'chibi_208',
                'é©¬æ‹‰æ¾æˆ˜å½¹': 'marathon_490bc',
                'é»‘æ–¯å»·æ–¯æˆ˜å½¹': 'hastings_1066',
                'æ»‘é“å¢æˆ˜å½¹': 'waterloo_1815',
                'è‘›åº•æ–¯å ¡æˆ˜å½¹': 'gettysburg_1863'
            };
            
            const battleId = battleMap[battleName];
            if (battleId) {
                window.open(`battle-visualization-deepseek.html?battle=${encodeURIComponent(battleName)}&id=${battleId}`, '_blank');
            } else {
                alert('æŠ±æ­‰ï¼Œæš‚ä¸æ”¯æŒè¯¥æˆ˜å½¹çš„3Dé‡ç°åŠŸèƒ½ã€‚');
            }
        }
        
        // ä¿å­˜æ¶ˆæ¯åˆ°å†å²
        function saveMessageToHistory(content, type) {
            let currentChat = chatHistory.find(chat => chat.id === currentChatId);
            
            if (!currentChat) {
                currentChat = {
                    id: currentChatId,
                    title: '',
                    timestamp: Date.now(),
                    messages: []
                };
                chatHistory.unshift(currentChat);
            }
            
            currentChat.messages.push({
                content: content,
                type: type,
                timestamp: Date.now()
            });
            
            // é™åˆ¶å†å²è®°å½•æ•°é‡
            if (chatHistory.length > 50) {
                chatHistory = chatHistory.slice(0, 50);
            }
            
            saveChatHistory();
            loadChatHistory();
        }
    </script>
</body>
</html>