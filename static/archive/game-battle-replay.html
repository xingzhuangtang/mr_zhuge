<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>å…¨é¢æˆ˜äº‰é£æ ¼ Â· å†å²æˆ˜å½¹å¯è§†åŒ–</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: "Microsoft YaHei", sans-serif;
            background: #0a0a0a;
        }
        
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            display: flex;
            flex-direction: column;
        }
        
        #cesiumContainer {
            position: absolute;
            top: 5%;
            left: 5%;
            width: 65%;
            height: 75%;
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(2px);
        }
        
        /* æ’­æ”¾æ—¶åŠ¨ç”»çª—å£æœ€å¤§åŒ– */
        #cesiumContainer.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 5000;
            border: none;
            border-radius: 0;
            box-shadow: none;
        }
        
        /* æ–°å¸ƒå±€ï¼šå³ä¾§æ§åˆ¶é¢æ¿ */
        .game-ui {
            position: absolute;
            top: 5%;
            right: 3%;
            width: 280px;
            height: 85%;
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid rgba(255, 215, 0, 0.4);
            border-radius: 12px;
            padding: 16px;
            color: rgba(255, 255, 255, 0.95);
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
            pointer-events: auto;
            overflow-y: auto;
            z-index: 1000;
        }
        
        /* æ’­æ”¾æ—¶é¢æ¿åŠé€æ˜ */
        .game-ui.minimized {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 215, 0, 0.2);
            opacity: 0.8;
        }
        
        .game-ui.minimized:hover {
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid rgba(255, 215, 0, 0.4);
            opacity: 1;
        }
        
        .battle-title {
            font-size: 20px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            margin-bottom: 16px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            padding-bottom: 8px;
            text-align: center;
        }
        
        .controls-section {
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .controls-title {
            font-size: 14px;
            color: #87ceeb;
            margin-bottom: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .control-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 3px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(255, 107, 107, 0.4);
            width: calc(50% - 6px);
            display: inline-block;
            text-align: center;
        }
        
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.6);
        }
        
        .control-btn:active {
            transform: translateY(0);
        }
        
        .control-btn.playing {
            background: linear-gradient(45deg, #10ac84, #00d2d3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* å³ä¾§ä¸Šæ–¹é¢æ¿ï¼šå…µç§ä¿¡æ¯ */
        .units-panel {
            position: absolute;
            top: 5%;
            left: 72%;
            width: 25%;
            max-height: 25%;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #4a90e2;
            border-radius: 12px;
            padding: 16px;
            color: white;
            z-index: 900;
            overflow-y: auto;
            font-family: 'Arial', sans-serif;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
        }
        
        .unit-category {
            margin-bottom: 12px;
            border: 1px solid rgba(74, 144, 226, 0.3);
            border-radius: 6px;
            padding: 10px;
            background: rgba(74, 144, 226, 0.1);
        }
        
        .category-title {
            font-size: 14px;
            color: #4a90e2;
            font-weight: bold;
            margin-bottom: 8px;
            border-bottom: 1px solid #4a90e2;
            padding-bottom: 4px;
        }
        
        .unit-item {
            background: rgba(255, 255, 255, 0.1);
            margin: 4px 0;
            padding: 6px;
            border-radius: 4px;
            border-left: 3px solid #ffd700;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .unit-item:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: translateX(3px);
        }
        
        /* å³ä¾§ä¸‹æ–¹é¢æ¿ï¼šæˆ˜æœ¯ä¿¡æ¯ */
        .tactics-panel {
            position: absolute;
            top: 32%;
            left: 72%;
            width: 25%;
            height: 35%;
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid #ff6b6b;
            border-radius: 12px;
            padding: 16px;
            color: white;
            z-index: 800;
            font-family: 'Arial', sans-serif;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
        }
        
        /* å³ä¾§æœ€ä¸‹æ–¹ï¼šå½“å‰çŠ¶æ€ */
        .current-status {
            position: absolute;
            top: 69%;
            left: 72%;
            width: 25%;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #10ac84;
            border-radius: 12px;
            padding: 16px;
            color: white;
            z-index: 700;
            font-family: 'Arial Black', sans-serif;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
        }
        
        .status-title {
            font-size: 16px;
            color: #10ac84;
            font-weight: bold;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .status-content {
            font-size: 13px;
            line-height: 1.5;
        }
        
        /* æœ€å°åŒ–æ’­æ”¾æ§åˆ¶æ¡ */
        .mini-control-bar {
            position: absolute;
            bottom: 5%;
            left: 8%;
            transform: translateX(-50%);
            z-index: 1200;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid rgba(255, 215, 0, 0.6);
            border-radius: 30px;
            padding: 12px 20px;
            display: flex;
            gap: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .mini-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 215, 0, 0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: rgba(255, 255, 255, 0.95);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
        }
        
        .mini-btn:hover {
            background: rgba(255, 215, 0, 0.3);
            border-color: rgba(255, 215, 0, 0.8);
            color: #fff;
            transform: scale(1.1);
        }
        
        .mini-btn:active {
            transform: scale(0.95);
        }
        
        /* AIèŠå¤©é¢æ¿ - å·¦ä¸‹è§’ */
        .ai-chat-panel {
            position: absolute;
            bottom: 5%;
            left: 3%;
            width: 320px;
            height: 300px;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #9b59b6;
            border-radius: 12px;
            z-index: 1000;
            display: none;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }
        
        /* AIèŠå¤©æŒ‰é’® - å·¦ä¸‹è§’ */
        .ai-chat-float-btn {
            position: absolute;
            bottom: 5%;
            left: 3%;
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            border: 2px solid #fff;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 4px 15px rgba(155, 89, 182, 0.6);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .ai-chat-float-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(155, 89, 182, 0.8);
        }
        
        .ai-chat-float-btn.pulse {
            animation: pulse 2s infinite;
        }
        
        /* AIèŠå¤©é¢æ¿è¯¦ç»†æ ·å¼ */
        .ai-chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
            cursor: pointer;
            border-radius: 10px 10px 0 0;
        }
        
        .ai-title {
            font-weight: bold;
            font-size: 14px;
        }
        
        .ai-toggle-btn {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .ai-toggle-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .ai-chat-messages {
            height: 200px;
            overflow-y: auto;
            padding: 12px;
            background: rgba(0, 0, 0, 0.8);
        }
        
        .ai-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 13px;
            line-height: 1.4;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .ai-welcome {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
            border-bottom-left-radius: 5px;
        }
        
        .ai-user-message {
            background: rgba(52, 152, 219, 0.8);
            color: white;
            margin-left: 20px;
            border-bottom-right-radius: 5px;
        }
        
        .ai-assistant-message {
            background: rgba(46, 204, 113, 0.8);
            color: white;
            border-bottom-left-radius: 5px;
        }
        
        .ai-thinking {
            background: rgba(241, 196, 15, 0.8);
            color: black;
            border-bottom-left-radius: 5px;
            font-style: italic;
        }
        
        .ai-chat-input-container {
            display: flex;
            padding: 12px;
            background: rgba(0, 0, 0, 0.9);
            border-top: 1px solid #9b59b6;
            border-radius: 0 0 10px 10px;
        }
        
        .ai-chat-input-container input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #666;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 12px;
            margin-right: 8px;
        }
        
        .ai-chat-input-container input::placeholder {
            color: #999;
        }
        
        .ai-chat-input-container input:focus {
            outline: none;
            border-color: #9b59b6;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .ai-chat-input-container button {
            padding: 8px 15px;
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .ai-chat-input-container button:hover {
            background: linear-gradient(45deg, #8e44ad, #9b59b6);
            transform: translateY(-1px);
        }
        
        .ai-chat-input-container button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* èŠå¤©é¢æ¿å±•å¼€/æ”¶èµ·åŠ¨ç”» */
        .ai-chat-panel.expanded {
            display: block;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* æ•™å­¦é¢æ¿ - å³ä¸Šè§’ */
        .educational-panel {
            position: absolute;
            top: 5%;
            left: 35%;
            width: 280px;
            height: 200px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #9b59b6;
            border-radius: 12px;
            padding: 16px;
            color: white;
            z-index: 800;
            font-family: 'Arial', sans-serif;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }
        
        .educational-panel .control-btn {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            width: 100%;
            margin: 8px 0;
            font-size: 12px;
            padding: 8px 12px;
        }
        
        .educational-panel .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.6);
        }
        
        #tacticalExplanation {
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 16px;
            color: #ecf0f1;
        }
        
        /* æ€§èƒ½ç›‘æ§é¢æ¿ */
        .performance-panel {
            position: absolute;
            top: 5%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #e74c3c;
            border-radius: 8px;
            padding: 8px 12px;
            color: #e74c3c;
            z-index: 1500;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            min-width: 200px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.8);
        }
        
        /* å•ä½é«˜äº®æ•ˆæœ */
        .unit-highlighted {
            background: rgba(255, 215, 0, 0.3) !important;
            border-left: 5px solid #ffd700 !important;
            animation: highlight-pulse 2s infinite;
        }
        
        @keyframes highlight-pulse {
            0%, 100% { transform: translateX(3px); }
            50% { transform: translateX(8px); }
        }
        
        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-active {
            background-color: #27ae60;
            box-shadow: 0 0 5px #27ae60;
        }
        
        .status-inactive {
            background-color: #e74c3c;
            box-shadow: 0 0 5px #e74c3c;
        }
        
        .status-warning {
            background-color: #f39c12;
            box-shadow: 0 0 5px #f39c12;
        }
        
        /* é¢æ¿éšè—åŠ¨ç”» */
        @keyframes slideOutLeft {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(-100%); opacity: 0; }
        }
        
        @keyframes slideInLeft {
            0% { transform: translateX(-100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        
        .panel-slide-out {
            animation: slideOutLeft 0.5s ease forwards;
        }
        
        .panel-slide-in {
            animation: slideInLeft 0.5s ease forwards;
        }
        
        /* æ’­æ”¾æ¨¡å¼æ ·å¼ */
        .play-mode .game-ui {
            opacity: 0.3;
            transform: translateX(20px);
        }
        
        .play-mode .units-panel,
        .play-mode .tactics-panel,
        .play-mode .current-status,
        .play-mode .educational-panel {
            opacity: 0.1;
            transform: scale(0.9);
        }
        
        .play-mode #cesiumContainer {
            border-color: rgba(255, 215, 0, 0.6);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        }
        
        /* è½½å…¥åŠ¨ç”» */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            transition: opacity 1s ease;
        }
        
        .loading-content {
            text-align: center;
            color: #ffd700;
            font-family: 'Arial Black', sans-serif;
        }
        
        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 6px solid rgba(255, 215, 0, 0.2);
            border-top: 6px solid #ffd700;
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            margin: 0 auto 24px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* æˆ˜å½¹é€‰æ‹©å™¨ */
        .battle-selector {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 3px solid #ffd700;
            border-radius: 20px;
            padding: 40px;
            color: white;
            z-index: 2000;
            text-align: center;
            font-family: 'Arial Black', sans-serif;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            max-width: 500px;
        }
        
        .battle-option {
            background: linear-gradient(45deg, #4a90e2, #357abd);
            color: white;
            border: none;
            padding: 16px 28px;
            margin: 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            width: 100%;
            display: block;
            text-align: left;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }
        
        .battle-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(74, 144, 226, 0.6);
            background: linear-gradient(45deg, #5ba0e2, #457abd);
        }
        
        .battle-option.selected {
            background: linear-gradient(45deg, #10ac84, #00d2d3);
            animation: selected-pulse 2s infinite;
            box-shadow: 0 8px 25px rgba(16, 172, 132, 0.4);
        }
        
        @keyframes selected-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            #cesiumContainer {
                width: 60%;
                height: 70%;
                top: 8%;
                left: 8%;
            }
            
            .game-ui {
                width: 30%;
                right: 2%;
            }
            
            .units-panel,
            .tactics-panel,
            .current-status {
                left: 68%;
                width: 28%;
            }
        }
        
        @media (max-width: 768px) {
            #cesiumContainer {
                position: relative;
                top: auto;
                left: auto;
                width: 100%;
                height: 40vh;
                border: none;
                border-radius: 0;
                order: 1;
            }
            
            .game-ui {
                position: relative;
                top: auto;
                right: auto;
                width: 100%;
                height: auto;
                order: 2;
                margin: 10px;
            }
            
            .units-panel,
            .tactics-panel,
            .current-status,
            .educational-panel {
                position: relative;
                top: auto;
                left: auto;
                width: 100%;
                height: 200px;
                margin: 10px;
                order: 3;
            }
            
            .ai-chat-panel,
            .ai-chat-float-btn {
                position: fixed;
                bottom: 10px;
                left: 10px;
                width: calc(100% - 20px);
            }
            
            .mini-control-bar {
                bottom: 220px;
                left: 50%;
            }
        }
        
        @media (max-width: 480px) {
            .battle-selector {
                width: 95%;
                padding: 20px;
            }
            
            .battle-option {
                font-size: 12px;
                padding: 12px 20px;
            }
            
            .control-btn {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <!-- è½½å…¥ç”»é¢ -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <h2>å…¨é¢æˆ˜äº‰é£æ ¼ Â· å†å²æˆ˜å½¹å¯è§†åŒ–</h2>
                <p>æ­£åœ¨åŠ è½½æˆ˜å½¹æ•°æ®...</p>
            </div>
        </div>
        
        <!-- æˆ˜å½¹é€‰æ‹©å™¨ -->
        <div class="battle-selector" id="battleSelector">
            <h2 style="color: #ffd700; margin-bottom: 24px; font-size: 24px;">é€‰æ‹©å†å²æˆ˜å½¹</h2>
            <button class="battle-option" data-battle="chibi_208">
                <strong>ğŸ›ï¸ èµ¤å£ä¹‹æˆ˜ (208å¹´)</strong><br>
                <small>ä¸‰å›½æ—¶æœŸ Â· æ°´æˆ˜ç»å…¸</small>
            </button>
            <button class="battle-option" data-battle="marathon_490bc">
                <strong>âš”ï¸ é©¬æ‹‰æ¾æˆ˜å½¹ (å‰490å¹´)</strong><br>
                <small>å¤å¸Œè…Š Â· é‡è£…æ­¥å…µå¯¹æŠ—</small>
            </button>
            <button class="battle-option" data-battle="hastings_1066">
                <strong>ğŸ° é»‘æ–¯å»·æ–¯æˆ˜å½¹ (1066å¹´)</strong><br>
                <small>ä¸­ä¸–çºª Â· è¯ºæ›¼å¾æœ</small>
            </button>
            <button class="battle-option" data-battle="waterloo_1815">
                <strong>ğŸ’£ æ»‘é“å¢æˆ˜å½¹ (1815å¹´)</strong><br>
                <small>æ‹¿ç ´ä»‘æ—¶ä»£ Â· å†³æˆ˜</small>
            </button>
            <button class="battle-option" data-battle="gettysburg_1863">
                <strong>ğŸ”« è‘›åº•æ–¯å ¡æˆ˜å½¹ (1863å¹´)</strong><br>
                <small>ç¾å›½å†…æˆ˜ Â· ç°ä»£æˆ˜äº‰</small>
            </button>
        </div>
        
        <!-- 3DåŠ¨ç”»çª—å£ - ä¸­éƒ¨åå·¦ -->
        <div id="cesiumContainer"></div>
        
        <!-- å³ä¾§ä¸»è¦æ§åˆ¶é¢æ¿ -->
        <div class="game-ui" id="mainControlPanel">
            <div class="battle-title" id="battleTitle">âš”ï¸ æˆ˜å½¹å¯è§†åŒ–</div>
            
            <div class="controls-section">
                <div class="controls-title">ğŸ® æ’­æ”¾æ§åˆ¶</div>
                <button class="control-btn" id="playBtn">â–¶ æ’­æ”¾</button>
                <button class="control-btn" id="pauseBtn">â¸ æš‚åœ</button>
                <button class="control-btn" id="resetBtn">â†º é‡ç½®</button>
                <button class="control-btn" id="speedBtn">ğŸš€ å€é€Ÿ</button>
            </div>
            
            <div class="controls-section">
                <div class="controls-title">ğŸ¯ è§‚å¯Ÿæ¨¡å¼</div>
                <button class="control-btn" id="overviewBtn">ğŸ“‹ å…¨æ™¯</button>
                <button class="control-btn" id="tacticalBtn">âš”ï¸ æˆ˜æœ¯</button>
                <button class="control-btn" id="aerialBtn">âœˆï¸ ç©ºä¸­</button>
                <button class="control-btn" id="fullscreenBtn">â›¶ å…¨å±</button>
            </div>
            
            <div class="controls-section">
                <div class="controls-title">ğŸ¨ è§†è§‰æ•ˆæœ</div>
                <button class="control-btn" id="effectsBtn">âœ¨ ç‰¹æ•ˆ</button>
                <button class="control-btn" id="weatherBtn">ğŸŒ¦ï¸ å¤©æ°”</button>
            </div>
            
            <div class="controls-section">
                <div class="controls-title">ğŸµ éŸ³æ•ˆæ§åˆ¶</div>
                <button class="control-btn" id="audioBtn">ğŸ”Š éŸ³æ•ˆ</button>
                <button class="control-btn" id="teachingBtn">ğŸ“š æ•™å­¦</button>
            </div>
        </div>
        
        <!-- å³ä¸Šï¼šå…µç§ä¿¡æ¯é¢æ¿ -->
        <div class="units-panel">
            <div class="controls-title">ğŸ›¡ï¸ å…µç§ä¿¡æ¯</div>
            <div id="unitsInfo">é€‰æ‹©æˆ˜å½¹æŸ¥çœ‹å…µç§è¯¦æƒ…</div>
        </div>
        
        <!-- å³ä¸­ï¼šæˆ˜æœ¯ä¿¡æ¯é¢æ¿ -->
        <div class="tactics-panel">
            <div class="controls-title">ğŸ“š æˆ˜æœ¯è§£æ</div>
            <div id="tacticsInfo">ç­‰å¾…æˆ˜å½¹å¼€å§‹...</div>
        </div>
        
        <!-- å³ä¸‹ï¼šå½“å‰çŠ¶æ€é¢æ¿ -->
        <div class="current-status">
            <div class="status-title">âš¡ å½“å‰çŠ¶æ€</div>
            <div class="status-content" id="currentStatus">
                å‡†å¤‡å°±ç»ª<br>
                è¯·é€‰æ‹©æˆ˜å½¹å¼€å§‹
            </div>
        </div>
        
        <!-- å³ä¸Šï¼šæ•™å­¦é¢æ¿ -->
        <div class="educational-panel" id="educationalPanel">
            <div class="controls-title">ğŸ“š æˆ˜æœ¯æ•™å­¦</div>
            <div id="tacticalExplanation">ç­‰å¾…æˆ˜å½¹å¼€å§‹...</div>
            <button class="control-btn" onclick="nextTacticalStep()">ä¸‹ä¸€æ­¥</button>
        </div>
        
        <!-- å·¦ä¸‹ï¼šAIèŠå¤©æŒ‰é’® -->
        <button class="ai-chat-float-btn pulse" id="aiChatFloatBtn">ğŸ’¬</button>
        
        <!-- å·¦ä¸‹ï¼šAIèŠå¤©é¢æ¿ -->
        <div class="ai-chat-panel" id="aiChatPanel">
            <div class="ai-chat-header">
                <div class="ai-title">ğŸ¤– æˆ˜å½¹AIåŠ©æ‰‹</div>
                <button class="ai-toggle-btn" id="aiToggleBtn">âŒ</button>
            </div>
            <div class="ai-chat-messages" id="aiChatMessages">
                <div class="ai-message ai-welcome">
                    æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„æˆ˜å½¹AIåŠ©æ‰‹ã€‚æ­£åœ¨ä¸ºæ‚¨è®²è§£å†å²æˆ˜å½¹ï¼Œè¯¢é—®ä»»ä½•å…³äºæˆ˜æœ¯ã€å…µç§æˆ–å†å²èƒŒæ™¯çš„é—®é¢˜å§ï¼
                </div>
            </div>
            <div class="ai-chat-input-container">
                <input type="text" id="aiChatInput" placeholder="è¯¢é—®å…³äºæˆ˜å½¹çš„é—®é¢˜..." />
                <button id="aiChatSendBtn">å‘é€</button>
            </div>
        </div>
    </div>

    <!-- åŠ è½½Cesiumåº“ -->
    <script src="cesium/Cesium.js"></script>
    <!-- åŠ è½½å…µç§ç³»ç»Ÿ -->
    <script src="js/unit-system.js"></script>
    <!-- åŠ è½½å„ç§æ¸¸æˆåŒ–ç³»ç»Ÿ -->
    <script src="js/formation-animations.js"></script>
    <script src="js/tactical-animations.js"></script>
    <script src="js/enhanced-terrain.js"></script>
    <script src="js/large-scale-rendering.js"></script>
    <script src="js/weather-environment.js"></script>
    <script src="js/audio-system.js"></script>
    <script src="js/educational-system.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let viewer;
        let currentBattleData = null;
        let isPlaying = false;
        let currentSpeed = 1;
        let processedEvents = new Set();
        let battleArmies = {};
        let animationTime = 0;
        let effectsEnabled = true;
        let weatherEnabled = true;
        let audioEnabled = true;
        let teachingModeEnabled = false;
        let selectedUnits = new Set();
        let battleAnalysis = null;
        let terrainSystem = null;
        let audioSystem = null;
        let performanceMonitor = null;
        let aiChatVisible = false;
        let chatMessageHistory = [];
        let aiSystem = null;
        let formationSystem = null;
        
        // æˆ˜å½¹æ•°æ®å­˜å‚¨
        const battlesDatabase = {
            "chibi_208": {
                name: "èµ¤å£ä¹‹æˆ˜",
                period: "ancient",
                year: 208,
                units: {
                    "cao_cao": ["legionnaire", "archer", "heavy_cavalry"],
                    "sun_liu": ["hoplite", "archer", "horse_archer"]
                },
                tactics: ["fire_attack", "alliance_warfare", "naval_supremacy"]
            },
            "marathon_490bc": {
                name: "é©¬æ‹‰æ¾æˆ˜å½¹",
                period: "ancient", 
                year: -490,
                units: {
                    "persian_empire": ["archer", "legionnaire", "heavy_cavalry"],
                    "greek_city_states": ["hoplite", "peltast"]
                },
                tactics: ["phalanx_charge", "archer_volley"]
            },
            "hastings_1066": {
                name: "é»‘æ–¯å»·æ–¯æˆ˜å½¹",
                period: "medieval",
                year: 1066,
                units: {
                    "anglo_saxons": ["knight", "man_at_arms", "peasant_militia"],
                    "normans": ["knight", "man_at_arms", "crossbowman"]
                },
                tactics: ["shield_wall", "cavalry_assault", "feigned_retreat"]
            },
            "waterloo_1815": {
                name: "æ»‘é“å¢æˆ˜å½¹",
                period: "modern",
                year: 1815,
                units: {
                    "napoleonic_army": ["line_infantry", "cavalry", "field_artillery"],
                    "coalition_army": ["line_infantry", "cavalry", "field_artillery"]
                },
                tactics: ["grand_tactics", "defensive_position"]
            },
            "gettysburg_1863": {
                name: "è‘›åº•æ–¯å ¡æˆ˜å½¹",
                period: "modern",
                year: 1863,
                units: {
                    "confederate_army": ["line_infantry", "cavalry", "field_artillery"],
                    "union_army": ["line_infantry", "cavalry", "field_artillery"]
                },
                tactics: ["offensive_operations", "defensive_positioning"]
            }
        };

        // åˆå§‹åŒ–ç³»ç»Ÿ
        async function initializeSystem() {
            console.log("ğŸš€ åˆå§‹åŒ–å…¨é¢æˆ˜äº‰é£æ ¼æˆ˜å½¹å¯è§†åŒ–ç³»ç»Ÿ...");
            
            // æ˜¾ç¤ºè½½å…¥åŠ¨ç”»
            showLoading();
            
            try {
                // åˆå§‹åŒ–Cesium
                await initializeCesium();
                
                // è½½å…¥æˆ˜å½¹æ•°æ®
                await loadBattleData();
                
                // éšè—è½½å…¥åŠ¨ç”»
                hideLoading();
                
                console.log("âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ");
                
                // åˆå§‹åŒ–æ€§èƒ½ç›‘æ§
                initializePerformanceMonitor();
                
            } catch (error) {
                console.error("âŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:", error);
                updateStatus("ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œæ­£åœ¨å°è¯•å¤‡ç”¨æ–¹æ¡ˆ...");
                
                // å°è¯•å¤‡ç”¨åˆå§‹åŒ–æ–¹æ¡ˆ
                fallbackInitialization();
            }
        }
        
        // åˆå§‹åŒ–æ€§èƒ½ç›‘æ§
        function initializePerformanceMonitor() {
            if (window.PerformanceMonitor) {
                performanceMonitor = new window.PerformanceMonitor();
                if (typeof performanceMonitor.startMonitoring === 'function') {
                    performanceMonitor.startMonitoring();
                }
                
                // æ˜¾ç¤ºæ€§èƒ½é¢æ¿
                showPerformancePanel();
            } else {
                console.log("ğŸ“Š æ€§èƒ½ç›‘æ§æ¨¡å—æœªæ‰¾åˆ°ï¼Œè·³è¿‡æ€§èƒ½ç›‘æ§åˆå§‹åŒ–");
            }
        }
        
        // æ˜¾ç¤ºæ€§èƒ½é¢æ¿
        function showPerformancePanel() {
            const panel = document.createElement('div');
            panel.className = 'performance-panel';
            panel.id = 'performancePanel';
            panel.innerHTML = `
                <div><span class="status-indicator" id="fpsIndicator"></span>FPS: <span id="fpsValue">60</span></div>
                <div><span class="status-indicator" id="memoryIndicator"></span>å†…å­˜: <span id="memoryValue">0 MB</span></div>
                <div><span class="status-indicator" id="entitiesIndicator"></span>å®ä½“: <span id="entitiesValue">0</span></div>
            `;
            document.getElementById('gameContainer').appendChild(panel);
            
            // å®šæœŸæ›´æ–°æ€§èƒ½æ•°æ®
            setInterval(updatePerformanceDisplay, 1000);
        }
        
        // æ›´æ–°æ€§èƒ½æ˜¾ç¤º
        function updatePerformanceDisplay() {
            if (performanceMonitor && performanceMonitor.getFPS) {
                const fps = performanceMonitor.getFPS();
                const memory = performanceMonitor.getMemoryUsage();
                const entities = viewer.entities.values.length;
                
                document.getElementById('fpsValue').textContent = Math.round(fps);
                document.getElementById('memoryValue').textContent = memory.toFixed(1) + ' MB';
                document.getElementById('entitiesValue').textContent = entities;
                
                // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
                updateStatusIndicators(fps, memory, entities);
            }
        }
        
        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateStatusIndicators(fps, memory, entities) {
            const fpsIndicator = document.getElementById('fpsIndicator');
            const memoryIndicator = document.getElementById('memoryIndicator');
            const entitiesIndicator = document.getElementById('entitiesIndicator');
            
            // FPSæŒ‡ç¤ºå™¨
            if (fps >= 30) {
                fpsIndicator.className = 'status-indicator status-active';
            } else if (fps >= 15) {
                fpsIndicator.className = 'status-indicator status-warning';
            } else {
                fpsIndicator.className = 'status-indicator status-inactive';
            }
            
            // å†…å­˜æŒ‡ç¤ºå™¨
            if (memory < 100) {
                memoryIndicator.className = 'status-indicator status-active';
            } else if (memory < 300) {
                memoryIndicator.className = 'status-indicator status-warning';
            } else {
                memoryIndicator.className = 'status-indicator status-inactive';
            }
            
            // å®ä½“æ•°é‡æŒ‡ç¤ºå™¨
            if (entities < 1000) {
                entitiesIndicator.className = 'status-indicator status-active';
            } else if (entities < 5000) {
                entitiesIndicator.className = 'status-indicator status-warning';
            } else {
                entitiesIndicator.className = 'status-indicator status-inactive';
            }
        }
        
        // å¤‡ç”¨åˆå§‹åŒ–æ–¹æ¡ˆ
        function fallbackInitialization() {
            console.log("ğŸ”„ å¯åŠ¨å¤‡ç”¨åˆå§‹åŒ–æ–¹æ¡ˆ...");
            
            try {
                // ä½¿ç”¨ç®€åŒ–ç‰ˆCesiumé…ç½®
                viewer = new Cesium.Viewer('cesiumContainer', {
                    terrainProvider: new Cesium.EllipsoidTerrainProvider(),
                    shouldAnimate: false,
                    infoBox: false,
                    selectionIndicator: false,
                    baseLayerPicker: false,
                    navigationHelpButton: false
                });
                
                // ç®€åŒ–æ¸²æŸ“ä¼˜åŒ–
                viewer.scene.highDynamicRange = false;
                viewer.scene.globe.enableLighting = false;
                
                hideLoading();
                updateStatus("ä½¿ç”¨å¤‡ç”¨æ¨¡å¼ï¼Œéƒ¨åˆ†åŠŸèƒ½å—é™");
                
            } catch (error) {
                console.error("å¤‡ç”¨åˆå§‹åŒ–ä¹Ÿå¤±è´¥:", error);
                updateStatus("ç³»ç»Ÿå®Œå…¨æ— æ³•åˆå§‹åŒ–ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥");
            }
        }
        
        // åˆå§‹åŒ–Cesium
        function initializeCesium() {
            return new Promise((resolve, reject) => {
                try {
                    // é…ç½®å¤šä¸ªåœ°å›¾æºä½œä¸ºå¤‡é€‰
                    const imageryProviders = [
                        // ä¸»è¦ï¼šOpenStreetMap
                        new Cesium.OpenStreetMapImageryProvider({
                            url: 'https://tile.openstreetmap.org/'
                        }),
                        // å¤‡é€‰1ï¼šCartoDB
                        new Cesium.CartoDBImageryProvider({
                            url: 'https://tile.cartocdn.com/'
                        }),
                        // å¤‡é€‰2ï¼šESRI World Imagery
                        new Cesium.ArcGisMapServerImageryProvider({
                            url: 'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer'
                        })
                    ];

                    // é…ç½®åœ°å½¢æä¾›å™¨
                    const terrainProviders = [
                        // ä¸»è¦ï¼šCesium World Terrain
                        new Cesium.CesiumTerrainProvider({
                            url: 'https://assets.cesium.com/1/terrain/',
                            requestVertexNormals: true,
                            requestWaterMask: true
                        }),
                        // å¤‡é€‰ï¼šEllipsoid Terrain
                        new Cesium.EllipsoidTerrainProvider()
                    ];

                    viewer = new Cesium.Viewer('cesiumContainer', {
                        terrainProvider: terrainProviders[0],
                        imageryProvider: imageryProviders[0],
                        shouldAnimate: true, // å¯ç”¨åŠ¨ç”»
                        infoBox: false,
                        selectionIndicator: false,
                        baseLayerPicker: true, // å¯ç”¨å›¾å±‚é€‰æ‹©å™¨
                        navigationHelpButton: true,
                        animation: true, // å¯ç”¨æ—¶é—´è½´
                        timeline: true,  // å¯ç”¨æ—¶é—´è½´
                        sceneModePicker: true,
                        requestRenderMode: false,
                        maximumRenderTimeChange: Infinity,
                        homeButton: true,
                        sceneMode: Cesium.SceneMode.SCENE3D,
                        baseLayerPickerViewModels: [
                            {
                                name: 'OpenStreetMap',
                                iconUrl: 'https://cesium.com/docs/images/imageryProviders/openStreetMap.png',
                                tooltip: 'OpenStreetMap',
                                creationFunction: function() {
                                    return imageryProviders[0];
                                }
                            },
                            {
                                name: 'CartoDB',
                                iconUrl: 'https://cesium.com/docs/images/imageryProviders/cartodb.png',
                                tooltip: 'CartoDB',
                                creationFunction: function() {
                                    return imageryProviders[1];
                                }
                            }
                        ]
                    });
                    
                    // ä¼˜åŒ–åœºæ™¯è®¾ç½®
                    viewer.scene.highDynamicRange = false;
                    viewer.scene.globe.enableLighting = true;
                    viewer.scene.skyAtmosphere.show = true;
                    
                    // è®¾ç½®æ—¶é’Ÿ
                    viewer.clock.shouldAnimate = true;
                    viewer.clock.multiplier = 1.0;
                    
                    // æ·»åŠ é”™è¯¯å¤„ç†
                    viewer.imageryLayers.layerAdded.addEventListener(function(layer) {
                        console.log("åœ°å›¾å›¾å±‚å·²æ·»åŠ :", layer);
                    });
                    
                    viewer.imageryLayers.layerRemoved.addEventListener(function(layer) {
                        console.log("åœ°å›¾å›¾å±‚å·²ç§»é™¤:", layer);
                    });
                    
                    viewer.imageryLayers.layerMoved.addEventListener(function(index, layer) {
                        console.log("åœ°å›¾å›¾å±‚å·²ç§»åŠ¨:", index, layer);
                    });
                    
                    console.log("âœ… Cesiumåˆå§‹åŒ–æˆåŠŸ");
                    resolve();
                    
                } catch (error) {
                    console.error("Cesiumåˆå§‹åŒ–å¤±è´¥:", error);
                    // å°è¯•ä½¿ç”¨æœ€ç®€é…ç½®
                    try {
                        viewer = new Cesium.Viewer('cesiumContainer', {
                            terrainProvider: new Cesium.EllipsoidTerrainProvider(),
                            imageryProvider: new Cesium.OpenStreetMapImageryProvider({
                                url: 'https://tile.openstreetmap.org/'
                            }),
                            shouldAnimate: true,
                            animation: true,
                            timeline: true
                        });
                        console.log("âœ… Cesiumå¤‡ç”¨åˆå§‹åŒ–æˆåŠŸ");
                        resolve();
                    } catch (fallbackError) {
                        console.error("Cesiumå¤‡ç”¨åˆå§‹åŒ–ä¹Ÿå¤±è´¥:", fallbackError);
                        reject(fallbackError);
                    }
                }
            });
        }
        
        // è½½å…¥æˆ˜å½¹æ•°æ®
        async function loadBattleData() {
            try {
                // å…ˆå°è¯•ä»ä¸»æ”¯çŸ¥è¯†åº“åŠ è½½
                const response = await fetch('/static/knowledge_base/military_data/historical_battles.json');
                if (response.ok) {
                    const data = await response.json();
                    console.log("ğŸ“š æˆ˜å½¹æ•°æ®åŠ è½½æˆåŠŸ:", data);
                    window.battlesData = data;
                } else {
                    throw new Error("æˆ˜å½¹æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨");
                }
                
            } catch (error) {
                console.warn("ğŸ“š æˆ˜å½¹æ•°æ®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®:", error);
                // å¦‚æœæ— æ³•åŠ è½½æˆ˜å½¹æ•°æ®ï¼Œä½¿ç”¨åµŒå…¥å¼æ•°æ®
                window.battlesData = {
                    battles: {
                        ancient_battles: {
                            chibi_208: {
                                battle_id: "chibi_208",
                                name: "èµ¤å£ä¹‹æˆ˜",
                                location: { lat: 29.7, lon: 113.9, terrain_type: "river_bank" },
                                participants: [
                                    {
                                        force_id: "cao_cao",
                                        name: "æ›¹æ“å†›",
                                        commander: "æ›¹æ“",
                                        composition: { infantry: 150000, cavalry: 30000, archers: 20000 },
                                        initial_position: [113.88, 29.71]
                                    },
                                    {
                                        force_id: "sun_liu",
                                        name: "å­™åˆ˜è”å†›",
                                        commander: "å‘¨ç‘œã€åˆ˜å¤‡",
                                        composition: { infantry: 30000, cavalry: 5000 },
                                        initial_position: [113.92, 29.75]
                                    }
                                ],
                                battle_timeline: [
                                    {
                                        event_id: "deployment",
                                        timestamp: "208-12-01T00:00:00",
                                        event_type: "deployment",
                                        description: "æ›¹æ“å†›é˜Ÿé›†ç»“äºé•¿æ±ŸåŒ—å²¸",
                                        location: [113.88, 29.71],
                                        participants: ["cao_cao"]
                                    },
                                    {
                                        event_id: "fire_attack",
                                        timestamp: "208-12-07T20:00:00",
                                        event_type: "decisive_maneuver",
                                        description: "ä¸œå—é£èµ·ï¼Œå­™åˆ˜è”å†›å‘èµ·ç«æ”»",
                                        location: [113.90, 29.73],
                                        participants: ["sun_liu"],
                                        effects: { fire: true, weather: "windy" }
                                    },
                                    {
                                        event_id: "retreat",
                                        timestamp: "208-12-08T10:00:00",
                                        event_type: "retreat",
                                        description: "æ›¹æ“å¤§è´¥ï¼Œå¼€å§‹å…¨é¢æ’¤é€€",
                                        location: [113.80, 29.80],
                                        participants: ["cao_cao"]
                                    }
                                ]
                            }
                        },
                        medieval_battles: {
                            hastings_1066: {
                                battle_id: "hastings_1066",
                                name: "é»‘æ–¯å»·æ–¯æˆ˜å½¹",
                                location: { lat: 50.9, lon: 0.5, terrain_type: "hill_plains" },
                                participants: [
                                    {
                                        force_id: "anglo_saxons",
                                        name: "ç›æ ¼é²-æ’’å…‹é€Šå†›",
                                        commander: "å“ˆç½—å¾·äºŒä¸–",
                                        initial_position: [0.51, 50.92]
                                    },
                                    {
                                        force_id: "normans",
                                        name: "è¯ºæ›¼å†›é˜Ÿ",
                                        commander: "å¨å»‰å¾æœè€…",
                                        initial_position: [0.49, 50.88]
                                    }
                                ]
                            }
                        },
                        modern_battles: {
                            waterloo_1815: {
                                battle_id: "waterloo_1815",
                                name: "æ»‘é“å¢æˆ˜å½¹",
                                location: { lat: 50.68, lon: 4.41, terrain_type: "rolling_hills" },
                                participants: [
                                    {
                                        force_id: "napoleonic_army",
                                        name: "æ‹¿ç ´ä»‘å¸å›½å†›",
                                        commander: "æ‹¿ç ´ä»‘ä¸€ä¸–",
                                        initial_position: [4.40, 50.67]
                                    },
                                    {
                                        force_id: "coalition_army",
                                        name: "ç¬¬ä¸ƒæ¬¡åæ³•åŒç›Ÿå†›",
                                        commander: "å¨çµé¡¿å…¬çˆµ",
                                        initial_position: [4.42, 50.69]
                                    }
                                ]
                            }
                        }
                    }
                };
            }
        }
        
        // æ˜¾ç¤ºè½½å…¥åŠ¨ç”»
        function showLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'flex';
        }
        
        // éšè—è½½å…¥åŠ¨ç”»
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            setTimeout(() => {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 1000);
            }, 2000);
        }
        
        // æˆ˜å½¹é€‰æ‹©å¤„ç†
        function handleBattleSelection(battleId) {
            console.log(`ğŸ¯ é€‰æ‹©æˆ˜å½¹: ${battleId}`);
            
            // é«˜äº®é€‰ä¸­çš„æˆ˜å½¹
            document.querySelectorAll('.battle-option').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelector(`[data-battle="${battleId}"]`).classList.add('selected');
            
            // è·å–æˆ˜å½¹æ•°æ®
            const battleData = getBattleData(battleId);
            if (!battleData) {
                console.error(`âŒ æˆ˜å½¹æ•°æ®ä¸å­˜åœ¨: ${battleId}`);
                updateStatus(`æˆ˜å½¹æ•°æ®ä¸å­˜åœ¨: ${battleId}`);
                return;
            }
            
            // è®¾ç½®å½“å‰æˆ˜å½¹
            currentBattleData = battleData;
            
            // æ›´æ–°ç•Œé¢
            updateBattleTitle(battleId);
            updateUnitsPanel(battleData);
            updateTacticsPanel(battleData);
            updateStatus(`å·²é€‰æ‹©: ${battleData.name}ï¼Œç‚¹å‡»æ’­æ”¾å¼€å§‹æˆ˜å½¹`);
            
            // éšè—é€‰æ‹©å™¨ï¼Œæ˜¾ç¤ºæ¸¸æˆç•Œé¢
            setTimeout(() => {
                const selector = document.getElementById('battleSelector');
                selector.style.display = 'none';
                selector.style.visibility = 'hidden';
                selector.style.opacity = '0';
                flyToBattleLocation(battleData);
            }, 1500);
        }
        
        // è·å–æˆ˜å½¹æ•°æ®
        function getBattleData(battleId) {
            const data = window.battlesData;
            if (!data || !data.battles) return null;
            
            // æœç´¢å„ä¸ªå†å²æ—¶æœŸ
            for (const period in data.battles) {
                if (data.battles[period][battleId]) {
                    return data.battles[period][battleId];
                }
            }
            
            return null;
        }
        
        // é£åˆ°æˆ˜å½¹ä½ç½®
        function flyToBattleLocation(battleData) {
            const location = battleData.location;
            if (!location) return;
            
            const destination = Cesium.Cartesian3.fromDegrees(location.lon, location.lat, 15000.0);
            
            viewer.camera.flyTo({
                destination: destination,
                duration: 3.0,
                complete: function() {
                    console.log("ğŸ“ å·²åˆ°è¾¾æˆ˜å½¹ä½ç½®");
                    // å¼€å§‹è‡ªåŠ¨æ’­æ”¾
                    startBattleAnimation();
                }
            });
        }
        
        // æ›´æ–°æˆ˜å½¹æ ‡é¢˜
        function updateBattleTitle(battleId) {
            const battleInfo = battlesDatabase[battleId];
            if (battleInfo) {
                const titleElement = document.getElementById('battleTitle');
                titleElement.textContent = `âš”ï¸ ${battleInfo.name} (${battleInfo.year > 0 ? battleInfo.year : 'å‰' + Math.abs(battleInfo.year)}å¹´)`;
            }
        }
        
        // æ›´æ–°å…µç§é¢æ¿
        function updateUnitsPanel(battleData) {
            const panel = document.getElementById('unitsInfo');
            let html = '';
            
            battleData.participants.forEach(participant => {
                const battleInfo = battlesDatabase[currentBattleData.battle_id];
                const unitTypes = battleInfo.units[participant.force_id];
                
                html += `<div class="unit-category">`;
                html += `<div class="category-title">${participant.name}</div>`;
                html += `<div style="font-size: 11px; color: #ccc; margin-bottom: 5px;">æŒ‡æŒ¥å®˜: ${participant.commander}</div>`;
                
                unitTypes.forEach(unitType => {
                    const unitInfo = getUnitInfo(unitType);
                    if (unitInfo) {
                        html += `<div class="unit-item">`;
                        html += `<strong>${unitInfo.name}</strong><br>`;
                        html += `<span style="color: #87ceeb;">æ”»å‡»: ${unitInfo.tactical_properties.attack_power} | é˜²å¾¡: ${unitInfo.tactical_properties.defense_rating} | æœºåŠ¨: ${unitInfo.tactical_properties.speed}</span>`;
                        html += `</div>`;
                    }
                });
                
                html += `</div>`;
            });
            
            panel.innerHTML = html;
        }
        
        // æ›´æ–°æˆ˜æœ¯é¢æ¿
        function updateTacticsPanel(battleId) {
            const panel = document.getElementById('tacticsInfo');
            const battleInfo = battlesDatabase[battleId];
            
            if (battleInfo && battleInfo.tactics) {
                let html = '<strong>ä¸»è¦æˆ˜æœ¯:</strong><br>';
                battleInfo.tactics.forEach(tactic => {
                    html += `â€¢ ${getTacticDescription(tactic)}<br>`;
                });
                panel.innerHTML = html;
            }
        }
        
        // å®æ—¶æ›´æ–°æˆ˜æœ¯è§£æé¢æ¿
        function updateTacticsPanelWithEvent(event) {
            const panel = document.getElementById('tacticsInfo');
            if (!panel || !event) return;
            
            const eventTime = new Date().toLocaleTimeString('zh-CN');
            const eventType = getEventTypeDisplayName(event.event_type);
            const participants = event.participants ? event.participants.map(pid => getForceName(pid)).join('ã€') : 'æœªçŸ¥';
            
            let html = `<strong>å½“å‰æˆ˜æœ¯äº‹ä»¶ (${eventTime}):</strong><br>`;
            html += `<div style="margin: 8px 0; padding: 8px; background: rgba(255, 215, 0, 0.1); border-left: 3px solid #ffd700; border-radius: 4px;">`;
            html += `<strong>${eventType}</strong><br>`;
            html += `<span style="color: #87ceeb;">${event.description}</span><br>`;
            html += `<small style="color: #ccc;">å‚ä¸æ–¹: ${participants}</small>`;
            html += `</div>`;
            
            // æ·»åŠ æˆ˜æœ¯åˆ†æ
            if (event.event_type === 'decisive_maneuver') {
                html += `<div style="margin-top: 8px; padding: 8px; background: rgba(255, 107, 107, 0.1); border-left: 3px solid #ff6b6b; border-radius: 4px;">`;
                html += `<strong>âš¡ æˆ˜æœ¯åˆ†æ:</strong><br>`;
                html += `<span style="color: #ff6b6b;">è¿™æ˜¯æˆ˜å½¹çš„è½¬æŠ˜ç‚¹ï¼${event.description}</span><br>`;
                html += `<small>æ­¤ç±»è¡ŒåŠ¨å¾€å¾€å†³å®šæˆ˜å½¹èµ°å‘ï¼Œéœ€è¦å¯†åˆ‡å…³æ³¨å…¶åæœã€‚</small>`;
                html += `</div>`;
            } else if (event.event_type === 'deployment') {
                html += `<div style="margin-top: 8px; padding: 8px; background: rgba(16, 172, 132, 0.1); border-left: 3px solid #10ac84; border-radius: 4px;">`;
                html += `<strong>ğŸ“‹ éƒ¨ç½²åˆ†æ:</strong><br>`;
                html += `<span style="color: #10ac84;">${event.description}</span><br>`;
                html += `<small>è‰¯å¥½çš„éƒ¨ç½²æ˜¯èƒœåˆ©çš„åŸºç¡€ï¼Œä½ç½®é€‰æ‹©è‡³å…³é‡è¦ã€‚</small>`;
                html += `</div>`;
            } else if (event.event_type === 'retreat') {
                html += `<div style="margin-top: 8px; padding: 8px; background: rgba(255, 165, 0, 0.1); border-left: 3px solid #ffa500; border-radius: 4px;">`;
                html += `<strong>ğŸƒ æ’¤é€€åˆ†æ:</strong><br>`;
                html += `<span style="color: #ffa500;">${event.description}</span><br>`;
                html += `<small>æœ‰åºæ’¤é€€å¯ä»¥ä¿å­˜å®åŠ›ï¼Œä¸ºåç»­è¡ŒåŠ¨ä¿ç•™æœºä¼šã€‚</small>`;
                html += `</div>`;
            }
            
            // ä¿æŒåŸæœ‰çš„æˆ˜æœ¯ä¿¡æ¯
            if (currentBattleData) {
                const battleInfo = battlesDatabase[currentBattleData.battle_id];
                if (battleInfo && battleInfo.tactics) {
                    html += `<div style="margin-top: 12px; border-top: 1px solid #444; padding-top: 8px;">`;
                    html += `<strong>æˆ˜å½¹ä¸»è¦æˆ˜æœ¯:</strong><br>`;
                    battleInfo.tactics.forEach(tactic => {
                        html += `â€¢ ${getTacticDescription(tactic)}<br>`;
                    });
                    html += `</div>`;
                }
            }
            
            panel.innerHTML = html;
            
            // æ·»åŠ é«˜äº®åŠ¨ç”»æ•ˆæœ
            panel.style.animation = 'pulse 2s ease-in-out';
            setTimeout(() => {
                panel.style.animation = '';
            }, 2000);
        }
        
        // è·å–äº‹ä»¶ç±»å‹æ˜¾ç¤ºåç§°
        function getEventTypeDisplayName(eventType) {
            const typeNames = {
                'deployment': 'ğŸ“ å†›é˜Ÿéƒ¨ç½²',
                'decisive_maneuver': 'âš¡ å†³å®šæ€§è¡ŒåŠ¨',
                'retreat': 'ğŸƒ æˆ˜ç•¥æ’¤é€€',
                'assault': 'âš”ï¸ ä¸»åŠ¨æ”»å‡»',
                'skirmish': 'ğŸ¹ å°è§„æ¨¡å†²çª',
                'artillery_barrage': 'ğŸ’£ ç‚®ç«å‹åˆ¶',
                'cavalry_charge': 'ğŸ éª‘å…µå†²é”‹'
            };
            return typeNames[eventType] || eventType;
        }
        
        // è·å–å…µç§ä¿¡æ¯
        function getUnitInfo(unitType) {
            // åœ¨å…µç§ç³»ç»Ÿä¸­æŸ¥æ‰¾
            const unitSystem = window.UnitSystem;
            if (!unitSystem) return null;
            
            // æœç´¢å„ä¸ªæ—¶æœŸçš„å…µç§
            for (const period in unitSystem) {
                if (unitSystem[period][unitType]) {
                    return unitSystem[period][unitType];
                }
            }
            
            return null;
        }
        
        // è·å–æˆ˜æœ¯æè¿°
        function getTacticDescription(tactic) {
            const descriptions = {
                "fire_attack": "ç«æ”»æˆ˜æœ¯ - åˆ©ç”¨å¤©æ°”å’Œåœ°å½¢ä¼˜åŠ¿",
                "phalanx_charge": "æ–¹é˜µå†²é”‹ - é‡è£…æ­¥å…µå¯†é›†æ”»å‡»",
                "shield_wall": "ç›¾ç‰Œå¢™ - é˜²å¾¡æ€§é˜Ÿå½¢",
                "cavalry_assault": "éª‘å…µçªå‡» - æœºåŠ¨æ€§å¼ºåŠ›æ”»å‡»",
                "archer_volley": "å¼“ç®­é½å°„ - è¿œç¨‹ç«åŠ›å‹åˆ¶",
                "feigned_retreat": "å‡é€€æˆ˜æœ¯ - è¯±æ•Œæ·±å…¥çš„è¯¡è®¡",
                "grand_tactics": "å®å¤§æˆ˜æœ¯ - å¤§è§„æ¨¡ååŒä½œæˆ˜",
                "defensive_position": "é˜²å¾¡é˜µåœ° - å›ºå®ˆä¼˜åŠ¿åœ°å½¢",
                "alliance_warfare": "è”ç›Ÿä½œæˆ˜ - å¤šæ–¹è”åˆå¯¹æŠ—"
            };
            
            return descriptions[tactic] || tactic;
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message) {
            const statusElement = document.getElementById('currentStatus');
            statusElement.innerHTML = message;
        }
        
        // å¼€å§‹æˆ˜å½¹åŠ¨ç”»
        function startBattleAnimation() {
            console.log("ğŸ¬ å¼€å§‹æˆ˜å½¹åŠ¨ç”»");
            isPlaying = true;
            animationTime = 0;
            processedEvents.clear();
            
            // æ›´æ–°æ’­æ”¾æŒ‰é’®çŠ¶æ€
            const playBtn = document.getElementById('playBtn');
            playBtn.textContent = 'â¸ æ’­æ”¾ä¸­';
            playBtn.classList.add('playing');
            
            // å¯ç”¨æ’­æ”¾æ¨¡å¼
            enterPlayMode();
            
            // å¼€å§‹æ¸²æŸ“å¾ªç¯
            startRenderLoop();
            
            // ç«‹å³å¼€å§‹å¤„ç†äº‹ä»¶
            setTimeout(() => {
                processBattleEvents(1);
            }, 1000);
        }
        
        // è¿›å…¥æ’­æ”¾æ¨¡å¼
        function enterPlayMode() {
            document.getElementById('gameContainer').classList.add('play-mode');
            
            // æœ€å°åŒ–æ§åˆ¶é¢æ¿
            const gameUI = document.getElementById('mainControlPanel');
            if (gameUI) {
                gameUI.classList.add('minimized');
            }
            
            // åˆ›å»ºæœ€å°åŒ–æ’­æ”¾æ§åˆ¶æ¡
            createMiniControlBar();
            
            console.log("ğŸ® å·²è¿›å…¥æ’­æ”¾æ¨¡å¼");
        }
        
        // é€€å‡ºæ’­æ”¾æ¨¡å¼
        function exitPlayMode() {
            document.getElementById('gameContainer').classList.remove('play-mode');
            
            // æ¢å¤æ­£å¸¸æ§åˆ¶é¢æ¿
            const gameUI = document.getElementById('mainControlPanel');
            if (gameUI) {
                gameUI.classList.remove('minimized');
            }
            
            // ç§»é™¤æœ€å°åŒ–æ§åˆ¶æ¡
            const miniBar = document.querySelector('.mini-control-bar');
            if (miniBar) {
                miniBar.remove();
            }
            
            console.log("ğŸ® å·²é€€å‡ºæ’­æ”¾æ¨¡å¼");
        }
        
        // åˆ›å»ºæœ€å°åŒ–æ’­æ”¾æ§åˆ¶æ¡
        function createMiniControlBar() {
            // ç§»é™¤å·²å­˜åœ¨çš„æœ€å°åŒ–æ§åˆ¶æ¡
            const existing = document.querySelector('.mini-control-bar');
            if (existing) existing.remove();
            
            const miniBar = document.createElement('div');
            miniBar.className = 'mini-control-bar';
            miniBar.innerHTML = `
                <button class="mini-btn" id="miniPlayBtn">â–¶</button>
                <button class="mini-btn" id="miniPauseBtn">â¸</button>
                <button class="mini-btn" id="miniResetBtn">â†º</button>
                <button class="mini-btn" id="miniSpeedBtn">1x</button>
                <button class="mini-btn" id="miniFullscreenBtn">â›¶</button>
            `;
            
            document.getElementById('gameContainer').appendChild(miniBar);
            
            // æ·»åŠ æœ€å°åŒ–æ§åˆ¶æ¡äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('miniPlayBtn').addEventListener('click', () => {
                if (isPlaying) {
                    pauseBattle();
                } else {
                    resumeBattle();
                }
            });
            
            document.getElementById('miniPauseBtn').addEventListener('click', pauseBattle);
            document.getElementById('miniResetBtn').addEventListener('click', resetBattle);
            document.getElementById('miniSpeedBtn').addEventListener('click', toggleSpeed);
            document.getElementById('miniFullscreenBtn').addEventListener('click', toggleFullscreen);
            
            console.log("ğŸ® æœ€å°åŒ–æ§åˆ¶æ¡å·²åˆ›å»º");
        }
        
        // å…¨å±åˆ‡æ¢åŠŸèƒ½
        function toggleFullscreen() {
            const cesiumContainer = document.getElementById('cesiumContainer');
            
            if (cesiumContainer.classList.contains('fullscreen')) {
                // é€€å‡ºå…¨å±
                cesiumContainer.classList.remove('fullscreen');
                updateStatus("å·²é€€å‡ºå…¨å±æ¨¡å¼");
            } else {
                // è¿›å…¥å…¨å±
                cesiumContainer.classList.add('fullscreen');
                updateStatus("å·²è¿›å…¥å…¨å±æ¨¡å¼");
            }
        }
        
        // å¼€å§‹æ¸²æŸ“å¾ªç¯
        function startRenderLoop() {
            // ä½¿ç”¨Cesiumçš„æ—¶é’Ÿç³»ç»Ÿè¿›è¡ŒåŒæ­¥
            viewer.clock.onTick.addEventListener(function(clock) {
                if (isPlaying) {
                    // æ›´æ–°åŠ¨ç”»æ—¶é—´
                    animationTime = clock.currentTime.secondsOfDay;
                    processBattleEvents(animationTime);
                    updateUI();
                    
                    // å¦‚æœæ’­æ”¾æ—¶é—´è¿‡é•¿ï¼Œåœæ­¢æ’­æ”¾
                    if (animationTime > 60) { // æœ€å¤šæ’­æ”¾60ç§’
                        pauseBattle();
                        console.log("ğŸ¬ æˆ˜å½¹æ’­æ”¾å®Œæˆ");
                    }
                }
            });
            
            console.log("âœ… æ¸²æŸ“å¾ªç¯å·²å¯åŠ¨ï¼Œä¸Cesiumæ—¶é’ŸåŒæ­¥");
        }
        
        // å¤„ç†æˆ˜å½¹äº‹ä»¶
        function processBattleEvents(time) {
            if (!currentBattleData || !currentBattleData.battle_timeline) {
                console.log("âš ï¸ æ²¡æœ‰æˆ˜å½¹æ—¶é—´çº¿æ•°æ®");
                return;
            }
            
            console.log(`ğŸ“Š å¤„ç†æˆ˜å½¹äº‹ä»¶ï¼Œæ—¶é—´: ${time}ç§’`);
            
            currentBattleData.battle_timeline.forEach((event, index) => {
                const eventId = `${event.event_id}_${index}`;
                
                if (!processedEvents.has(eventId)) {
                    // æ ¹æ®æ—¶é—´è§¦å‘äº‹ä»¶
                    const eventTime = getEventTime(index);
                    console.log(`â° æ£€æŸ¥äº‹ä»¶: ${event.event_id}, è§¦å‘æ—¶é—´: ${eventTime}ç§’, å½“å‰æ—¶é—´: ${time}ç§’`);
                    
                    if (time >= eventTime) {
                        console.log(`âš¡ è§¦å‘äº‹ä»¶: ${event.description}`);
                        triggerEvent(event);
                        processedEvents.add(eventId);
                    }
                }
            });
        }
        
        // è·å–äº‹ä»¶æ—¶é—´ï¼ˆæ”¹è¿›ç‰ˆï¼‰
        function getEventTime(eventIndex) {
            // æ¯éš”5ç§’è§¦å‘ä¸€ä¸ªäº‹ä»¶ï¼Œç»™ç”¨æˆ·è¶³å¤Ÿæ—¶é—´è§‚å¯Ÿ
            return eventIndex * 5 + 2; // ç¬¬1ä¸ªäº‹ä»¶åœ¨2ç§’åï¼Œç¬¬2ä¸ªåœ¨7ç§’åï¼Œä»¥æ­¤ç±»æ¨
        }
        
        // è§¦å‘æˆ˜å½¹äº‹ä»¶
        function triggerEvent(event) {
            console.log(`âš¡ è§¦å‘äº‹ä»¶: ${event.description}`);
            
            updateStatus(event.description);
            
            // å®æ—¶æ›´æ–°æˆ˜æœ¯è§£æé¢æ¿
            updateTacticsPanelWithEvent(event);
            
            // æ ¹æ®äº‹ä»¶ç±»å‹æ‰§è¡Œä¸åŒæ•ˆæœ
            switch (event.event_type) {
                case 'deployment':
                    createDeploymentEffect(event);
                    break;
                case 'decisive_maneuver':
                    createDecisiveManeuverEffect(event);
                    break;
                case 'retreat':
                    createRetreatEffect(event);
                    break;
                case 'assault':
                    createAssaultEffect(event);
                    break;
            }
        }
        
        // åˆ›å»ºè®¾ç½®æ•ˆæœ
        function createDeploymentEffect(event) {
            if (effectsEnabled) {
                // åˆ›å»ºå†›é˜Ÿè®¾ç½®åŠ¨ç”»
                createArmyFormation(event);
            }
        }
        
        // åˆ›å»ºå†³å®šæ€§è¡ŒåŠ¨æ•ˆæœ
        function createDecisiveManeuverEffect(event) {
            if (effectsEnabled) {
                // åˆ›å»ºå†³å®šæ€§è¡ŒåŠ¨ç‰¹æ•ˆ
                createBattleEffect(event.location);
                if (event.effects && event.effects.fire) {
                    createFireEffect(event.location);
                }
            }
        }
        
        // åˆ›å»ºæ’¤é€€æ•ˆæœ
        function createRetreatEffect(event) {
            if (effectsEnabled) {
                // åˆ›å»ºæ’¤é€€åŠ¨ç”»
                createRetreatAnimation(event);
            }
        }
        
        // åˆ›å»ºæ”»å‡»æ•ˆæœ
        function createAssaultEffect(event) {
            if (effectsEnabled) {
                // åˆ›å»ºæ”»å‡»åŠ¨ç”»
                createAssaultAnimation(event);
            }
        }
        
        // åˆ›å»ºå†›é˜Ÿè®¾ç½®åŠ¨ç”»
        function createArmyFormation(event) {
            if (!viewer) {
                console.error("Vieweræœªåˆå§‹åŒ–ï¼Œæ— æ³•åˆ›å»ºå†›é˜Ÿè®¾ç½®");
                return;
            }
            
            event.participants.forEach(forceId => {
                const position = Cesium.Cartesian3.fromDegrees(
                    event.location[0], event.location[1], 100
                );
                
                // åˆ›å»ºå†›é˜Ÿå®ä½“
                const armyEntity = viewer.entities.add({
                    position: position,
                    point: {
                        pixelSize: 30,
                        color: getForceColor(forceId),
                        outlineColor: Cesium.Color.WHITE,
                        outlineWidth: 3
                    },
                    label: {
                        text: getForceName(forceId),
                        font: '16px Arial Black',
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE
                    }
                });
                
                // åˆ›å»ºå•ä½ç»„å¹¶æ·»åŠ åˆ°é˜Ÿå½¢ç³»ç»Ÿ
                if (window.FormationAnimationSystem) {
                    // åˆå§‹åŒ–é˜Ÿå½¢ç³»ç»Ÿï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
                    if (!formationSystem) {
                        formationSystem = new window.FormationAnimationSystem(viewer);
                    }
                    
                    const units = createUnitEntities(forceId, position);
                    const unitGroupId = `force_${forceId}_${Date.now()}`;
                    
                    // æ·»åŠ åˆ°é˜Ÿå½¢åŠ¨ç”»ç³»ç»Ÿ
                    formationSystem.addUnitGroup(unitGroupId, units, {
                        lon: event.location[0],
                        lat: event.location[1]
                    });
                    
                    // æ ¹æ®æˆ˜å½¹ç±»å‹é€‰æ‹©åˆé€‚çš„é˜Ÿå½¢
                    const formationType = selectFormationForForce(forceId, currentBattleData.battle_id);
                    if (formationType) {
                        formationSystem.createFormationAnimation(unitGroupId, formationType, {
                            onComplete: (animation) => {
                                console.log(`å†›é˜Ÿ ${forceId} é˜Ÿå½¢è®¾ç½®å®Œæˆ: ${formationType}`);
                            }
                        });
                    }
                }
                
                // æ·»åŠ å¼ºåˆ¶æ•ˆæœ
                createFormationParticles(position, getForceColor(forceId));
            });
        }
        
        // åˆ›å»ºå•ä½å®ä½“
        function createUnitEntities(forceId, centerPosition) {
            const units = [];
            const unitCount = 20; // æ¯ä¸ªå†›é˜Ÿ20ä¸ªå•ä½
            const forceColor = getForceColor(forceId);
            
            for (let i = 0; i < unitCount; i++) {
                // è®¡ç®—å•ä½ä½ç½®ï¼ˆå›´ç»•ä¸­å¿ƒç‚¹åˆ†å¸ƒï¼‰
                const angle = (i / unitCount) * Math.PI * 2;
                const radius = 100 + (i % 3) * 30; // ä¸åŒåœˆå±‚
                const offsetLon = Math.cos(angle) * radius * 0.0001;
                const offsetLat = Math.sin(angle) * radius * 0.0001;
                
                const unitPosition = Cesium.Cartesian3.fromDegrees(
                    centerPosition.lon + offsetLon,
                    centerPosition.lat + offsetLat,
                    50
                );
                
                const unitEntity = viewer.entities.add({
                    position: unitPosition,
                    point: {
                        pixelSize: 15,
                        color: forceColor,
                        outlineColor: Cesium.Color.WHITE,
                        outlineWidth: 1
                    },
                    label: {
                        text: `${getForceName(forceId)}${i + 1}`,
                        font: '10px Arial',
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 1,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        pixelOffset: new Cesium.Cartesian2(0, -20)
                    }
                });
                
                units.push({
                    id: `${forceId}_unit_${i}`,
                    entity: unitEntity,
                    position: unitPosition,
                    group: forceId,
                    centerPosition: centerPosition // æ·»åŠ ä¸­å¿ƒä½ç½®å¼•ç”¨
                });
            }
            
            return units;
        }
        
        // æ ¹æ®å†›é˜Ÿç±»å‹é€‰æ‹©é˜Ÿå½¢
        function selectFormationForForce(forceId, battleId) {
            const battleInfo = battlesDatabase[battleId];
            if (!battleInfo) return null;
            
            const period = battleInfo.period;
            const forceUnits = battleInfo.units[forceId];
            
            // æ ¹æ®å†å²æ—¶æœŸå’Œå…µç§ç±»å‹é€‰æ‹©é˜Ÿå½¢
            if (period === 'ancient') {
                if (forceUnits.includes('hoplite') || forceUnits.includes('legionnaire')) {
                    return 'phalanx'; // æ–¹é˜µ
                } else if (forceUnits.includes('archer')) {
                    return 'volley'; // é½å°„
                }
            } else if (period === 'medieval') {
                if (forceUnits.includes('knight')) {
                    return 'cavalry_wedge'; // éª‘å…µæ¥”å½¢
                } else if (forceUnits.includes('man_at_arms')) {
                    return 'shield_wall'; // ç›¾ç‰Œå¢™
                }
            } else if (period === 'modern') {
                if (forceUnits.includes('line_infantry')) {
                    return 'linear_formation'; // çº¿åˆ—é˜µ
                } else if (forceUnits.includes('cavalry')) {
                    return 'cavalry_wedge'; // éª‘å…µæ¥”å½¢
                }
            }
            
            // é»˜è®¤é˜Ÿå½¢
            return 'linear_formation';
        }
        
        // åˆ›å»ºæˆ˜æ–—æ•ˆæœ
        function createBattleEffect(location) {
            const position = Cesium.Cartesian3.fromDegrees(location[0], location[1], 200);
            
            // çˆ†ç‚¸ç²’å­æ•ˆæœ
            const explosionSystem = new Cesium.ParticleSystem({
                modelMatrix: Cesium.Transforms.eastNorthUpToFixedFrame(position),
                minimumSpeed: 15.0,
                maximumSpeed: 30.0,
                lifetime: 5.0,
                emitter: new Cesium.SphereEmitter(80),
                startScale: 2.0,
                endScale: 1.0,
                startColor: Cesium.Color.WHITE.withAlpha(1.0),
                endColor: Cesium.Color.RED.withAlpha(0.0),
                minimumPixelSize: 30,
                maximumPixelSize: 80,
                image: createExplosionImage()
            });
            
            viewer.scene.primitives.add(explosionSystem);
            
            // 5ç§’åç§»é™¤æ•ˆæœ
            setTimeout(() => {
                viewer.scene.primitives.remove(explosionSystem);
            }, 5000);
        }
        
        // åˆ›å»ºç«ç„°æ•ˆæœ
        function createFireEffect(location) {
            const position = Cesium.Cartesian3.fromDegrees(location[0], location[1], 150);
            
            // ç«ç„°ç²’å­æ•ˆæœ
            const fireSystem = new Cesium.ParticleSystem({
                modelMatrix: Cesium.Transforms.eastNorthUpToFixedFrame(position),
                minimumSpeed: 2.0,
                maximumSpeed: 8.0,
                lifetime: 15.0,
                emitter: new Cesium.ConeEmitter(Cesium.Math.toRadians(30.0)),
                startScale: 1.0,
                endScale: 3.0,
                startColor: Cesium.Color.RED.withAlpha(1.0),
                endColor: Cesium.Color.ORANGE.withAlpha(0.0),
                minimumPixelSize: 20,
                maximumPixelSize: 100,
                image: createFireImage()
            });
            
            viewer.scene.primitives.add(fireSystem);
            
            // 15ç§’åç§»é™¤
            setTimeout(() => {
                viewer.scene.primitives.remove(fireSystem);
            }, 15000);
        }
        
        // åˆ›å»ºæ’¤é€€åŠ¨ç”»
        function createRetreatAnimation(event) {
            console.log("ğŸƒ åˆ›å»ºæ’¤é€€åŠ¨ç”»:", event.description);
            // ç®€åŒ–çš„æ’¤é€€åŠ¨ç”»
            event.participants.forEach(forceId => {
                console.log(`${forceId} å¼€å§‹æ’¤é€€`);
                // å¯ä»¥æ·»åŠ æ’¤é€€çš„è§†è§‰æ•ˆæœ
                createRetreatEffectVisual(forceId, event.location);
            });
        }
        
        // åˆ›å»ºæ”»å‡»åŠ¨ç”»
        function createAssaultAnimation(event) {
            console.log("âš”ï¸ åˆ›å»ºæ”»å‡»åŠ¨ç”»:", event.description);
            // ç®€åŒ–çš„æ”»å‡»åŠ¨ç”»
            event.participants.forEach(forceId => {
                console.log(`${forceId} å‘èµ·æ”»å‡»`);
                // å¯ä»¥æ·»åŠ æ”»å‡»çš„è§†è§‰æ•ˆæœ
                createAssaultEffectVisual(forceId, event.location);
            });
        }
        
        // åˆ›å»ºæ’¤é€€è§†è§‰æ•ˆæœ
        function createRetreatEffectVisual(forceId, location) {
            const position = Cesium.Cartesian3.fromDegrees(location[0], location[1], 100);
            const entity = viewer.entities.add({
                position: position,
                point: {
                    pixelSize: 20,
                    color: Cesium.Color.RED.withAlpha(0.7),
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 2
                },
                label: {
                    text: `${getForceName(forceId)}æ’¤é€€`,
                    font: '14px Arial',
                    fillColor: Cesium.Color.WHITE,
                    outlineColor: Cesium.Color.BLACK,
                    outlineWidth: 2
                }
            });
            
            // 3ç§’åç§»é™¤
            setTimeout(() => {
                viewer.entities.remove(entity);
            }, 3000);
        }
        
        // åˆ›å»ºæ”»å‡»è§†è§‰æ•ˆæœ
        function createAssaultEffectVisual(forceId, location) {
            const position = Cesium.Cartesian3.fromDegrees(location[0], location[1], 150);
            const entity = viewer.entities.add({
                position: position,
                point: {
                    pixelSize: 25,
                    color: Cesium.Color.ORANGE.withAlpha(0.8),
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 3
                },
                label: {
                    text: `${getForceName(forceId)}æ”»å‡»`,
                    font: '14px Arial',
                    fillColor: Cesium.Color.WHITE,
                    outlineColor: Cesium.Color.BLACK,
                    outlineWidth: 2
                }
            });
            
            // 5ç§’åç§»é™¤
            setTimeout(() => {
                viewer.entities.remove(entity);
            }, 5000);
        }
        
        // ç®€åŒ–çš„æ’¤é€€è·¯å¾„ç”Ÿæˆ
        function createRetreatPath(location, forceId) {
            const currentPos = Cesium.Cartesian3.fromDegrees(location[0], location[1]);
            const retreatDistance = 0.01; // çº¦1å…¬é‡Œ
            const randomAngle = Math.random() * Math.PI * 2;
            const retreatX = location[0] + Math.cos(randomAngle) * retreatDistance;
            const retreatY = location[1] + Math.sin(randomAngle) * retreatDistance;
            
            return {
                start: currentPos,
                end: Cesium.Cartesian3.fromDegrees(retreatX, retreatY),
                forceId: forceId
            };
        }
        
        // ç®€åŒ–çš„æ’¤é€€åŠ¨ç”»
        function animateRetreat(path, forceId) {
            console.log(`ğŸƒ ${forceId} æ’¤é€€è·¯å¾„:`, path);
            // å¯ä»¥æ·»åŠ å®é™…çš„ç§»åŠ¨åŠ¨ç”»ï¼Œè¿™é‡Œåªæ˜¯ç®€åŒ–å¤„ç†
        }
        
        // ç®€åŒ–çš„æ”»å‡»æ•ˆæœ
        function createAssaultEffect(forceId, location) {
            console.log(`âš”ï¸ ${forceId} åœ¨ä½ç½® ${location} å‘èµ·æ”»å‡»`);
            // æ”»å‡»æ•ˆæœå·²åœ¨ä¸Šé¢å¤„ç†
        }
        
        // åˆ›å»ºçˆ†ç‚¸å›¾åƒ
        function createExplosionImage() {
            const canvas = document.createElement('canvas');
            canvas.width = 64;
            canvas.height = 64;
            const ctx = canvas.getContext('2d');
            
            const gradient = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
            gradient.addColorStop(0, 'rgba(255, 255, 255, 1.0)');
            gradient.addColorStop(0.3, 'rgba(255, 165, 0, 0.8)');
            gradient.addColorStop(0.6, 'rgba(255, 69, 0, 0.6)');
            gradient.addColorStop(1, 'rgba(255, 0, 0, 0.0)');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(32, 32, 32, 0, Math.PI * 2);
            ctx.fill();
            
            return canvas;
        }
        
        // åˆ›å»ºç«ç„°å›¾åƒ
        function createFireImage() {
            const canvas = document.createElement('canvas');
            canvas.width = 32;
            canvas.height = 32;
            const ctx = canvas.getContext('2d');
            
            const gradient = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
            gradient.addColorStop(0, 'rgba(255, 255, 0, 1.0)');
            gradient.addColorStop(0.5, 'rgba(255, 165, 0, 0.8)');
            gradient.addColorStop(1, 'rgba(255, 0, 0, 0.0)');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(16, 16, 16, 0, Math.PI * 2);
            ctx.fill();
            
            return canvas;
        }
        
        // è·å–å†›é˜Ÿé¢œè‰²
        function getForceColor(forceId) {
            const colors = {
                'cao_cao': Cesium.Color.RED,
                'sun_liu': Cesium.Color.BLUE,
                'persian_empire': Cesium.Color.GOLD,
                'greek_city_states': Cesium.Color.WHITE,
                'anglo_saxons': Cesium.Color.GREEN,
                'normans': Cesium.Color.ORANGE,
                'napoleonic_army': Cesium.Color.RED,
                'coalition_army': Cesium.Color.BLUE,
                'confederate_army': Cesium.Color.GRAY,
                'union_army': Cesium.Color.DODGERBLUE
            };
            return colors[forceId] || Cesium.Color.WHITE;
        }
        
        // è·å–å†›é˜Ÿåç§°
        function getForceName(forceId) {
            if (currentBattleData) {
                const participant = currentBattleData.participants.find(p => p.force_id === forceId);
                return participant ? participant.name : forceId;
            }
            return forceId;
        }
        
        // åˆ›å»ºé˜Ÿå½¢ç²’å­æ•ˆæœ
        function createFormationParticles(position, color) {
            const particleSystem = new Cesium.ParticleSystem({
                modelMatrix: Cesium.Transforms.eastNorthUpToFixedFrame(position),
                minimumSpeed: 0.5,
                maximumSpeed: 2.0,
                lifetime: 3.0,
                emitter: new Cesium.SphereEmitter(30),
                startScale: 0.5,
                endScale: 1.0,
                startColor: color.withAlpha(0.8),
                endColor: color.withAlpha(0.0),
                minimumPixelSize: 10,
                maximumPixelSize: 30,
                image: createParticleImage(color)
            });
            
            viewer.scene.primitives.add(particleSystem);
            
            setTimeout(() => {
                viewer.scene.primitives.remove(particleSystem);
            }, 3000);
        }
        
        // åˆ›å»ºç²’å­å›¾åƒ
        function createParticleImage(color) {
            const canvas = document.createElement('canvas');
            canvas.width = 16;
            canvas.height = 16;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = color.toCssColorString();
            ctx.beginPath();
            ctx.arc(8, 8, 6, 0, Math.PI * 2);
            ctx.fill();
            
            return canvas;
        }
        
        // æ›´æ–°UIçŠ¶æ€
        function updateUI() {
            // æ›´æ–°æ’­æ”¾çŠ¶æ€æ˜¾ç¤º
            if (isPlaying) {
                updateStatus(`æˆ˜å½¹è¿›è¡Œä¸­... (${Math.round(animationTime)}ç§’)`);
            }
        }
        
        // æš‚åœæ’­æ”¾
        function pauseBattle() {
            isPlaying = false;
            viewer.clock.multiplier = 0;
            
            const playBtn = document.getElementById('playBtn');
            playBtn.textContent = 'â–¶ æ’­æ”¾';
            playBtn.classList.remove('playing');
            
            // é€€å‡ºæ’­æ”¾æ¨¡å¼
            exitPlayMode();
            
            updateStatus('å·²æš‚åœ');
        }
        
        // æ¢å¤æ’­æ”¾
        function resumeBattle() {
            isPlaying = true;
            viewer.clock.multiplier = currentSpeed;
            
            const playBtn = document.getElementById('playBtn');
            playBtn.textContent = 'â¸ æ’­æ”¾ä¸­';
            playBtn.classList.add('playing');
            
            // é‡æ–°è¿›å…¥æ’­æ”¾æ¨¡å¼
            enterPlayMode();
            
            updateStatus('ç»§ç»­æ’­æ”¾');
        }
        
        // é‡ç½®æˆ˜å½¹
        function resetBattle() {
            isPlaying = false;
            animationTime = 0;
            processedEvents.clear();
            
            // æ¸…é™¤æ‰€æœ‰å®ä½“
            if (viewer && viewer.entities) {
                viewer.entities.removeAll();
            }
            if (viewer && viewer.scene && viewer.scene.primitives) {
                viewer.scene.primitives.removeAll();
            }
            
            // é‡ç½®æ—¶é—´
            if (viewer && viewer.clock) {
                viewer.clock.currentTime = viewer.clock.startTime.clone();
                viewer.clock.multiplier = 0;
            }
            
            // é€€å‡ºæ’­æ”¾æ¨¡å¼
            exitPlayMode();
            
            const playBtn = document.getElementById('playBtn');
            if (playBtn) {
                playBtn.textContent = 'â–¶ æ’­æ”¾';
                playBtn.classList.remove('playing');
            }
            
            updateStatus('å·²é‡ç½®ï¼Œé€‰æ‹©æˆ˜å½¹å¼€å§‹');
            
            // æ˜¾ç¤ºæˆ˜å½¹é€‰æ‹©å™¨
            const selector = document.getElementById('battleSelector');
            if (selector) {
                selector.style.display = 'block';
                selector.style.visibility = 'visible';
                selector.style.opacity = '1';
            }
        }
        
        // åˆ‡æ¢å€é€Ÿ
        function toggleSpeed() {
            const speeds = [1, 2, 4, 8, 16];
            const currentIndex = speeds.indexOf(currentSpeed);
            const nextIndex = (currentIndex + 1) % speeds.length;
            currentSpeed = speeds[nextIndex];
            
            const speedBtn = document.getElementById('speedBtn');
            speedBtn.textContent = `ğŸš€ ${currentSpeed}x`;
            
            if (isPlaying) {
                viewer.clock.multiplier = currentSpeed;
            }
            
            updateStatus(`æ’­æ”¾é€Ÿåº¦: ${currentSpeed}x`);
        }
        
        // åˆ‡æ¢ç‰¹æ•ˆ
        function toggleEffects() {
            effectsEnabled = !effectsEnabled;
            
            const effectsBtn = document.getElementById('effectsBtn');
            effectsBtn.textContent = effectsEnabled ? 'âœ¨ ç‰¹æ•ˆ' : 'âšª æ— ç‰¹æ•ˆ';
            
            if (effectsEnabled) {
                effectsBtn.style.background = 'linear-gradient(45deg, #10ac84, #00d2d3)';
            } else {
                effectsBtn.style.background = 'linear-gradient(45deg, #888, #666)';
            }
            
            updateStatus(`ç‰¹æ•ˆ: ${effectsEnabled ? 'å¼€å¯' : 'å…³é—­'}`);
        }
        
        // åˆ‡æ¢å¤©æ°”
        function toggleWeather() {
            weatherEnabled = !weatherEnabled;
            
            const weatherBtn = document.getElementById('weatherBtn');
            weatherBtn.textContent = weatherEnabled ? 'ğŸŒ¦ï¸ å¤©æ°”' : 'â˜€ï¸ æ™´å¤©';
            
            updateStatus(`å¤©æ°”æ•ˆæœ: ${weatherEnabled ? 'å¼€å¯' : 'å…³é—­'}`);
        }
        
        // è§‚å¯Ÿæ¨¡å¼åˆ‡æ¢
        function setObservationMode(mode) {
            if (!currentBattleData || !currentBattleData.location) {
                console.warn("æ²¡æœ‰æˆ˜å½¹ä½ç½®æ•°æ®");
                return;
            }
            
            const location = currentBattleData.location;
            
            switch (mode) {
                case 'overview':
                    // å…¨æ™¯æ¨¡å¼ - ä¿¯è§†è§’åº¦
                    viewer.camera.flyTo({
                        destination: Cesium.Cartesian3.fromDegrees(
                            location.lon,
                            location.lat,
                            25000.0
                        ),
                        orientation: {
                            heading: Cesium.Math.toRadians(0),
                            pitch: Cesium.Math.toRadians(-45),
                            roll: 0.0
                        },
                        duration: 2.0
                    });
                    updateStatus('å·²åˆ‡æ¢åˆ°å…¨æ™¯è§‚å¯Ÿæ¨¡å¼');
                    break;
                    
                case 'tactical':
                    // æˆ˜æœ¯æ¨¡å¼ - è¾ƒä½è§’åº¦è§‚å¯Ÿ
                    viewer.camera.flyTo({
                        destination: Cesium.Cartesian3.fromDegrees(
                            location.lon,
                            location.lat,
                            8000.0
                        ),
                        orientation: {
                            heading: Cesium.Math.toRadians(45),
                            pitch: Cesium.Math.toRadians(-30),
                            roll: 0.0
                        },
                        duration: 2.0
                    });
                    updateStatus('å·²åˆ‡æ¢åˆ°æˆ˜æœ¯è§‚å¯Ÿæ¨¡å¼');
                    break;
                    
                case 'aerial':
                    // ç©ºä¸­æ¨¡å¼ - æ¥è¿‘åœ°é¢
                    viewer.camera.flyTo({
                        destination: Cesium.Cartesian3.fromDegrees(
                            location.lon,
                            location.lat,
                            1500.0
                        ),
                        orientation: {
                            heading: Cesium.Math.toRadians(90),
                            pitch: Cesium.Math.toRadians(-15),
                            roll: 0.0
                        },
                        duration: 2.0
                    });
                    updateStatus('å·²åˆ‡æ¢åˆ°ç©ºä¸­è§‚å¯Ÿæ¨¡å¼');
                    break;
                    
                case 'fullscreen':
                    // å…¨å±æ¨¡å¼ - å¡«å……æ•´ä¸ªåŠ¨ç”»çª—å£
                    toggleFullscreen();
                    break;
            }
        }
        
        // äº‹ä»¶ç›‘å¬å™¨è®¾ç½®
        function setupEventListeners() {
            // æˆ˜å½¹é€‰æ‹©å™¨
            document.querySelectorAll('.battle-option').forEach(btn => {
                btn.addEventListener('click', () => {
                    handleBattleSelection(btn.dataset.battle);
                });
            });
            
            // æ’­æ”¾æ§åˆ¶
            document.getElementById('playBtn').addEventListener('click', () => {
                if (isPlaying) {
                    pauseBattle();
                } else {
                    resumeBattle();
                }
            });
            
            document.getElementById('pauseBtn').addEventListener('click', pauseBattle);
            document.getElementById('resetBtn').addEventListener('click', resetBattle);
            document.getElementById('speedBtn').addEventListener('click', toggleSpeed);
            
            // è§‚å¯Ÿæ¨¡å¼
            document.getElementById('overviewBtn').addEventListener('click', () => setObservationMode('overview'));
            document.getElementById('tacticalBtn').addEventListener('click', () => setObservationMode('tactical'));
            document.getElementById('aerialBtn').addEventListener('click', () => setObservationMode('aerial'));
            
            // æ•ˆæœæ§åˆ¶
            document.getElementById('effectsBtn').addEventListener('click', toggleEffects);
            document.getElementById('weatherBtn').addEventListener('click', toggleWeather);
            
            // éŸ³æ•ˆå’Œæ•™å­¦æ§åˆ¶
            document.getElementById('audioBtn').addEventListener('click', toggleAudio);
            document.getElementById('teachingBtn').addEventListener('click', toggleTeachingMode);
            
            // AIèŠå¤©æ§åˆ¶
            document.getElementById('aiChatFloatBtn').addEventListener('click', toggleAIChat);
            document.getElementById('aiChatSendBtn').addEventListener('click', sendChatMessage);
            document.getElementById('aiChatInput').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    sendChatMessage();
                }
            });
            
            // èŠå¤©é¢æ¿åˆ‡æ¢æŒ‰é’®
            document.getElementById('aiToggleBtn').addEventListener('click', toggleAIChat);
        }
        
        // ========== AIèŠå¤©åŠŸèƒ½ ==========
        
        // åˆ‡æ¢AIèŠå¤©ç•Œé¢
        function toggleAIChat() {
            const chatPanel = document.getElementById('aiChatPanel');
            const chatFloatBtn = document.getElementById('aiChatFloatBtn');
            
            if (aiChatVisible) {
                chatPanel.style.display = 'none';
                chatFloatBtn.classList.add('pulse');
                aiChatVisible = false;
                updateStatus("AIåŠ©æ‰‹å·²éšè—");
            } else {
                chatPanel.style.display = 'block';
                chatPanel.classList.add('expanded');
                chatFloatBtn.classList.remove('pulse');
                aiChatVisible = true;
                updateStatus("AIåŠ©æ‰‹å·²å¼€å¯ï¼Œå¯ä»¥å¼€å§‹å¯¹è¯");
                
                // å¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ–AIç³»ç»Ÿ
                if (!aiSystem) {
                    initializeAISystem();
                }
            }
        }
        
        // åˆå§‹åŒ–AIç³»ç»Ÿ
        function initializeAISystem() {
            aiSystem = {
                isInitialized: true,
                apiURL: '/api/v1/llm/military-analysis',
                sendMessage: async function(message) {
                    try {
                        // æ„å»ºå¸¦ä¸Šä¸‹æ–‡çš„æç¤º
                        const battleContext = getBattleContext();
                        const enhancedMessage = buildEnhancedPrompt(battleContext, message);
                        
                        const response = await fetch(this.apiURL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ prompt: enhancedMessage })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            return data.response || "æŠ±æ­‰ï¼ŒAIåŠ©æ‰‹æš‚æ—¶æ— æ³•å›ç­”è¿™ä¸ªé—®é¢˜ã€‚";
                        } else {
                            const errorText = await response.text();
                            throw new Error(`APIé”™è¯¯: ${response.status} - ${errorText}`);
                        }
                    } catch (error) {
                        console.error('AIèŠå¤©é”™è¯¯:', error);
                        return "æŠ±æ­‰ï¼ŒAIåŠ©æ‰‹æš‚æ—¶æ— æ³•å“åº”ï¼Œè¯·ç¨åå†è¯•ã€‚";
                    }
                }
            };
            
            console.log("ğŸ¤– AIèŠå¤©ç³»ç»Ÿå·²åˆå§‹åŒ–");
        }
        
        // è·å–æˆ˜å½¹ä¸Šä¸‹æ–‡
        function getBattleContext() {
            if (!currentBattleData) {
                return "ç”¨æˆ·æ­£åœ¨æŸ¥çœ‹æˆ˜å½¹å¯è§†åŒ–ç³»ç»Ÿï¼Œå½“å‰è¿˜æ²¡æœ‰é€‰æ‹©å…·ä½“çš„æˆ˜å½¹ã€‚";
            }
            
            const battle = currentBattleData;
            let context = `å½“å‰æ­£åœ¨è§‚çœ‹: ${battle.name || 'æœªçŸ¥æˆ˜å½¹'}`;
            
            if (battle.location) {
                context += `ï¼Œåœ°ç‚¹: ç»åº¦${battle.location.lon}, çº¬åº¦${battle.location.lat}`;
            }
            
            if (battle.participants && battle.participants.length > 0) {
                context += "ï¼Œå‚æˆ˜æ–¹: ";
                const participants = battle.participants.map(p => `${p.name}(æŒ‡æŒ¥å®˜: ${p.commander})`);
                context += participants.join("ã€");
            }
            
            if (battle.battle_timeline && battle.battle_timeline.length > 0) {
                const currentEvent = battle.battle_timeline[processedEvents.size] || battle.battle_timeline[0];
                if (currentEvent) {
                    context += `ï¼Œå½“å‰çŠ¶æ€: ${currentEvent.description}`;
                }
            }
            
            return context;
        }
        
        // æ„å»ºå¢å¼ºçš„æç¤ºè¯
        function buildEnhancedPrompt(battleContext, userMessage) {
            let enhancedMessage = userMessage;
            
            // å¦‚æœç”¨æˆ·è¯¢é—®å½“å‰æˆ˜å½¹ç›¸å…³å†…å®¹ï¼Œè‡ªåŠ¨æ·»åŠ ä¸Šä¸‹æ–‡
            const battleKeywords = ['è¿™ä¸ªæˆ˜å½¹', 'è¿™ä¸ªæˆ˜äº‰', 'è¿™åœºæˆ˜æ–—', 'è¿™åœºæˆ˜å½¹', 'ç°åœ¨', 'å½“å‰'];
            const isAskingAboutCurrent = battleKeywords.some(keyword => userMessage.includes(keyword));
            
            if (battleContext !== "ç”¨æˆ·æ­£åœ¨æŸ¥çœ‹æˆ˜å½¹å¯è§†åŒ–ç³»ç»Ÿï¼Œå½“å‰è¿˜æ²¡æœ‰é€‰æ‹©å…·ä½“çš„æˆ˜å½¹ã€‚" && isAskingAboutCurrent) {
                enhancedMessage = `å…³äºå½“å‰æ­£åœ¨è§‚çœ‹çš„æˆ˜å½¹(${battleContext})ï¼Œç”¨æˆ·è¯¢é—®: ${userMessage}`;
            }
            
            return enhancedMessage;
        }
        
        // å‘é€èŠå¤©æ¶ˆæ¯
        async function sendChatMessage() {
            const input = document.getElementById('aiChatInput');
            const message = input.value.trim();
            
            if (!message || !aiSystem) {
                return;
            }
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
            addChatMessage(message, 'user');
            input.value = '';
            
            // æ˜¾ç¤ºAIæ€è€ƒçŠ¶æ€
            const thinkingMessage = addChatMessage('æ­£åœ¨æ€è€ƒä¸­...', 'thinking');
            
            try {
                // è°ƒç”¨ä¸»æ”¯çš„AI API
                const response = await aiSystem.sendMessage(message);
                
                // ç§»é™¤æ€è€ƒçŠ¶æ€
                if (thinkingMessage) {
                    thinkingMessage.remove();
                }
                
                // æ·»åŠ AIå›å¤ï¼ˆæ”¯æŒæ¢è¡Œæ ¼å¼ï¼‰
                addChatMessage(response, 'assistant');
                
                // è®°å½•èŠå¤©å†å²
                chatMessageHistory.push({
                    role: 'user',
                    content: message,
                    timestamp: new Date().toISOString()
                });
                
                chatMessageHistory.push({
                    role: 'assistant',
                    content: response,
                    timestamp: new Date().toISOString()
                });
                
            } catch (error) {
                // ç§»é™¤æ€è€ƒçŠ¶æ€å¹¶æ˜¾ç¤ºé”™è¯¯
                if (thinkingMessage) {
                    thinkingMessage.textContent = 'æŠ±æ­‰ï¼ŒAIåŠ©æ‰‹æš‚æ—¶æ— æ³•å“åº”';
                    thinkingMessage.className = 'ai-message ai-assistant-message';
                }
            }
        }
        
        // æ·»åŠ èŠå¤©æ¶ˆæ¯åˆ°ç•Œé¢
        function addChatMessage(message, type) {
            const messagesContainer = document.getElementById('aiChatMessages');
            const messageDiv = document.createElement('div');
            
            let cssClass = 'ai-message ';
            switch (type) {
                case 'user':
                    cssClass += 'ai-user-message';
                    break;
                case 'assistant':
                    cssClass += 'ai-assistant-message';
                    break;
                case 'thinking':
                    cssClass += 'ai-thinking';
                    break;
                default:
                    cssClass += 'ai-assistant-message';
            }
            
            messageDiv.className = cssClass;
            
            // æ”¯æŒæ¢è¡Œç¬¦å’ŒåŸºæœ¬HTMLæ ¼å¼
            if (type === 'assistant') {
                // AIå›å¤æ”¯æŒæ¢è¡Œ
                messageDiv.innerHTML = message.replace(/\n/g, '<br>');
            } else {
                messageDiv.textContent = message;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageDiv;
        }
        
        // ========== åŸæœ‰çš„éŸ³æ•ˆå’Œæ•™å­¦åŠŸèƒ½ ==========
        
        // åˆ‡æ¢éŸ³æ•ˆ
        function toggleAudio() {
            audioEnabled = !audioEnabled;
            
            const audioBtn = document.getElementById('audioBtn');
            audioBtn.textContent = audioEnabled ? 'ğŸ”Š éŸ³æ•ˆ' : 'ğŸ”‡ é™éŸ³';
            
            if (audioEnabled) {
                audioBtn.style.background = 'linear-gradient(45deg, #10ac84, #00d2d3)';
                initializeAudioSystem();
            } else {
                audioBtn.style.background = 'linear-gradient(45deg, #888, #666)';
                stopAllSounds();
            }
            
            updateStatus(`éŸ³æ•ˆ: ${audioEnabled ? 'å¼€å¯' : 'å…³é—­'}`);
        }
        
        // åˆ‡æ¢æ•™å­¦æ¨¡å¼
        function toggleTeachingMode() {
            teachingModeEnabled = !teachingModeEnabled;
            
            const teachingBtn = document.getElementById('teachingBtn');
            teachingBtn.textContent = teachingModeEnabled ? 'ğŸ“š æ•™å­¦' : 'ğŸ® æ¸¸æˆ';
            
            if (teachingModeEnabled) {
                teachingBtn.style.background = 'linear-gradient(45deg, #10ac84, #00d2d3)';
                enableTeachingMode();
            } else {
                teachingBtn.style.background = 'linear-gradient(45deg, #888, #666)';
                disableTeachingMode();
            }
            
            updateStatus(`æ•™å­¦æ¨¡å¼: ${teachingModeEnabled ? 'å¼€å¯' : 'å…³é—­'}`);
        }
        
        // å…¶ä»–åŠŸèƒ½å‡½æ•°ä¿æŒä¸å˜...
        // åˆå§‹åŒ–éŸ³æ•ˆç³»ç»Ÿã€æ•™å­¦æ¨¡å¼ç­‰å‡½æ•°çš„å®Œæ•´å®ç°...
        function initializeAudioSystem() {
            if (window.AudioSystem) {
                try {
                    audioSystem = new window.AudioSystem();
                    if (typeof audioSystem.initialize === 'function') {
                        audioSystem.initialize().then(() => {
                            console.log("ğŸ”Š éŸ³æ•ˆç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ");
                            playAmbientSound();
                        }).catch(error => {
                            console.error("éŸ³æ•ˆç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:", error);
                        });
                    } else {
                        // å¦‚æœæ²¡æœ‰initializeæ–¹æ³•ï¼Œç›´æ¥æ ‡è®°ä¸ºå·²åˆå§‹åŒ–
                        console.log("ğŸ”Š éŸ³æ•ˆç³»ç»Ÿå·²å‡†å¤‡å°±ç»ª");
                    }
                } catch (error) {
                    console.error("éŸ³æ•ˆç³»ç»Ÿåˆ›å»ºå¤±è´¥:", error);
                }
            } else {
                console.warn("ğŸ”Š éŸ³æ•ˆç³»ç»Ÿæ¨¡å—æœªæ‰¾åˆ°");
            }
        }
        
        function playAmbientSound() {
            if (audioSystem && currentBattleData) {
                try {
                    if (typeof audioSystem.playBattleAmbient === 'function') {
                        audioSystem.playBattleAmbient(currentBattleData.historical_period);
                    } else {
                        console.log("ğŸ”Š æ’­æ”¾ç¯å¢ƒéŸ³æ•ˆ:", currentBattleData.historical_period);
                    }
                } catch (error) {
                    console.error("æ’­æ”¾éŸ³æ•ˆå¤±è´¥:", error);
                }
            }
        }
        
        function stopAllSounds() {
            if (audioSystem) {
                try {
                    if (typeof audioSystem.stopAllSounds === 'function') {
                        audioSystem.stopAllSounds();
                    } else {
                        console.log("ğŸ”Š åœæ­¢æ‰€æœ‰éŸ³æ•ˆ");
                    }
                } catch (error) {
                    console.error("åœæ­¢éŸ³æ•ˆå¤±è´¥:", error);
                }
            }
        }
        
        function enableTeachingMode() {
            if (window.EducationalSystem) {
                showEducationalPanel();
                enableInteractiveTutorials();
            }
        }
        
        function disableTeachingMode() {
            hideEducationalPanel();
            disableInteractiveTutorials();
        }
        
        function showEducationalPanel() {
            const panel = document.getElementById('educationalPanel');
            if (!panel) {
                createEducationalPanel();
            } else {
                panel.style.display = 'block';
            }
        }
        
        function hideEducationalPanel() {
            const panel = document.getElementById('educationalPanel');
            if (panel) {
                panel.style.display = 'none';
            }
        }
        
        function createEducationalPanel() {
            const panel = document.createElement('div');
            panel.id = 'educationalPanel';
            panel.className = 'educational-panel';
            panel.innerHTML = `
                <div class="educational-content">
                    <h3>ğŸ“š æˆ˜æœ¯æ•™å­¦</h3>
                    <div id="tacticalExplanation">ç­‰å¾…æˆ˜å½¹å¼€å§‹...</div>
                    <button class="control-btn" onclick="nextTacticalStep()">ä¸‹ä¸€æ­¥</button>
                </div>
            `;
            document.getElementById('gameContainer').appendChild(panel);
        }
        
        function enableInteractiveTutorials() {
            document.addEventListener('mouseover', highlightRelevantUnits);
            document.addEventListener('click', showUnitDetails);
        }
        
        function disableInteractiveTutorials() {
            document.removeEventListener('mouseover', highlightRelevantUnits);
            document.removeEventListener('click', showUnitDetails);
            clearAllHighlights();
        }
        
        function highlightRelevantUnits(event) {
            if (event.target.classList.contains('unit-item')) {
                const unitName = event.target.querySelector('strong').textContent;
                highlightUnitsByType(unitName);
            }
        }
        
        function showUnitDetails(event) {
            if (event.target.classList.contains('unit-item')) {
                const unitName = event.target.querySelector('strong').textContent;
                showDetailedUnitInfo(unitName);
            }
        }
        
        function highlightUnitsByType(unitName) {
            console.log(`é«˜äº®æ˜¾ç¤º: ${unitName}`);
        }
        
        function showDetailedUnitInfo(unitName) {
            const unitInfo = getUnitInfo(unitName);
            if (unitInfo) {
                showDetailedInfoPanel(unitInfo);
            }
        }
        
        function showDetailedInfoPanel(unitInfo) {
            console.log("æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯:", unitInfo);
        }
        
        function clearAllHighlights() {
            console.log("æ¸…é™¤æ‰€æœ‰é«˜äº®");
        }
        
        function nextTacticalStep() {
            if (currentBattleData && currentBattleData.battle_timeline) {
                const currentEvent = getCurrentTacticalEvent();
                if (currentEvent) {
                    explainTacticalEvent(currentEvent);
                }
            }
        }
        
        function getCurrentTacticalEvent() {
            if (!currentBattleData || !currentBattleData.battle_timeline) return null;
            return currentBattleData.battle_timeline[0];
        }
        
        function explainTacticalEvent(event) {
            const explanation = generateTacticalExplanation(event);
            const panel = document.getElementById('tacticalExplanation');
            if (panel) {
                panel.innerHTML = explanation;
            }
        }
        
        function generateTacticalExplanation(event) {
            const explanations = {
                "deployment": "å†›é˜Ÿéƒ¨ç½²é˜¶æ®µ - æŒ‡æŒ¥å®˜æ ¹æ®åœ°å½¢å’Œæˆ˜æœ¯éœ€è¦å®‰æ’å…µåŠ›éƒ¨ç½²ã€‚",
                "decisive_maneuver": "å†³å®šæ€§è¡ŒåŠ¨ - è¿™æ˜¯æ”¹å˜æˆ˜å±€çš„å…³é”®æ—¶åˆ»ã€‚",
                "retreat": "æ’¤é€€è¡ŒåŠ¨ - å½“å½¢åŠ¿ä¸åˆ©æ—¶ï¼Œæœ‰åºæ’¤é€€ä¿å­˜å®åŠ›ã€‚",
                "assault": "æ”»å‡»è¡ŒåŠ¨ - å‘èµ·ä¸»åŠ¨æ”»å‡»ä»¥è·å–æˆ˜æœ¯ä¼˜åŠ¿ã€‚"
            };
            
            return explanations[event.event_type] || event.description;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', function() {
            console.log("ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...");
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
            
            // åˆå§‹åŒ–ç³»ç»Ÿ
            initializeSystem().catch(error => {
                console.error("åˆå§‹åŒ–å¤±è´¥:", error);
                updateStatus("åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
            });
        });
        
        // é”™è¯¯å¤„ç†
        window.addEventListener('error', function(e) {
            console.error("å…¨å±€é”™è¯¯:", e.error);
            updateStatus(`é”™è¯¯: ${e.message}`);
            
            // é”™è¯¯æ¢å¤æœºåˆ¶
            if (e.message.includes('Cesium')) {
                console.log("å°è¯•æ¢å¤Cesiumç³»ç»Ÿ...");
                setTimeout(() => {
                    if (!viewer || viewer.isDestroyed()) {
                        fallbackInitialization();
                    }
                }, 2000);
            }
        });
        
        // é”®ç›˜å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', function(event) {
            switch(event.code) {
                case 'Space':
                    event.preventDefault();
                    if (isPlaying) {
                        pauseBattle();
                    } else {
                        resumeBattle();
                    }
                    break;
                case 'KeyR':
                    if (event.ctrlKey) {
                        event.preventDefault();
                        resetBattle();
                    }
                    break;
                case 'KeyF':
                    if (event.ctrlKey) {
                        event.preventDefault();
                        toggleFullscreen();
                    }
                    break;
                case 'KeyA':
                    if (event.ctrlKey) {
                        event.preventDefault();
                        toggleAudio();
                    }
                    break;
                case 'KeyT':
                    if (event.ctrlKey) {
                        event.preventDefault();
                        toggleTeachingMode();
                    }
                    break;
                case 'Escape':
                    if (teachingModeEnabled) {
                        toggleTeachingMode();
                    }
                    break;
            }
        });
        
        // å…¨å±åˆ‡æ¢
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.getElementById('gameContainer').requestFullscreen().then(() => {
                    updateStatus("å·²è¿›å…¥å…¨å±æ¨¡å¼");
                });
            } else {
                document.exitFullscreen().then(() => {
                    updateStatus("å·²é€€å‡ºå…¨å±æ¨¡å¼");
                });
            }
        }
        
        // ç½‘ç»œçŠ¶æ€æ£€æµ‹
        function checkNetworkStatus() {
            if (navigator.onLine) {
                console.log("ğŸŒ ç½‘ç»œè¿æ¥æ­£å¸¸");
            } else {
                console.warn("âš ï¸ ç½‘ç»œè¿æ¥æ–­å¼€");
                updateStatus("ç½‘ç»œè¿æ¥æ–­å¼€ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™");
            }
        }
        
        // å®šæœŸæ£€æµ‹ç½‘ç»œçŠ¶æ€
        window.addEventListener('online', checkNetworkStatus);
        window.addEventListener('offline', checkNetworkStatus);
        checkNetworkStatus();
        
        // å†…å­˜æ¸…ç†æœºåˆ¶
        function scheduleMemoryCleanup() {
            setInterval(() => {
                if (performanceMonitor && performanceMonitor.getMemoryUsage && performanceMonitor.getMemoryUsage() > 500) {
                    console.log("ğŸ§¹ æ‰§è¡Œå†…å­˜æ¸…ç†...");
                    // æ¸…ç†æœªä½¿ç”¨çš„ç²’å­æ•ˆæœ
                    if (viewer && viewer.scene && viewer.scene.primitives) {
                        viewer.scene.primitives._primitives = viewer.scene.primitives._primitives.filter(primitive => {
                            return primitive && !primitive.isDestroyed();
                        });
                    }
                    
                    // å¼ºåˆ¶åƒåœ¾å›æ”¶ï¼ˆå¦‚æœæ”¯æŒï¼‰
                    if (window.gc) {
                        window.gc();
                    }
                }
            }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
        }
        
        // å¯åŠ¨å†…å­˜æ¸…ç†
        scheduleMemoryCleanup();
        
        // å¯¼å‡ºå…¨å±€å‡½æ•°ä¾›æ•™å­¦ç³»ç»Ÿä½¿ç”¨
        window.BattleVisualizationSystem = {
            viewer,
            currentBattleData,
            getUnitInfo,
            getTacticDescription,
            getForceName,
            getForceColor,
            setObservationMode,
            toggleTeachingMode,
            toggleAudio,
            showDetailedInfo: showDetailedInfoPanel
        };
        
        console.log("ğŸ® å…¨é¢æˆ˜äº‰é£æ ¼æˆ˜å½¹å¯è§†åŒ–ç³»ç»Ÿå·²å®Œå…¨åŠ è½½å¹¶ä¼˜åŒ–");
    </script>
</body>
</html>
