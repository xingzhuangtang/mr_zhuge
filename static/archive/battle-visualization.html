<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>æˆ˜å½¹å¯è§†åŒ– - {{battleName}}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: #0a0a0a;
            color: white;
            overflow: hidden;
            height: 100vh;
        }
        
        /* ä¸»å®¹å™¨ï¼šä¸Šä¸‹å¸ƒå±€ */
        .main-container {
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* å¯æ‹–æ‹½çª—å£çš„åŸºç¡€æ ·å¼ */
        .resizable-window {
            position: absolute;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(20, 20, 20, 0.95));
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            z-index: 100;
            transition: box-shadow 0.3s ease;
        }
        
        .resizable-window:hover {
            box-shadow: 0 12px 48px rgba(255, 215, 0, 0.2);
            border-color: rgba(255, 215, 0, 0.6);
        }
        
        /* æ‹–æ‹½æ‰‹æŸ„ */
        .window-header {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.1));
            padding: 8px 15px;
            border-radius: 13px 13px 0 0;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .window-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        .window-controls {
            display: flex;
            gap: 8px;
        }
        
        .control-btn-mini {
            width: 20px;
            height: 20px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .minimize-btn {
            background: #f39c12;
            color: white;
        }
        
        .maximize-btn {
            background: #27ae60;
            color: white;
        }
        
        .close-btn {
            background: #e74c3c;
            color: white;
        }
        
        .control-btn-mini:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        /* ç¼©æ”¾æ‰‹æŸ„ */
        .resize-handle {
            position: absolute;
            background: rgba(255, 215, 0, 0.6);
        }
        
        .resize-handle.se {
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            cursor: se-resize;
            border-radius: 0 0 13px 0;
        }
        
        .resize-handle.e {
            bottom: 0;
            right: 0;
            width: 5px;
            height: calc(100% - 20px);
            cursor: e-resize;
            border-radius: 0 0 0 0;
        }
        
        .resize-handle.s {
            bottom: 0;
            right: 20px;
            width: calc(100% - 20px);
            height: 5px;
            cursor: s-resize;
            border-radius: 0 0 0 13px;
        }
        
        /* AIæ–‡å­—è¾“å‡ºçª—å£ - ä¸Šæ–¹ */
        .ai-chat-window {
            top: 20px;
            left: 20px;
            width: 45%;
            height: 60%;
            z-index: 200;
        }
        
        .ai-chat-content {
            padding: 20px;
            height: calc(100% - 40px);
            display: flex;
            flex-direction: column;
        }
        
        .ai-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .ai-message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 12px;
            animation: fadeIn 0.4s ease;
            line-height: 1.6;
        }
        
        .ai-system-message {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.8), rgba(41, 128, 185, 0.8));
            color: white;
            border-left: 4px solid #3498db;
        }
        
        .ai-user-message {
            background: linear-gradient(135deg, rgba(155, 89, 182, 0.8), rgba(142, 68, 173, 0.8));
            color: white;
            margin-left: 20px;
            border-left: 4px solid #9b59b6;
        }
        
        .ai-assistant-message {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.8), rgba(39, 174, 96, 0.8));
            color: white;
            border-left: 4px solid #2ecc71;
        }
        
        .ai-thinking-message {
            background: linear-gradient(135deg, rgba(241, 196, 15, 0.8), rgba(243, 156, 18, 0.8));
            color: #2c3e50;
            border-left: 4px solid #f39c12;
            font-style: italic;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .ai-input-container {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .ai-input-container input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            backdrop-filter: blur(5px);
        }
        
        .ai-input-container input::placeholder {
            color: #aaa;
        }
        
        .ai-input-container input:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }
        
        .ai-send-btn {
            padding: 12px 20px;
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .ai-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.6);
        }
        
        /* æ§åˆ¶é¢æ¿çª—å£ - å³ä¸Š */
        .control-window {
            top: 20px;
            right: 20px;
            width: 25%;
            height: 35%;
            z-index: 150;
        }
        
        .control-content {
            padding: 20px;
            height: calc(100% - 40px);
            overflow-y: auto;
        }
        
        .battle-info {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .battle-name {
            font-size: 1.8em;
            color: #ffd700;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .battle-year {
            color: #87ceeb;
            font-size: 1.1em;
        }
        
        .controls-grid {
            display: grid;
            gap: 12px;
        }
        
        .main-control-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }
        
        .main-control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.5);
        }
        
        .main-control-btn.playing {
            background: linear-gradient(45deg, #10ac84, #00d2d3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .status-display {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .status-item {
            margin: 8px 0;
            font-size: 13px;
        }
        
        .status-label {
            color: #ffd700;
            font-weight: bold;
        }
        
        /* åœ°å›¾çª—å£ - ä¸‹æ–¹ï¼Œå æ®å¤§éƒ¨åˆ†ç©ºé—´ */
        .map-window {
            bottom: 20px;
            left: 20px;
            right: 20px;
            height: 35%;
            z-index: 50;
            min-height: 300px;
        }
        
        .map-content {
            height: calc(100% - 40px);
            border-radius: 0 0 13px 13px;
            overflow: hidden;
        }
        
        #cesiumContainer {
            width: 100%;
            height: 100%;
        }
        
        /* è½½å…¥ç”»é¢ */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            border-radius: 13px;
        }
        
        .loading-content {
            text-align: center;
            color: #ffd700;
        }
        
        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 6px solid rgba(255, 215, 0, 0.2);
            border-top: 6px solid #ffd700;
            border-radius: 50%;
            animation: spin 1.2s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* é”™è¯¯æç¤º */
        .error-message {
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
            color: #e74c3c;
            padding: 20px;
            border-radius: 12px;
            margin: 20px;
            text-align: center;
            font-size: 14px;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 1200px) {
            .ai-chat-window {
                width: 50%;
                height: 55%;
            }
            
            .control-window {
                width: 30%;
                height: 40%;
            }
        }
        
        @media (max-width: 768px) {
            .ai-chat-window,
            .control-window {
                width: 90%;
                height: 40%;
                left: 5%;
                right: 5%;
            }
            
            .ai-chat-window {
                top: 10px;
            }
            
            .control-window {
                top: calc(45% + 20px);
            }
            
            .map-window {
                height: 45%;
                bottom: 10px;
                left: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- AIæ–‡å­—è¾“å‡ºçª—å£ -->
        <div class="resizable-window ai-chat-window" id="aiChatWindow">
            <div class="window-header">
                <span class="window-title">ğŸ¤– æˆ˜å½¹AIåŠ©æ‰‹</span>
                <div class="window-controls">
                    <button class="control-btn-mini minimize-btn" onclick="minimizeWindow('aiChatWindow')">âˆ’</button>
                    <button class="control-btn-mini maximize-btn" onclick="maximizeWindow('aiChatWindow')">â–¡</button>
                    <button class="control-btn-mini close-btn" onclick="hideWindow('aiChatWindow')">Ã—</button>
                </div>
            </div>
            <div class="ai-chat-content">
                <div class="ai-messages" id="aiMessages">
                    <div class="ai-message ai-system-message">
                        ğŸ® æ¬¢è¿æ¥åˆ°æˆ˜å½¹å¯è§†åŒ–ç³»ç»Ÿï¼<br><br>
                        æˆ‘æ˜¯æ‚¨çš„ä¸“ä¸šå†›äº‹å†å²AIé¡¾é—®ï¼Œæ­£åœ¨ä¸ºæ‚¨è¯¦ç»†è®²è§£è¿™åœºè‘—åæˆ˜å½¹ã€‚<br><br>
                        ğŸ’¡ <strong>ç³»ç»Ÿç‰¹ç‚¹ï¼š</strong><br>
                        â€¢ å®æ—¶åˆ†ææˆ˜å½¹æˆ˜æœ¯å’Œæˆ˜ç•¥<br>
                        â€¢ è§£ç­”å†›äº‹å†å²é—®é¢˜<br>
                        â€¢ äº’åŠ¨å¼å­¦ä¹ ä½“éªŒ<br><br>
                        è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œæˆ‘å°†ä¸ºæ‚¨æä¾›ä¸“ä¸šçš„å†›äº‹å†å²åˆ†æï¼
                    </div>
                </div>
                <div class="ai-input-container">
                    <input type="text" id="aiInput" placeholder="è¯¢é—®å…³äºè¿™åœºæˆ˜å½¹çš„é—®é¢˜..." autocomplete="off" />
                    <button class="ai-send-btn" onclick="sendAIMessage()">å‘é€</button>
                </div>
            </div>
            <div class="resize-handle se"></div>
            <div class="resize-handle e"></div>
            <div class="resize-handle s"></div>
        </div>
        
        <!-- æ§åˆ¶é¢æ¿çª—å£ -->
        <div class="resizable-window control-window" id="controlWindow">
            <div class="window-header">
                <span class="window-title">ğŸ® æ’­æ”¾æ§åˆ¶</span>
                <div class="window-controls">
                    <button class="control-btn-mini minimize-btn" onclick="minimizeWindow('controlWindow')">âˆ’</button>
                    <button class="control-btn-mini maximize-btn" onclick="maximizeWindow('controlWindow')">â–¡</button>
                    <button class="control-btn-mini close-btn" onclick="hideWindow('controlWindow')">Ã—</button>
                </div>
            </div>
            <div class="control-content">
                <div class="battle-info">
                    <div class="battle-name" id="battleName">æˆ˜å½¹å¯è§†åŒ–</div>
                    <div class="battle-year" id="battleYear">æ­£åœ¨åŠ è½½...</div>
                </div>
                
                <div class="controls-grid">
                    <button class="main-control-btn" id="playBtn" onclick="togglePlay()">â–¶ å¼€å§‹æ’­æ”¾</button>
                    <button class="main-control-btn" onclick="resetBattle()">â†º é‡ç½®</button>
                    <button class="main-control-btn" onclick="setCameraView('overview')">ğŸ“‹ å…¨æ™¯è§‚å¯Ÿ</button>
                    <button class="main-control-btn" onclick="setCameraView('tactical')">âš”ï¸ æˆ˜æœ¯è§†è§’</button>
                    <button class="main-control-btn" onclick="setCameraView('aerial')">âœˆï¸ ç©ºä¸­ä¿¯è§†</button>
                </div>
                
                <div class="status-display">
                    <div class="status-item">
                        <span class="status-label">æ’­æ”¾çŠ¶æ€:</span>
                        <span id="playStatus">æœªå¼€å§‹</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">å½“å‰äº‹ä»¶:</span>
                        <span id="currentEvent">ç­‰å¾…å¼€å§‹</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">åœ°å›¾åŠ è½½:</span>
                        <span id="mapStatus">åŠ è½½ä¸­...</span>
                    </div>
                </div>
            </div>
            <div class="resize-handle se"></div>
            <div class="resize-handle e"></div>
            <div class="resize-handle s"></div>
        </div>
        
        <!-- åœ°å›¾çª—å£ - å æ®ä¸‹æ–¹å¤§éƒ¨åˆ†ç©ºé—´ -->
        <div class="resizable-window map-window" id="mapWindow">
            <div class="window-header">
                <span class="window-title">ğŸ—ºï¸ 3Dæˆ˜å½¹åœ°å›¾</span>
                <div class="window-controls">
                    <button class="control-btn-mini minimize-btn" onclick="minimizeWindow('mapWindow')">âˆ’</button>
                    <button class="control-btn-mini maximize-btn" onclick="maximizeWindow('mapWindow')">â–¡</button>
                    <button class="control-btn-mini close-btn" onclick="hideWindow('mapWindow')">Ã—</button>
                </div>
            </div>
            <div class="map-content">
                <div id="cesiumContainer"></div>
                
                <!-- è½½å…¥ç”»é¢ -->
                <div class="loading-overlay" id="loadingOverlay">
                    <div class="loading-content">
                        <div class="loading-spinner"></div>
                        <div style="font-size: 18px; margin-top: 15px;">æ­£åœ¨åŠ è½½æˆ˜å½¹åœ°å›¾...</div>
                        <div style="font-size: 14px; color: #87ceeb; margin-top: 10px;">è¯·ç¨å€™ï¼Œå³å°†ä¸ºæ‚¨å‘ˆç°éœ‡æ’¼çš„3Dæˆ˜å½¹é‡ç°</div>
                    </div>
                </div>
            </div>
            <div class="resize-handle se"></div>
            <div class="resize-handle e"></div>
            <div class="resize-handle s"></div>
        </div>
    </div>

    <!-- åŠ è½½Cesiumåº“ -->
    <script src="cesium/Cesium.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let viewer;
        let isPlaying = false;
        let currentBattleData = null;
        let animationTime = 0;
        let processedEvents = new Set();
        let aiSystem = null;
        let windowPositions = {};
        let windowSizes = {};
        
        // æˆ˜å½¹æ•°æ®
        const battlesDatabase = {
            'chibi_208': {
                name: 'èµ¤å£ä¹‹æˆ˜',
                year: 208,
                period: 'ancient',
                location: { lat: 29.7, lon: 113.9 },
                description: '208å¹´å†¬ï¼Œå­™æƒã€åˆ˜å¤‡è”å†›åœ¨é•¿æ±Ÿèµ¤å£åœ°åŒºå¤§è´¥æ›¹æ“ï¼Œå¥ å®šäº†ä¸‰å›½é¼ç«‹çš„åŸºç¡€ã€‚è¿™æ˜¯ä¸­å›½å¤ä»£æœ€è‘—åçš„æ°´æˆ˜ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯ç«æ”»æˆ˜æœ¯çš„ç»å…¸èŒƒä¾‹ã€‚',
                participants: [
                    { name: 'æ›¹æ“å†›', commander: 'æ›¹æ“', color: '#ff4444' },
                    { name: 'å­™åˆ˜è”å†›', commander: 'å‘¨ç‘œã€åˆ˜å¤‡', color: '#4444ff' }
                ],
                events: [
                    { time: 5, description: 'æ›¹æ“å†›é˜Ÿé›†ç»“äºé•¿æ±ŸåŒ—å²¸ï¼Œå‡†å¤‡æ¸¡æ±Ÿä½œæˆ˜', type: 'deployment' },
                    { time: 15, description: 'ä¸œå—é£èµ·ï¼Œå­™åˆ˜è”å†›å‘èµ·ç«æ”»ï¼Œç«çƒ§æ›¹æ“è¿ç¯èˆ¹', type: 'fire_attack' },
                    { time: 25, description: 'æ›¹æ“å¤§è´¥ï¼Œå¼€å§‹å…¨é¢æ’¤é€€ï¼Œå¥ å®šäº†ä¸‰å›½é¼ç«‹çš„åŸºç¡€', type: 'retreat' }
                ]
            },
            'marathon_490bc': {
                name: 'é©¬æ‹‰æ¾æˆ˜å½¹',
                year: -490,
                period: 'ancient',
                location: { lat: 38.1, lon: 23.9 },
                description: 'å‰490å¹´ï¼Œå¸Œè…ŠåŸé‚¦è”å†›åœ¨é©¬æ‹‰æ¾å¹³åŸå‡»è´¥æ³¢æ–¯å…¥ä¾µå†›ï¼Œæ ‡å¿—ç€å¸Œè…Šæ–‡æ˜çš„èƒœåˆ©ã€‚è¿™ä¸€æˆ˜ç¡®ç«‹äº†é‡è£…æ­¥å…µæ–¹é˜µçš„æˆ˜æœ¯ä¼˜åŠ¿ã€‚',
                participants: [
                    { name: 'æ³¢æ–¯å†›', commander: 'è¾¾ææ–¯', color: '#ffaa44' },
                    { name: 'å¸Œè…Šè”å†›', commander: 'ç±³å¤ªäºšå¾·', color: '#44aaff' }
                ],
                events: [
                    { time: 5, description: 'æ³¢æ–¯å†›é˜Ÿç™»é™†é©¬æ‹‰æ¾å¹³åŸï¼Œåˆ—é˜µå‡†å¤‡', type: 'deployment' },
                    { time: 15, description: 'å¸Œè…Šé‡è£…æ­¥å…µå‘èµ·å†²é”‹ï¼Œæ³¢æ–¯å¼“ç®­æ‰‹æºƒè´¥', type: 'assault' },
                    { time: 25, description: 'æ³¢æ–¯å†›å¤§è´¥ï¼Œå¸Œè…Šè·å¾—å†³å®šæ€§èƒœåˆ©', type: 'victory' }
                ]
            },
            'hastings_1066': {
                name: 'é»‘æ–¯å»·æ–¯æˆ˜å½¹',
                year: 1066,
                period: 'medieval',
                location: { lat: 50.9, lon: 0.5 },
                description: '1066å¹´10æœˆ14æ—¥ï¼Œè¯ºæ›¼åº•å…¬çˆµå¨å»‰å‡»è´¥è‹±æ ¼å…°å›½ç‹å“ˆç½—å¾·äºŒä¸–ï¼Œå¾æœè‹±æ ¼å…°ã€‚è¿™ä¸€æˆ˜æ”¹å˜äº†è‹±å›½çš„å†å²è¿›ç¨‹ã€‚',
                participants: [
                    { name: 'ç›æ ¼é²-æ’’å…‹é€Šå†›', commander: 'å“ˆç½—å¾·äºŒä¸–', color: '#44ff44' },
                    { name: 'è¯ºæ›¼å†›', commander: 'å¨å»‰å¾æœè€…', color: '#ff8844' }
                ],
                events: [
                    { time: 5, description: 'ä¸¤å†›åœ¨é»‘æ–¯å»·æ–¯ç›¸é‡ï¼Œåˆ†åˆ«åˆ—é˜µå‡†å¤‡å†³æˆ˜', type: 'deployment' },
                    { time: 15, description: 'è¯ºæ›¼éª‘å…µå‘èµ·å†²é”‹ï¼Œå†²å‡»ç›æ ¼é²-æ’’å…‹é€Šç›¾ç‰Œé˜²çº¿', type: 'cavalry_charge' },
                    { time: 25, description: 'å“ˆç½—å¾·æˆ˜æ­»ï¼Œè‹±æ ¼å…°æŠ•é™ï¼Œè¯ºæ›¼å¾æœå¼€å§‹', type: 'victory' }
                ]
            },
            'waterloo_1815': {
                name: 'æ»‘é“å¢æˆ˜å½¹',
                year: 1815,
                period: 'modern',
                location: { lat: 50.68, lon: 4.41 },
                description: '1815å¹´6æœˆ18æ—¥ï¼Œå¨çµé¡¿å…¬çˆµä¸å¸ƒå•æ­‡å°”å°†å†›åœ¨æ»‘é“å¢å‡»è´¥æ‹¿ç ´ä»‘ï¼Œç»“æŸäº†æ‹¿ç ´ä»‘æ—¶ä»£ã€‚è¿™æ˜¯è¿‘ä»£å†›äº‹å²ä¸Šæœ€è‘—åçš„å†³æˆ˜ã€‚',
                participants: [
                    { name: 'æ‹¿ç ´ä»‘å¸å›½å†›', commander: 'æ‹¿ç ´ä»‘ä¸€ä¸–', color: '#ff4444' },
                    { name: 'åæ³•åŒç›Ÿå†›', commander: 'å¨çµé¡¿å…¬çˆµ', color: '#4444ff' }
                ],
                events: [
                    { time: 5, description: 'æ‹¿ç ´ä»‘å‡†å¤‡å‘åŠ¨æœ€åè¿›æ”»ï¼Œéƒ¨ç½²å¤§ç‚®é˜µåœ°', type: 'deployment' },
                    { time: 15, description: 'æ³•å†›æ­¥å…µå‘èµ·çŒ›æ”»ï¼Œåæ³•åŒç›Ÿå†›åšå®ˆé˜µåœ°', type: 'artillery_barrage' },
                    { time: 25, description: 'æ™®é²å£«æ´å†›åˆ°è¾¾ï¼Œæ‹¿ç ´ä»‘æœ€ç»ˆè´¥åŒ—', type: 'defeat' }
                ]
            },
            'gettysburg_1863': {
                name: 'è‘›åº•æ–¯å ¡æˆ˜å½¹',
                year: 1863,
                period: 'modern',
                location: { lat: 39.8, lon: -77.2 },
                description: '1863å¹´7æœˆ1-3æ—¥ï¼Œè‘›åº•æ–¯å ¡æˆ˜å½¹æ˜¯ç¾å›½å†…æˆ˜çš„è½¬æŠ˜ç‚¹ã€‚è”é‚¦å†›å‡»è´¥å—æ–¹å†›ï¼Œé˜»æ­¢äº†å—æ–¹ç‹¬ç«‹çš„ä¼å›¾ã€‚',
                participants: [
                    { name: 'å—æ–¹å†›', commander: 'ç½—ä¼¯ç‰¹Â·æ', color: '#ff8844' },
                    { name: 'è”é‚¦å†›', commander: 'ä¹”æ²»Â·ç±³å¾·', color: '#4488ff' }
                ],
                events: [
                    { time: 5, description: 'ä¸¤å†›åœ¨è‘›åº•æ–¯å ¡é­é‡ï¼Œäº‰å¤ºæˆ˜ç•¥é«˜åœ°', type: 'deployment' },
                    { time: 15, description: 'å—æ–¹å†›å‘èµ·æ”»å‡»ï¼Œå†²å‡»è”é‚¦å†›é˜²çº¿', type: 'assault' },
                    { time: 25, description: 'è”é‚¦å†›å®ˆä½é˜²çº¿ï¼Œå—æ–¹å†›æ’¤é€€ï¼ŒåŒ—æ–¹è·å¾—èƒœåˆ©', type: 'victory' }
                ]
            }
        };

        // åˆå§‹åŒ–ç³»ç»Ÿ
        async function initializeSystem() {
            try {
                console.log('ğŸš€ åˆå§‹åŒ–æˆ˜å½¹å¯è§†åŒ–ç³»ç»Ÿ...');
                
                // è·å–æˆ˜å½¹å‚æ•°
                const urlParams = new URLSearchParams(window.location.search);
                const battleId = urlParams.get('id');
                const battleName = urlParams.get('battle');
                
                if (!battleId || !battlesDatabase[battleId]) {
                    showError('æœªæ‰¾åˆ°æŒ‡å®šçš„æˆ˜å½¹æ•°æ®');
                    return;
                }
                
                // è®¾ç½®å½“å‰æˆ˜å½¹
                currentBattleData = battlesDatabase[battleId];
                
                // æ›´æ–°æˆ˜å½¹ä¿¡æ¯
                updateBattleInfo();
                
                // åˆå§‹åŒ–AIç³»ç»Ÿï¼ˆç«‹å³å¯åŠ¨ï¼‰
                initializeAI();
                
                // åˆå§‹åŒ–åœ°å›¾
                await initializeMap();
                
                // éšè—è½½å…¥ç”»é¢
                hideLoading();
                
                // å‘é€æ¬¢è¿æ¶ˆæ¯ç»™AI
                setTimeout(() => {
                    sendWelcomeMessage();
                }, 2000);
                
                console.log('âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼ŒAIå·²å¯åŠ¨');
                
            } catch (error) {
                console.error('âŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
                showError('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }
        
        // æ›´æ–°æˆ˜å½¹ä¿¡æ¯
        function updateBattleInfo() {
            document.getElementById('battleName').textContent = currentBattleData.name;
            document.getElementById('battleYear').textContent =
                `${currentBattleData.year > 0 ? currentBattleData.year : 'å‰' + Math.abs(currentBattleData.year)}å¹´`;
        }
        
        // åˆå§‹åŒ–åœ°å›¾
        async function initializeMap() {
            return new Promise((resolve, reject) => {
                try {
                    // ä½¿ç”¨å¯é çš„åœ°å›¾æº
                    viewer = new Cesium.Viewer('cesiumContainer', {
                        terrainProvider: new Cesium.EllipsoidTerrainProvider(),
                        imageryProvider: new Cesium.OpenStreetMapImageryProvider({
                            url: 'https://tile.openstreetmap.org/'
                        }),
                        shouldAnimate: true,
                        animation: false,
                        timeline: false,
                        baseLayerPicker: false,
                        geocoder: false,
                        homeButton: false,
                        sceneModePicker: false,
                        navigationHelpButton: false,
                        infoBox: false,
                        selectionIndicator: false,
                        scene3DOnly: true,
                        requestRenderMode: false,
                        maximumRenderTimeChange: Infinity
                    });
                    
                    // ä¼˜åŒ–è®¾ç½®
                    viewer.scene.highDynamicRange = false;
                    viewer.scene.globe.enableLighting = false;
                    viewer.scene.skyAtmosphere.show = false;
                    viewer.scene.globe.showGroundAtmosphere = false;
                    
                    // é£è½¬åˆ°æˆ˜å½¹ä½ç½®
                    const destination = Cesium.Cartesian3.fromDegrees(
                        currentBattleData.location.lon,
                        currentBattleData.location.lat,
                        20000.0 // å¢åŠ é«˜åº¦ï¼Œè·å¾—æ›´å¥½çš„è§†é‡
                    );
                    
                    viewer.camera.flyTo({
                        destination: destination,
                        duration: 4.0,
                        complete: function() {
                            console.log('ğŸ“ å·²åˆ°è¾¾æˆ˜å½¹ä½ç½®');
                            document.getElementById('mapStatus').textContent = 'åŠ è½½æˆåŠŸ';
                            resolve();
                        }
                    });
                    
                } catch (error) {
                    console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
                    document.getElementById('mapStatus').textContent = 'åŠ è½½å¤±è´¥';
                    reject(error);
                }
            });
        }
        
        // AIç³»ç»Ÿåˆå§‹åŒ–
        function initializeAI() {
            aiSystem = {
                sendMessage: async function(message) {
                    try {
                        const response = await fetch('/api/v1/llm/military-analysis', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                prompt: buildBattleContext(message)
                            })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            return data.response || 'æŠ±æ­‰ï¼ŒAIåŠ©æ‰‹æš‚æ—¶æ— æ³•å›ç­”è¿™ä¸ªé—®é¢˜ã€‚';
                        } else {
                            throw new Error(`APIé”™è¯¯: ${response.status}`);
                        }
                    } catch (error) {
                        console.error('AIèŠå¤©é”™è¯¯:', error);
                        return 'æŠ±æ­‰ï¼ŒAIåŠ©æ‰‹æš‚æ—¶æ— æ³•å“åº”ï¼Œè¯·ç¨åå†è¯•ã€‚';
                    }
                }
            };
        }
        
        // å‘é€æ¬¢è¿æ¶ˆæ¯
        function sendWelcomeMessage() {
            const welcomeMessage = `
ğŸ¯ <strong>${currentBattleData.name} - æˆ˜å½¹åˆ†æ</strong><br><br>
ğŸ“… <strong>å†å²èƒŒæ™¯ï¼š</strong>${currentBattleData.description}<br><br>
âš”ï¸ <strong>å‚æˆ˜åŒæ–¹ï¼š</strong><br>
${currentBattleData.participants.map(p => `â€¢ ${p.name} (æŒ‡æŒ¥å®˜: ${p.commander})`).join('<br>')}<br><br>
ğŸ¬ <strong>æˆ˜å½¹è¿‡ç¨‹ï¼š</strong><br>
${currentBattleData.events.map(e => `â€¢ ç¬¬${e.time}ç§’: ${e.description}`).join('<br>')}<br><br>
ğŸ’¡ å»ºè®®æ‚¨ç°åœ¨ç‚¹å‡»"å¼€å§‹æ’­æ”¾"è§‚çœ‹3Dé‡ç°ï¼Œç„¶åå¯ä»¥é—®æˆ‘å…³äºè¿™åœºæˆ˜å½¹çš„ä»»ä½•é—®é¢˜ï¼
            `;
            addAIMessage(welcomeMessage, 'assistant');
        }
        
        // æ„å»ºAIä¸Šä¸‹æ–‡
        function buildBattleContext(message) {
            let context = `å…³äº${currentBattleData.name}`;
            if (message.includes('è¿™åœºæˆ˜å½¹') || message.includes('è¿™ä¸ªæˆ˜å½¹') || message.includes('å½“å‰')) {
                context = `ç”¨æˆ·æ­£åœ¨è§‚çœ‹${currentBattleData.name}çš„å¯è§†åŒ–ï¼Œè¯¢é—®: ${message}`;
            }
            return context;
        }
        
        // å‘é€AIæ¶ˆæ¯
        async function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const message = input.value.trim();
            
            if (!message || !aiSystem) return;
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addAIMessage(message, 'user');
            input.value = '';
            
            // æ˜¾ç¤ºAIæ€è€ƒçŠ¶æ€
            const thinkingMessage = addAIMessage('ğŸ¤” æ­£åœ¨æ·±å…¥åˆ†æè¿™ä¸ªé—®é¢˜...', 'thinking');
            
            try {
                const response = await aiSystem.sendMessage(message);
                thinkingMessage.remove();
                addAIMessage(response, 'assistant');
            } catch (error) {
                thinkingMessage.textContent = 'âŒ æŠ±æ­‰ï¼ŒAIåŠ©æ‰‹æš‚æ—¶æ— æ³•å“åº”ï¼Œè¯·ç¨åå†è¯•ã€‚';
                thinkingMessage.className = 'ai-message ai-assistant-message';
            }
        }
        
        // æ·»åŠ AIæ¶ˆæ¯
        function addAIMessage(content, type) {
            const messagesContainer = document.getElementById('aiMessages');
            const messageDiv = document.createElement('div');
            
            let cssClass = 'ai-message ';
            switch (type) {
                case 'user':
                    cssClass += 'ai-user-message';
                    break;
                case 'thinking':
                    cssClass += 'ai-thinking-message';
                    break;
                case 'system':
                    cssClass += 'ai-system-message';
                    break;
                default:
                    cssClass += 'ai-assistant-message';
            }
            
            messageDiv.className = cssClass;
            messageDiv.innerHTML = content;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageDiv;
        }
        
        // æ’­æ”¾æ§åˆ¶å‡½æ•°ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰
        function togglePlay() {
            const playBtn = document.getElementById('playBtn');
            
            if (!isPlaying) {
                startBattle();
            } else {
                pauseBattle();
            }
        }
        
        function startBattle() {
            isPlaying = true;
            animationTime = 0;
            processedEvents.clear();
            
            document.getElementById('playBtn').textContent = 'â¸ æš‚åœ';
            document.getElementById('playBtn').classList.add('playing');
            document.getElementById('playStatus').textContent = 'æ’­æ”¾ä¸­';
            
            startAnimationLoop();
            console.log('ğŸ¬ å¼€å§‹æˆ˜å½¹æ’­æ”¾');
        }
        
        function pauseBattle() {
            isPlaying = false;
            
            document.getElementById('playBtn').textContent = 'â–¶ ç»§ç»­';
            document.getElementById('playBtn').classList.remove('playing');
            document.getElementById('playStatus').textContent = 'å·²æš‚åœ';
            
            console.log('â¸ æš‚åœæˆ˜å½¹æ’­æ”¾');
        }
        
        function resetBattle() {
            isPlaying = false;
            animationTime = 0;
            processedEvents.clear();
            
            if (viewer) {
                viewer.entities.removeAll();
            }
            
            document.getElementById('playBtn').textContent = 'â–¶ å¼€å§‹æ’­æ”¾';
            document.getElementById('playBtn').classList.remove('playing');
            document.getElementById('playStatus').textContent = 'æœªå¼€å§‹';
            document.getElementById('currentEvent').textContent = 'ç­‰å¾…å¼€å§‹';
            
            console.log('â†º æˆ˜å½¹å·²é‡ç½®');
        }
        
        function startAnimationLoop() {
            const animationInterval = setInterval(() => {
                if (!isPlaying) {
                    clearInterval(animationInterval);
                    return;
                }
                
                animationTime += 1;
                processBattleEvents();
                
                if (animationTime > 60) {
                    pauseBattle();
                    document.getElementById('currentEvent').textContent = 'æ’­æ”¾å®Œæˆ';
                }
            }, 1000);
        }
        
        function processBattleEvents() {
            currentBattleData.events.forEach((event, index) => {
                const eventId = `event_${index}`;
                
                if (!processedEvents.has(eventId) && animationTime >= event.time) {
                    console.log(`âš¡ è§¦å‘äº‹ä»¶: ${event.description}`);
                    
                    triggerEvent(event);
                    processedEvents.add(eventId);
                    document.getElementById('currentEvent').textContent = event.description;
                    
                    // AIè‡ªåŠ¨è§£è¯»å½“å‰äº‹ä»¶
                    addAIMessage(`<strong>ğŸ¯ å½“å‰äº‹ä»¶:</strong> ${event.description}`, 'system');
                }
            });
        }
        
        function triggerEvent(event) {
            createBattleEffect(event);
        }
        
        function createBattleEffect(event) {
            const position = Cesium.Cartesian3.fromDegrees(
                currentBattleData.location.lon,
                currentBattleData.location.lat,
                200
            );
            
            switch (event.type) {
                case 'deployment':
                    createDeploymentEffect(position);
                    break;
                case 'assault':
                case 'cavalry_charge':
                    createAssaultEffect(position);
                    break;
                case 'fire_attack':
                    createFireEffect(position);
                    break;
                case 'victory':
                case 'defeat':
                    createVictoryEffect(position);
                    break;
                default:
                    createGeneralEffect(position);
            }
        }
        
        function createDeploymentEffect(position) {
            currentBattleData.participants.forEach((participant, index) => {
                const offset = (index - 0.5) * 0.005;
                const unitPosition = Cesium.Cartesian3.fromDegrees(
                    currentBattleData.location.lon + offset,
                    currentBattleData.location.lat,
                    100
                );
                
                const entity = viewer.entities.add({
                    position: unitPosition,
                    point: {
                        pixelSize: 25,
                        color: Cesium.Color.fromCssColorString(participant.color),
                        outlineColor: Cesium.Color.WHITE,
                        outlineWidth: 3
                    },
                    label: {
                        text: participant.name,
                        font: '18px Arial Black',
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 3,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE
                    }
                });
            });
        }
        
        function createAssaultEffect(position) {
            const explosionEntity = viewer.entities.add({
                position: position,
                point: {
                    pixelSize: 35,
                    color: Cesium.Color.ORANGE,
                    outlineColor: Cesium.Color.RED,
                    outlineWidth: 4
                },
                label: {
                    text: 'âš”ï¸ æ”»å‡»ï¼',
                    font: '20px Arial Black',
                    fillColor: Cesium.Color.RED,
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 3
                }
            });
            
            setTimeout(() => {
                viewer.entities.remove(explosionEntity);
            }, 6000);
        }
        
        function createFireEffect(position) {
            const fireEntity = viewer.entities.add({
                position: position,
                point: {
                    pixelSize: 30,
                    color: Cesium.Color.RED.withAlpha(0.8),
                    outlineColor: Cesium.Color.ORANGE,
                    outlineWidth: 3
                },
                label: {
                    text: 'ğŸ”¥ ç«æ”»ï¼',
                    font: '20px Arial Black',
                    fillColor: Cesium.Color.ORANGE,
                    outlineColor: Cesium.Color.RED,
                    outlineWidth: 3
                }
            });
            
            setTimeout(() => {
                viewer.entities.remove(fireEntity);
            }, 10000);
        }
        
        function createVictoryEffect(position) {
            const victoryEntity = viewer.entities.add({
                position: position,
                point: {
                    pixelSize: 45,
                    color: Cesium.Color.GOLD,
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 5
                },
                label: {
                    text: 'ğŸ† èƒœåˆ©ï¼',
                    font: '22px Arial Black',
                    fillColor: Cesium.Color.GOLD,
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 4
                }
            });
            
            setTimeout(() => {
                viewer.entities.remove(victoryEntity);
            }, 12000);
        }
        
        function createGeneralEffect(position) {
            const entity = viewer.entities.add({
                position: position,
                point: {
                    pixelSize: 20,
                    color: Cesium.Color.YELLOW,
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 2
                }
            });
            
            setTimeout(() => {
                viewer.entities.remove(entity);
            }, 4000);
        }
        
        function setCameraView(mode) {
            if (!currentBattleData) return;
            
            const location = currentBattleData.location;
            
            switch (mode) {
                case 'overview':
                    viewer.camera.flyTo({
                        destination: Cesium.Cartesian3.fromDegrees(location.lon, location.lat, 30000),
                        duration: 2.0
                    });
                    break;
                case 'tactical':
                    viewer.camera.flyTo({
                        destination: Cesium.Cartesian3.fromDegrees(location.lon, location.lat, 10000),
                        duration: 2.0
                    });
                    break;
                case 'aerial':
                    viewer.camera.flyTo({
                        destination: Cesium.Cartesian3.fromDegrees(location.lon, location.lat, 3000),
                        duration: 2.0
                    });
                    break;
            }
        }
        
        function showError(message) {
            // é”™è¯¯æ˜¾ç¤ºåœ¨åœ°å›¾çª—å£ä¸­
            const errorHtml = `
                <div class="error-message">
                    ${message}
                </div>
            `;
            document.getElementById('cesiumContainer').innerHTML = errorHtml;
            hideLoading();
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        // ========== çª—å£ç®¡ç†åŠŸèƒ½ ==========
        
        // éšè—çª—å£
        function hideWindow(windowId) {
            document.getElementById(windowId).style.display = 'none';
        }
        
        // æœ€å°åŒ–çª—å£
        function minimizeWindow(windowId) {
            const window = document.getElementById(windowId);
            window.style.height = '40px';
            window.querySelector('.ai-chat-content, .control-content, .map-content').style.display = 'none';
            window.querySelector('.resize-handle').style.display = 'none';
        }
        
        // æœ€å¤§åŒ–çª—å£
        function maximizeWindow(windowId) {
            const window = document.getElementById(windowId);
            if (windowId === 'aiChatWindow') {
                window.style.top = '5%';
                window.style.left = '5%';
                window.style.width = '90%';
                window.style.height = '90%';
            } else if (windowId === 'controlWindow') {
                window.style.top = '5%';
                window.style.right = '5%';
                window.style.width = '30%';
                window.style.height = '90%';
            } else if (windowId === 'mapWindow') {
                window.style.top = '5%';
                window.style.left = '5%';
                window.style.width = '90%';
                window.style.height = '90%';
            }
            window.querySelector('.ai-chat-content, .control-content, .map-content').style.display = 'block';
            window.querySelector('.resize-handle').style.display = 'block';
        }
        
        // çª—å£æ‹–æ‹½åŠŸèƒ½
        function makeWindowDraggable(windowId) {
            const window = document.getElementById(windowId);
            if (!window) {
                console.warn(`Window ${windowId} not found`);
                return;
            }
            
            const header = window.querySelector('.window-header');
            if (!header) {
                console.warn(`Header not found in ${windowId}`);
                return;
            }
            
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            
            header.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);
            
            function dragStart(e) {
                initialX = e.clientX - window.offsetLeft;
                initialY = e.clientY - window.offsetTop;
                
                if (e.target === header || e.target.parentNode === header) {
                    isDragging = true;
                }
            }
            
            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    
                    window.style.left = currentX + 'px';
                    window.style.top = currentY + 'px';
                }
            }
            
            function dragEnd() {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
            }
        }
        
        // çª—å£ç¼©æ”¾åŠŸèƒ½
        function makeWindowResizable(windowId) {
            const window = document.getElementById(windowId);
            if (!window) {
                console.warn(`Window ${windowId} not found`);
                return;
            }
            
            const handles = window.querySelectorAll('.resize-handle');
            if (handles.length === 0) {
                console.warn(`Resize handles not found in ${windowId}`);
                return;
            }
            
            handles.forEach(handle => {
                handle.addEventListener('mousedown', resizeStart);
            });
            
            let isResizing = false;
            let startX, startY, startWidth, startHeight;
            
            function resizeStart(e) {
                e.preventDefault();
                isResizing = true;
                startX = e.clientX;
                startY = e.clientY;
                startWidth = window.offsetWidth;
                startHeight = window.offsetHeight;
                
                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', resizeEnd);
            }
            
            function resize(e) {
                if (isResizing) {
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    
                    if (e.target.classList.contains('e')) {
                        window.style.width = Math.max(200, startWidth + deltaX) + 'px';
                    }
                    if (e.target.classList.contains('s')) {
                        window.style.height = Math.max(100, startHeight + deltaY) + 'px';
                    }
                    if (e.target.classList.contains('se')) {
                        window.style.width = Math.max(200, startWidth + deltaX) + 'px';
                        window.style.height = Math.max(100, startHeight + deltaY) + 'px';
                    }
                }
            }
            
            function resizeEnd() {
                isResizing = false;
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', resizeEnd);
            }
        }
        
        // åˆå§‹åŒ–æ‰€æœ‰çª—å£çš„æ‹–æ‹½å’Œç¼©æ”¾
        function initializeWindowControls() {
            console.log('åˆå§‹åŒ–çª—å£æ§åˆ¶...');
            ['aiChatWindow', 'controlWindow', 'mapWindow'].forEach(windowId => {
                console.log(`åˆå§‹åŒ–çª—å£: ${windowId}`);
                makeWindowDraggable(windowId);
                makeWindowResizable(windowId);
            });
            console.log('çª—å£æ§åˆ¶åˆå§‹åŒ–å®Œæˆ');
        }
        
        // å›è½¦é”®å‘é€AIæ¶ˆæ¯
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && event.target.id === 'aiInput') {
                sendAIMessage();
            }
        });
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ® æˆ˜å½¹å¯è§†åŒ–ç³»ç»ŸåŠ è½½å®Œæˆ');
            
            // åˆå§‹åŒ–çª—å£æ§åˆ¶
            initializeWindowControls();
            
            // åˆå§‹åŒ–ç³»ç»Ÿ
            initializeSystem();
        });
        
        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(event) {
            switch (event.code) {
                case 'Space':
                    event.preventDefault();
                    togglePlay();
                    break;
                case 'KeyR':
                    if (event.ctrlKey) {
                        event.preventDefault();
                        resetBattle();
                    }
                    break;
            }
        });
    </script>
</body>
</html>