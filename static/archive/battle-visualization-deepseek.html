<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>æˆ˜å½¹3Dé‡ç° - {{battleName}}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f1419;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }
        
        /* ä¸»å®¹å™¨ï¼šä¸Šä¸‹å¸ƒå±€ */
        .main-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* è¿”å›æŒ‰é’® */
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 215, 0, 0.9);
            color: #0f1419;
            border: none;
            padding: 12px 16px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
        }
        
        .back-button:hover {
            background: #ffd700;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        }
        
        /* ä¸ŠåŠéƒ¨åˆ†ï¼šæ–‡å­—å’Œå›¾ç‰‡åŒºåŸŸ */
        .upper-section {
            flex: 1;
            background: linear-gradient(135deg, #1a2029 0%, #2a3441 100%);
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
        }
        
        .content-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        .battle-title {
            font-size: 32px;
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .battle-subtitle {
            font-size: 16px;
            color: #94a3b8;
            margin-bottom: 5px;
        }
        
        .battle-meta {
            font-size: 14px;
            color: #64748b;
        }
        
        /* å†…å®¹åŒºåŸŸ */
        .content-area {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            overflow: hidden;
        }
        
        /* å·¦ä¾§æ–‡å­—å†…å®¹ */
        .text-content {
            background: rgba(20, 26, 35, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 16px;
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        
        .content-section {
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffd700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-content {
            font-size: 14px;
            line-height: 1.6;
            color: #e2e8f0;
        }
        
        .section-content ul {
            padding-left: 20px;
        }
        
        .section-content li {
            margin-bottom: 8px;
        }
        
        .highlight-text {
            color: #ffd700;
            font-weight: 600;
        }
        
        /* å³ä¾§å›¾ç‰‡åŒºåŸŸ */
        .image-content {
            background: rgba(20, 26, 35, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 16px;
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        
        .image-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .battle-image {
            border-radius: 12px;
            overflow: hidden;
            background: #1a2029;
            border: 2px solid rgba(255, 215, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .battle-image:hover {
            border-color: #ffd700;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.2);
        }
        
        .battle-image img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }
        
        .image-caption {
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.7);
            color: #e2e8f0;
            font-size: 13px;
            text-align: center;
            border-top: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            margin-top: 15px;
        }
        
        .control-btn {
            padding: 10px 20px;
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            border: 1px solid rgba(255, 215, 0, 0.4);
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            background: rgba(255, 215, 0, 0.3);
            border-color: #ffd700;
        }
        
        .control-btn.active {
            background: #ffd700;
            color: #0f1419;
        }
        
        /* ä¸‹åŠéƒ¨åˆ†ï¼š3Dåœ°å›¾è§†é¢‘åŒºåŸŸ */
        .lower-section {
            height: 40vh;
            background: #000;
            position: relative;
            border-top: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        .map-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.9), rgba(255, 215, 0, 0.7));
            padding: 12px 20px;
            z-index: 100;
            color: #0f1419;
        }
        
        .map-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .map-subtitle {
            font-size: 12px;
            opacity: 0.8;
        }
        
        #cesiumContainer {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        /* æ’­æ”¾æ§åˆ¶æ  */
        .playback-controls {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            border-radius: 25px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 200;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .play-btn {
            background: #ffd700;
            color: #0f1419;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .play-btn:hover {
            background: #ffed4e;
            transform: scale(1.05);
        }
        
        .play-btn.playing {
            background: #10ac84;
        }
        
        .progress-bar {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: #ffd700;
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s ease;
        }
        
        .time-display {
            color: #e2e8f0;
            font-size: 12px;
            font-weight: 600;
            min-width: 60px;
        }
        
        /* è½½å…¥ç”»é¢ */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 215, 0, 0.2);
            border-top: 4px solid #ffd700;
            border-radius: 50%;
            animation: spin 1.2s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #ffd700;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
        }
        
        .loading-subtext {
            color: #94a3b8;
            font-size: 14px;
            margin-top: 8px;
            text-align: center;
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        .text-content::-webkit-scrollbar,
        .image-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .text-content::-webkit-scrollbar-track,
        .image-content::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .text-content::-webkit-scrollbar-thumb,
        .image-content::-webkit-scrollbar-thumb {
            background: rgba(255, 215, 0, 0.3);
            border-radius: 3px;
        }
        
        .text-content::-webkit-scrollbar-thumb:hover,
        .image-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 215, 0, 0.5);
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1024px) {
            .content-area {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .battle-title {
                font-size: 24px;
            }
            
            .upper-section {
                padding: 15px;
            }
            
            .control-panel {
                flex-wrap: wrap;
                gap: 10px;
            }
        }
        
        @media (max-width: 768px) {
            .lower-section {
                height: 50vh;
            }
            
            .battle-title {
                font-size: 20px;
            }
            
            .back-button {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 15px;
                align-self: center;
            }
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .content-section {
            animation: fadeInUp 0.6s ease;
        }
        
        .battle-image {
            animation: fadeInUp 0.6s ease;
            animation-fill-mode: both;
        }
        
        .battle-image:nth-child(1) { animation-delay: 0.1s; }
        .battle-image:nth-child(2) { animation-delay: 0.2s; }
        .battle-image:nth-child(3) { animation-delay: 0.3s; }
        .battle-image:nth-child(4) { animation-delay: 0.4s; }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- è¿”å›æŒ‰é’® -->
        <button class="back-button" onclick="goBack()">
            â† è¿”å›å¯¹è¯
        </button>
        
        <!-- ä¸ŠåŠéƒ¨åˆ†ï¼šæ–‡å­—å’Œå›¾ç‰‡ -->
        <div class="upper-section">
            <div class="content-header">
                <h1 class="battle-title" id="battleTitle">æˆ˜å½¹åˆ†æ</h1>
                <div class="battle-subtitle" id="battleSubtitle">æ­£åœ¨åŠ è½½æˆ˜å½¹ä¿¡æ¯...</div>
                <div class="battle-meta" id="battleMeta">3Dé‡ç° Â· ä¸“ä¸šå†›äº‹åˆ†æ</div>
            </div>
            
            <div class="content-area">
                <!-- å·¦ä¾§æ–‡å­—å†…å®¹ -->
                <div class="text-content">
                    <div class="content-section">
                        <div class="section-title">
                            ğŸ“… å†å²èƒŒæ™¯
                        </div>
                        <div class="section-content" id="battleBackground">
                            æ­£åœ¨åˆ†ææˆ˜å½¹èƒŒæ™¯...
                        </div>
                    </div>
                    
                    <div class="content-section">
                        <div class="section-title">
                            âš”ï¸ æˆ˜æœ¯åˆ†æ
                        </div>
                        <div class="section-content" id="tacticalAnalysis">
                            æ­£åœ¨åˆ†ææˆ˜æœ¯ç­–ç•¥...
                        </div>
                    </div>
                    
                    <div class="content-section">
                        <div class="section-title">
                            ğŸ¯ å…³é”®å› ç´ 
                        </div>
                        <div class="section-content" id="keyFactors">
                            æ­£åœ¨åˆ†æå…³é”®å› ç´ ...
                        </div>
                    </div>
                    
                    <div class="control-panel">
                        <button class="control-btn" onclick="setView('overview')" id="viewOverview">
                            ğŸ“‹ å…¨æ™¯è§†è§’
                        </button>
                        <button class="control-btn" onclick="setView('tactical')" id="viewTactical">
                            âš”ï¸ æˆ˜æœ¯è§†è§’
                        </button>
                        <button class="control-btn" onclick="setView('aerial')" id="viewAerial">
                            âœˆï¸ ç©ºä¸­ä¿¯è§†
                        </button>
                    </div>
                </div>
                
                <!-- å³ä¾§å›¾ç‰‡å†…å®¹ -->
                <div class="image-content">
                    <div class="content-section">
                        <div class="section-title">
                            ğŸ–¼ï¸ ç›¸å…³å›¾ç‰‡
                        </div>
                        <div class="image-grid" id="imageGrid">
                            <!-- å›¾ç‰‡å°†åŠ¨æ€åŠ è½½ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ä¸‹åŠéƒ¨åˆ†ï¼š3Dåœ°å›¾ -->
        <div class="lower-section">
            <div class="map-header">
                <div class="map-title">ğŸ—ºï¸ 3Dæˆ˜å½¹åœ°å›¾</div>
                <div class="map-subtitle">ã€Šå…¨é¢æˆ˜äº‰ã€‹é£æ ¼ Â· å®æ—¶æˆ˜å½¹é‡ç°</div>
            </div>
            
            <div id="cesiumContainer">
                <!-- è½½å…¥ç”»é¢ -->
                <div class="loading-overlay" id="loadingOverlay">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">æ­£åœ¨åŠ è½½3Dåœ°å›¾...</div>
                    <div class="loading-subtext">å³å°†ä¸ºæ‚¨å‘ˆç°éœ‡æ’¼çš„æˆ˜å½¹é‡ç°</div>
                </div>
            </div>
            
            <!-- æ’­æ”¾æ§åˆ¶æ  -->
            <div class="playback-controls">
                <button class="play-btn" id="playBtn" onclick="togglePlay()">â–¶</button>
                <div class="progress-bar" onclick="seekTo(event)">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time-display" id="timeDisplay">0:00 / 0:00</div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½Cesiumåº“ -->
    <script src="cesium/Cesium.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let viewer;
        let isPlaying = false;
        let currentBattleData = null;
        let animationTime = 0;
        let totalDuration = 60; // 60ç§’çš„æˆ˜å½¹é‡ç°
        let processedEvents = new Set();
        let currentViewMode = 'overview';
        
        // æˆ˜å½¹æ•°æ®ï¼ˆä¸DeepSeeké¡µé¢ä¿æŒä¸€è‡´ï¼‰
        const battlesDatabase = {
            'chibi_208': {
                name: 'èµ¤å£ä¹‹æˆ˜',
                year: 208,
                location: { lat: 29.7, lon: 113.9 },
                description: '208å¹´å†¬ï¼Œå­™æƒã€åˆ˜å¤‡è”å†›åœ¨é•¿æ±Ÿèµ¤å£åœ°åŒºå¤§è´¥æ›¹æ“ï¼Œå¥ å®šäº†ä¸‰å›½é¼ç«‹çš„åŸºç¡€ã€‚è¿™æ˜¯ä¸­å›½å¤ä»£æœ€è‘—åçš„æ°´æˆ˜ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯ç«æ”»æˆ˜æœ¯çš„ç»å…¸èŒƒä¾‹ã€‚',
                participants: [
                    { name: 'æ›¹æ“å†›', commander: 'æ›¹æ“', color: '#ff4444' },
                    { name: 'å­™åˆ˜è”å†›', commander: 'å‘¨ç‘œã€åˆ˜å¤‡', color: '#4444ff' }
                ],
                tacticalAnalysis: `
                    <strong>ğŸ”¥ ç«æ”»æˆ˜æœ¯ï¼š</strong>åˆ©ç”¨ä¸œå—é£åŠ¿ï¼Œé‡‡ç”¨ç«èˆ¹æ”»å‡»æ›¹æ“è¿ç¯èˆ¹é˜Ÿ<br><br>
                    <strong>ğŸ“Š å…µåŠ›å¯¹æ¯”ï¼š</strong>æ›¹æ“80ä¸‡å¤§å†› vs å­™åˆ˜è”å†›çº¦5ä¸‡äºº<br><br>
                    <strong>ğŸ—ºï¸ åœ°å½¢ä¼˜åŠ¿ï¼š</strong>é•¿æ±Ÿå¤©é™©ï¼Œç‹­çª„æ°´åŸŸä¸åˆ©äºå¤§èˆ°é˜ŸæœºåŠ¨<br><br>
                    <strong>ğŸ’¡ æƒ…æŠ¥æˆ˜ï¼š</strong>å‘¨ç‘œã€è¯¸è‘›äº®ååŒä½œæˆ˜ï¼Œé»„ç›–è‹¦è‚‰è®¡å–å¾—ä¿¡ä»»
                `,
                keyFactors: `
                    <strong>ğŸŒªï¸ å¤©æ°”å› ç´ ï¼š</strong>ä¸œå—é£çš„çªç„¶å‡ºç°ä¸ºç«æ”»æä¾›äº†å…³é”®æ¡ä»¶<br><br>
                    <strong>âš“ èˆ¹åªè®¾è®¡ï¼š</strong>æ›¹æ“è¿ç¯èˆ¹çš„ä¾¿åˆ©æªæ–½åè€Œæˆä¸ºç«æ”»çš„å¼±ç‚¹<br><br>
                    <strong>ğŸ‘¥ å¿ƒç†æˆ˜æœ¯ï¼š</strong>è¿ç¯èˆ¹èµ·ç«åçš„ææ…Œæƒ…ç»ªè¿…é€Ÿè”“å»¶<br><br>
                    <strong>ğŸ¯ æˆ˜æœºæŠŠæ¡ï¼š</strong>å­™åˆ˜è”å†›å‡†ç¡®æŠ“ä½æœ€ä½³æ”»å‡»æ—¶æœº
                `,
                images: [
                    {
                        url: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=250&fit=crop',
                        caption: 'é•¿æ±Ÿèµ¤å£åœ°åŒºçš„åœ°ç†ç¯å¢ƒ'
                    },
                    {
                        url: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=250&fit=crop',
                        caption: 'ä¸‰å›½æ—¶æœŸçš„æˆ˜èˆ¹å’Œå…µå™¨'
                    },
                    {
                        url: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=250&fit=crop',
                        caption: 'ç«æ”»æˆ˜æœ¯çš„ç¤ºæ„å›¾'
                    },
                    {
                        url: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=250&fit=crop',
                        caption: 'èµ¤å£ä¹‹æˆ˜çš„æˆ˜ç•¥éƒ¨ç½²'
                    }
                ],
                events: [
                    { time: 10, description: 'æ›¹æ“å†›é˜Ÿé›†ç»“äºé•¿æ±ŸåŒ—å²¸ï¼Œå‡†å¤‡æ¸¡æ±Ÿä½œæˆ˜', type: 'deployment' },
                    { time: 20, description: 'ä¸œå—é£èµ·ï¼Œå­™åˆ˜è”å†›å‘èµ·ç«æ”»ï¼Œç«çƒ§æ›¹æ“è¿ç¯èˆ¹', type: 'fire_attack' },
                    { time: 30, description: 'æ›¹æ“å¤§è´¥ï¼Œå¼€å§‹å…¨é¢æ’¤é€€ï¼Œå¥ å®šäº†ä¸‰å›½é¼ç«‹çš„åŸºç¡€', type: 'retreat' }
                ]
            },
            'marathon_490bc': {
                name: 'é©¬æ‹‰æ¾æˆ˜å½¹',
                year: -490,
                location: { lat: 38.1, lon: 23.9 },
                description: 'å‰490å¹´ï¼Œå¸Œè…ŠåŸé‚¦è”å†›åœ¨é©¬æ‹‰æ¾å¹³åŸå‡»è´¥æ³¢æ–¯å…¥ä¾µå†›ï¼Œæ ‡å¿—ç€å¸Œè…Šæ–‡æ˜çš„èƒœåˆ©ã€‚è¿™ä¸€æˆ˜ç¡®ç«‹äº†é‡è£…æ­¥å…µæ–¹é˜µçš„æˆ˜æœ¯ä¼˜åŠ¿ã€‚',
                participants: [
                    { name: 'æ³¢æ–¯å†›', commander: 'è¾¾ææ–¯', color: '#ffaa44' },
                    { name: 'å¸Œè…Šè”å†›', commander: 'ç±³å¤ªäºšå¾·', color: '#44aaff' }
                ],
                tacticalAnalysis: `
                    <strong>ğŸ›¡ï¸ ç›¾é˜µæˆ˜æœ¯ï¼š</strong>å¸Œè…Šé‡è£…æ­¥å…µå½¢æˆç´§å¯†ç›¾ç‰Œæ–¹é˜µ<br><br>
                    <strong>ğŸ¹ è¿œç¨‹åŠ£åŠ¿ï¼š</strong>æ³¢æ–¯å¼“ç®­æ‰‹åœ¨è¿‘è·ç¦»æˆ˜æ–—ä¸­çš„å±€é™æ€§<br><br>
                    <strong>ğŸ’ª å‹‡æ•¢ç²¾ç¥ï¼š</strong>å¸Œè…Šå…¬æ°‘æˆ˜å£«çš„æˆ˜æ–—æ„å¿—<br><br>
                    <strong>â›°ï¸ åœ°å½¢ä¼˜åŠ¿ï¼š</strong>ä¸˜é™µåœ°å½¢å¯¹é˜²å¾¡æ–¹æœ‰åˆ©
                `,
                keyFactors: `
                    <strong>ğŸ¯ æˆ˜ç•¥ä½ç½®ï¼š</strong>é©¬æ‹‰æ¾å¹³åŸæˆä¸ºå†³å®šæ€§æˆ˜åœº<br><br>
                    <strong>âš”ï¸ æˆ˜æœ¯åˆ›æ–°ï¼š</strong>é‡è£…æ­¥å…µæ–¹é˜µé¦–æ¬¡å¤§è§„æ¨¡åº”ç”¨<br><br>
                    <strong>ğŸŒŸ é¢†å¯¼åŠ›ï¼š</strong>ç±³å¤ªäºšå¾·çš„æˆ˜æœ¯æŒ‡æŒ¥<br><br>
                    <strong>ğŸ›ï¸ æ–‡æ˜æ„ä¹‰ï¼š</strong>å¸Œè…Šæ°‘ä¸»åˆ¶åº¦çš„å†›äº‹ä½“ç°
                `,
                images: [
                    {
                        url: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=250&fit=crop',
                        caption: 'é©¬æ‹‰æ¾å¹³åŸçš„åœ°å½¢åœ°è²Œ'
                    },
                    {
                        url: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=250&fit=crop',
                        caption: 'å¸Œè…Šé‡è£…æ­¥å…µçš„è£…å¤‡'
                    },
                    {
                        url: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=250&fit=crop',
                        caption: 'æ³¢æ–¯å†›é˜Ÿçš„é˜µåˆ—'
                    }
                ],
                events: [
                    { time: 10, description: 'æ³¢æ–¯å†›é˜Ÿç™»é™†é©¬æ‹‰æ¾å¹³åŸï¼Œåˆ—é˜µå‡†å¤‡', type: 'deployment' },
                    { time: 20, description: 'å¸Œè…Šé‡è£…æ­¥å…µå‘èµ·å†²é”‹ï¼Œæ³¢æ–¯å¼“ç®­æ‰‹æºƒè´¥', type: 'assault' },
                    { time: 30, description: 'æ³¢æ–¯å†›å¤§è´¥ï¼Œå¸Œè…Šè·å¾—å†³å®šæ€§èƒœåˆ©', type: 'victory' }
                ]
            }
        };
        
        // åˆå§‹åŒ–ç³»ç»Ÿ
        async function initializeSystem() {
            try {
                console.log('ğŸš€ åˆå§‹åŒ–æˆ˜å½¹3Dé‡ç°ç³»ç»Ÿ...');
                
                // è·å–æˆ˜å½¹å‚æ•°
                const urlParams = new URLSearchParams(window.location.search);
                const battleId = urlParams.get('id');
                const battleName = urlParams.get('battle');
                
                if (!battleId || !battlesDatabase[battleId]) {
                    showError('æœªæ‰¾åˆ°æŒ‡å®šçš„æˆ˜å½¹æ•°æ®');
                    return;
                }
                
                // è®¾ç½®å½“å‰æˆ˜å½¹
                currentBattleData = battlesDatabase[battleId];
                
                // æ›´æ–°é¡µé¢å†…å®¹
                updateBattleInfo();
                updateContent();
                
                // åˆå§‹åŒ–åœ°å›¾
                await initializeMap();
                
                // éšè—è½½å…¥ç”»é¢
                hideLoading();
                
                console.log('âœ… 3Dé‡ç°ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
                showError('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }
        
        // æ›´æ–°æˆ˜å½¹ä¿¡æ¯
        function updateBattleInfo() {
            document.getElementById('battleTitle').textContent = currentBattleData.name;
            document.getElementById('battleSubtitle').textContent = `${currentBattleData.year > 0 ? currentBattleData.year + 'å¹´' : 'å‰' + Math.abs(currentBattleData.year) + 'å¹´'} Â· ${currentBattleData.location}`;
            document.getElementById('battleMeta').textContent = `å‚æˆ˜åŒæ–¹ï¼š${currentBattleData.participants.map(p => p.name).join(' vs ')}`;
        }
        
        // æ›´æ–°å†…å®¹
        function updateContent() {
            // æ›´æ–°æ–‡å­—å†…å®¹
            document.getElementById('battleBackground').innerHTML = currentBattleData.description;
            document.getElementById('tacticalAnalysis').innerHTML = currentBattleData.tacticalAnalysis;
            document.getElementById('keyFactors').innerHTML = currentBattleData.keyFactors;
            
            // æ›´æ–°å›¾ç‰‡
            updateImages();
        }
        
        // æ›´æ–°å›¾ç‰‡
        function updateImages() {
            const imageGrid = document.getElementById('imageGrid');
            imageGrid.innerHTML = '';
            
            currentBattleData.images.forEach(image => {
                const imageDiv = document.createElement('div');
                imageDiv.className = 'battle-image';
                imageDiv.innerHTML = `
                    <img src="${image.url}" alt="${image.caption}" loading="lazy">
                    <div class="image-caption">${image.caption}</div>
                `;
                imageGrid.appendChild(imageDiv);
            });
        }
        
        // åˆå§‹åŒ–åœ°å›¾
        async function initializeMap() {
            return new Promise((resolve, reject) => {
                try {
                    // ä½¿ç”¨å¯é çš„åœ°å›¾æº
                    viewer = new Cesium.Viewer('cesiumContainer', {
                        terrainProvider: new Cesium.EllipsoidTerrainProvider(),
                        imageryProvider: new Cesium.OpenStreetMapImageryProvider({
                            url: 'https://tile.openstreetmap.org/'
                        }),
                        shouldAnimate: true,
                        animation: false,
                        timeline: false,
                        baseLayerPicker: false,
                        geocoder: false,
                        homeButton: false,
                        sceneModePicker: false,
                        navigationHelpButton: false,
                        infoBox: false,
                        selectionIndicator: false,
                        scene3DOnly: true,
                        requestRenderMode: false,
                        maximumRenderTimeChange: Infinity
                    });
                    
                    // ä¼˜åŒ–è®¾ç½®
                    viewer.scene.highDynamicRange = false;
                    viewer.scene.globe.enableLighting = false;
                    viewer.scene.skyAtmosphere.show = false;
                    viewer.scene.globe.showGroundAtmosphere = false;
                    
                    // é£è½¬åˆ°æˆ˜å½¹ä½ç½®
                    const destination = Cesium.Cartesian3.fromDegrees(
                        currentBattleData.location.lon,
                        currentBattleData.location.lat,
                        20000.0
                    );
                    
                    viewer.camera.flyTo({
                        destination: destination,
                        duration: 4.0,
                        complete: function() {
                            console.log('ğŸ“ å·²åˆ°è¾¾æˆ˜å½¹ä½ç½®');
                            resolve();
                        }
                    });
                    
                } catch (error) {
                    console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
                    reject(error);
                }
            });
        }
        
        // è®¾ç½®è§†è§’
        function setView(mode) {
            if (!currentBattleData) return;
            
            currentViewMode = mode;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.control-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('view' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active');
            
            const location = currentBattleData.location;
            let altitude, duration;
            
            switch (mode) {
                case 'overview':
                    altitude = 30000;
                    duration = 2.0;
                    break;
                case 'tactical':
                    altitude = 10000;
                    duration = 2.0;
                    break;
                case 'aerial':
                    altitude = 3000;
                    duration = 1.5;
                    break;
            }
            
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(location.lon, location.lat, altitude),
                duration: duration
            });
        }
        
        // æ’­æ”¾æ§åˆ¶
        function togglePlay() {
            const playBtn = document.getElementById('playBtn');
            
            if (!isPlaying) {
                startPlayback();
            } else {
                pausePlayback();
            }
        }
        
        function startPlayback() {
            isPlaying = true;
            animationTime = 0;
            processedEvents.clear();
            
            document.getElementById('playBtn').innerHTML = 'â¸';
            document.getElementById('playBtn').classList.add('playing');
            
            startAnimationLoop();
        }
        
        function pausePlayback() {
            isPlaying = false;
            
            document.getElementById('playBtn').innerHTML = 'â–¶';
            document.getElementById('playBtn').classList.remove('playing');
        }
        
        function startAnimationLoop() {
            const animationInterval = setInterval(() => {
                if (!isPlaying) {
                    clearInterval(animationInterval);
                    return;
                }
                
                animationTime += 1;
                processBattleEvents();
                updateProgress();
                
                if (animationTime > totalDuration) {
                    pausePlayback();
                    animationTime = 0;
                }
            }, 1000);
        }
        
        function processBattleEvents() {
            currentBattleData.events.forEach((event, index) => {
                const eventId = `event_${index}`;
                
                if (!processedEvents.has(eventId) && animationTime >= event.time) {
                    console.log(`âš¡ è§¦å‘äº‹ä»¶: ${event.description}`);
                    
                    triggerEvent(event);
                    processedEvents.add(eventId);
                }
            });
        }
        
        function triggerEvent(event) {
            createBattleEffect(event);
        }
        
        function createBattleEffect(event) {
            const position = Cesium.Cartesian3.fromDegrees(
                currentBattleData.location.lon,
                currentBattleData.location.lat,
                200
            );
            
            switch (event.type) {
                case 'deployment':
                    createDeploymentEffect(position);
                    break;
                case 'assault':
                case 'cavalry_charge':
                    createAssaultEffect(position);
                    break;
                case 'fire_attack':
                    createFireEffect(position);
                    break;
                case 'victory':
                case 'defeat':
                    createVictoryEffect(position);
                    break;
                default:
                    createGeneralEffect(position);
            }
        }
        
        function createDeploymentEffect(position) {
            currentBattleData.participants.forEach((participant, index) => {
                const offset = (index - 0.5) * 0.005;
                const unitPosition = Cesium.Cartesian3.fromDegrees(
                    currentBattleData.location.lon + offset,
                    currentBattleData.location.lat,
                    100
                );
                
                const entity = viewer.entities.add({
                    position: unitPosition,
                    point: {
                        pixelSize: 25,
                        color: Cesium.Color.fromCssColorString(participant.color),
                        outlineColor: Cesium.Color.WHITE,
                        outlineWidth: 3
                    },
                    label: {
                        text: participant.name,
                        font: '18px Arial Black',
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 3,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE
                    }
                });
            });
        }
        
        function createAssaultEffect(position) {
            const explosionEntity = viewer.entities.add({
                position: position,
                point: {
                    pixelSize: 35,
                    color: Cesium.Color.ORANGE,
                    outlineColor: Cesium.Color.RED,
                    outlineWidth: 4
                },
                label: {
                    text: 'âš”ï¸ æ”»å‡»ï¼',
                    font: '20px Arial Black',
                    fillColor: Cesium.Color.RED,
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 3
                }
            });
            
            setTimeout(() => {
                viewer.entities.remove(explosionEntity);
            }, 6000);
        }
        
        function createFireEffect(position) {
            const fireEntity = viewer.entities.add({
                position: position,
                point: {
                    pixelSize: 30,
                    color: Cesium.Color.RED.withAlpha(0.8),
                    outlineColor: Cesium.Color.ORANGE,
                    outlineWidth: 3
                },
                label: {
                    text: 'ğŸ”¥ ç«æ”»ï¼',
                    font: '20px Arial Black',
                    fillColor: Cesium.Color.ORANGE,
                    outlineColor: Cesium.Color.RED,
                    outlineWidth: 3
                }
            });
            
            setTimeout(() => {
                viewer.entities.remove(fireEntity);
            }, 10000);
        }
        
        function createVictoryEffect(position) {
            const victoryEntity = viewer.entities.add({
                position: position,
                point: {
                    pixelSize: 45,
                    color: Cesium.Color.GOLD,
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 5
                },
                label: {
                    text: 'ğŸ† èƒœåˆ©ï¼',
                    font: '22px Arial Black',
                    fillColor: Cesium.Color.GOLD,
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 4
                }
            });
            
            setTimeout(() => {
                viewer.entities.remove(victoryEntity);
            }, 12000);
        }
        
        function createGeneralEffect(position) {
            const entity = viewer.entities.add({
                position: position,
                point: {
                    pixelSize: 20,
                    color: Cesium.Color.YELLOW,
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 2
                }
            });
            
            setTimeout(() => {
                viewer.entities.remove(entity);
            }, 4000);
        }
        
        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress() {
            const progress = (animationTime / totalDuration) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            const currentTime = formatTime(animationTime);
            const totalTime = formatTime(totalDuration);
            document.getElementById('timeDisplay').textContent = `${currentTime} / ${totalTime}`;
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        // è·³è½¬æ’­æ”¾
        function seekTo(event) {
            const progressBar = event.currentTarget;
            const rect = progressBar.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const percentage = clickX / rect.width;
            
            animationTime = Math.floor(percentage * totalDuration);
            updateProgress();
            
            // æ¸…ç©ºå·²å¤„ç†çš„äº‹ä»¶ï¼Œé‡æ–°å¤„ç†
            processedEvents.clear();
            if (viewer) {
                viewer.entities.removeAll();
            }
        }
        
        // è¿”å›å¯¹è¯
        function goBack() {
            window.close();
            window.location.href = 'deepseek-military.html';
        }
        
        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('cesiumContainer').innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #e74c3c; font-size: 18px;">
                    âŒ ${message}
                </div>
            `;
            hideLoading();
        }
        
        // éšè—è½½å…¥ç”»é¢
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ® æˆ˜å½¹3Dé‡ç°ç³»ç»ŸåŠ è½½å®Œæˆ');
            
            // è®¾ç½®é»˜è®¤è§†è§’
            setTimeout(() => {
                setView('overview');
            }, 5000);
            
            // åˆå§‹åŒ–ç³»ç»Ÿ
            initializeSystem();
        });
        
        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(event) {
            switch (event.code) {
                case 'Space':
                    event.preventDefault();
                    togglePlay();
                    break;
                case 'Digit1':
                    setView('overview');
                    break;
                case 'Digit2':
                    setView('tactical');
                    break;
                case 'Digit3':
                    setView('aerial');
                    break;
            }
        });
    </script>
</body>
</html>