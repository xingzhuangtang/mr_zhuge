<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>å†›äº‹å†å²AIåŠ©æ‰‹ - ç®€åŒ–ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f1419;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }
        
        /* ä¸»å®¹å™¨ï¼šå‚ç›´å¸ƒå±€ */
        .main-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* AIå¯¹è¯åŒºåŸŸ - ä¸ŠåŠéƒ¨åˆ† */
        .chat-section {
            height: 50vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #1a2029 0%, #2a3441 100%);
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        .chat-header {
            padding: 15px 20px;
            background: rgba(20, 26, 35, 0.9);
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
            text-align: center;
        }
        
        .chat-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffd700;
            margin-bottom: 5px;
        }
        
        .chat-subtitle {
            font-size: 13px;
            color: #94a3b8;
        }
        
        /* å¯¹è¯å†…å®¹åŒºåŸŸ */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px 20px;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .message.user .message-avatar {
            background: #ffd700;
            color: #0f1419;
        }
        
        .message.ai .message-avatar {
            background: #2a2f3a;
            color: #ffd700;
        }
        
        .message-content {
            max-width: 70%;
            padding: 12px 15px;
            border-radius: 14px;
            line-height: 1.5;
            word-wrap: break-word;
            background: rgba(0, 0, 0, 0.3);
        }
        
        .message.user .message-content {
            background: #ffd700;
            color: #0f1419;
        }
        
        .message.ai .message-content {
            background: rgba(20, 26, 35, 0.8);
            color: #e2e8f0;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .message.thinking .message-content {
            background: rgba(42, 47, 58, 0.8);
            color: #94a3b8;
            font-style: italic;
        }
        
        /* å›¾ç‰‡æ ·å¼ */
        .message-image {
            margin: 8px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .message-image img {
            width: 100%;
            height: auto;
            display: block;
            max-height: 150px;
            object-fit: cover;
        }
        
        .image-caption {
            padding: 6px 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #e2e8f0;
            font-size: 12px;
            text-align: center;
        }
        
        /* å¯è§†åŒ–æŒ‰é’® */
        .visualization-button {
            margin-top: 10px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .visualization-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }
        
        .visualization-button.hidden {
            display: none;
        }
        
        /* è¾“å…¥åŒºåŸŸ */
        .chat-input-area {
            padding: 15px 20px;
            background: rgba(20, 26, 35, 0.9);
            border-top: 1px solid rgba(255, 215, 0, 0.3);
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .input-container {
            flex: 1;
            position: relative;
            background: rgba(26, 32, 41, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 20px;
            padding: 12px 15px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            transition: border-color 0.2s ease;
        }
        
        .input-container:focus-within {
            border-color: #ffd700;
            box-shadow: 0 0 0 1px rgba(255, 215, 0, 0.3);
        }
        
        .chat-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: #fff;
            font-size: 14px;
            line-height: 1.4;
            resize: none;
            max-height: 80px;
            min-height: 20px;
        }
        
        .chat-input::placeholder {
            color: #64748b;
        }
        
        .send-button {
            background: #ffd700;
            color: #0f1419;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .send-button:hover {
            background: #ffed4e;
            transform: scale(1.05);
        }
        
        .send-button:disabled {
            background: #2a2f3a;
            color: #64748b;
            cursor: not-allowed;
            transform: none;
        }
        
        /* 3Då¯è§†åŒ–åŒºåŸŸ - ä¸‹åŠéƒ¨åˆ† */
        .visualization-section {
            height: 50vh;
            background: #000;
            position: relative;
            border-top: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        .viz-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.9), rgba(255, 215, 0, 0.7));
            padding: 8px 15px;
            z-index: 100;
            color: #0f1419;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .viz-title {
            font-size: 14px;
            font-weight: 700;
        }
        
        .viz-controls {
            display: flex;
            gap: 8px;
        }
        
        .viz-control-btn {
            background: rgba(0, 0, 0, 0.3);
            color: #0f1419;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .viz-control-btn:hover {
            background: rgba(0, 0, 0, 0.5);
        }
        
        .viz-control-btn.active {
            background: #0f1419;
            color: #ffd700;
        }
        
        .viz-status {
            position: absolute;
            top: 35px;
            left: 15px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            z-index: 100;
        }
        
        #cesiumContainer {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        /* æ’­æ”¾æ§åˆ¶æ  */
        .playback-controls {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 200;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .play-btn {
            background: #ffd700;
            color: #0f1419;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .play-btn:hover {
            background: #ffed4e;
            transform: scale(1.05);
        }
        
        .play-btn.playing {
            background: #10ac84;
        }
        
        .progress-bar {
            width: 120px;
            height: 3px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: #ffd700;
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s ease;
        }
        
        .time-display {
            color: #e2e8f0;
            font-size: 10px;
            font-weight: 600;
            min-width: 40px;
        }
        
        /* è½½å…¥ç”»é¢ */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 215, 0, 0.2);
            border-top: 3px solid #ffd700;
            border-radius: 50%;
            animation: spin 1.2s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #ffd700;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 215, 0, 0.3);
            border-radius: 2px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 215, 0, 0.5);
        }
        
        /* åŠ¨ç”» */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message {
            animation: fadeIn 0.4s ease;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- AIå¯¹è¯åŒºåŸŸ - ä¸ŠåŠéƒ¨åˆ† -->
        <div class="chat-section">
            <div class="chat-header">
                <div class="chat-title">ğŸ›ï¸ å†›äº‹å†å²AIåŠ©æ‰‹</div>
                <div class="chat-subtitle">ä¸“ä¸šå†›äº‹å†å²åˆ†æ Â· æ”¯æŒ3Dæˆ˜å½¹é‡ç°</div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <!-- æ¬¢è¿æ¶ˆæ¯ -->
                <div class="message ai">
                    <div class="message-avatar">ğŸ¤–</div>
                    <div class="message-content">
                        æ¬¢è¿ä½¿ç”¨å†›äº‹å†å²AIåŠ©æ‰‹ï¼<br><br>
                        æˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›ï¼š<br>
                        â€¢ ğŸ“š è¯¦ç»†çš„å†›äº‹å†å²çŸ¥è¯†<br>
                        â€¢ âš”ï¸ æˆ˜ç•¥æˆ˜æœ¯è§£è¯»<br>
                        â€¢ ğŸ–¼ï¸ ç›¸å…³å†å²å›¾ç‰‡<br>
                        â€¢ ğŸ® 3Dæˆ˜å½¹é‡ç°<br><br>
                        è¯·è¾“å…¥æ‚¨æƒ³äº†è§£çš„æˆ˜å½¹æˆ–å†›äº‹å†å²é—®é¢˜ï¼
                    </div>
                </div>
            </div>
            
            <div class="chat-input-area">
                <div class="input-container">
                    <textarea 
                        id="chatInput" 
                        class="chat-input" 
                        placeholder="è¯·è¾“å…¥æ‚¨æƒ³äº†è§£çš„æˆ˜å½¹æˆ–å†›äº‹å†å²é—®é¢˜..."
                        rows="1"
                        oninput="autoResizeTextarea(this)"
                        onkeydown="handleKeyDown(event)"
                    ></textarea>
                </div>
                <button class="send-button" id="sendBtn" onclick="sendMessage()">
                    â¤
                </button>
            </div>
        </div>
        
        <!-- 3Då¯è§†åŒ–åŒºåŸŸ - ä¸‹åŠéƒ¨åˆ† -->
        <div class="visualization-section">
            <div class="viz-header">
                <div class="viz-title">ğŸ—ºï¸ 3Dæˆ˜å½¹åœ°å›¾ - ã€Šå…¨é¢æˆ˜äº‰ã€‹é£æ ¼</div>
                <div class="viz-controls">
                    <button class="viz-control-btn" onclick="setView('overview')" id="viewOverview">
                        ğŸ“‹ å…¨æ™¯
                    </button>
                    <button class="viz-control-btn" onclick="setView('tactical')" id="viewTactical">
                        âš”ï¸ æˆ˜æœ¯
                    </button>
                    <button class="viz-control-btn" onclick="setView('aerial')" id="viewAerial">
                        âœˆï¸ ç©ºä¸­
                    </button>
                    <button class="viz-control-btn" onclick="toggleFullscreen()">
                        â›¶ å…¨å±
                    </button>
                </div>
            </div>
            
            <div class="viz-status" id="vizStatus">
                ç­‰å¾…æˆ˜å½¹æ•°æ®åŠ è½½...
            </div>
            
            <div id="cesiumContainer">
                <!-- è½½å…¥ç”»é¢ -->
                <div class="loading-overlay" id="loadingOverlay">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">æ­£åœ¨åŠ è½½3Dåœ°å›¾...</div>
                </div>
            </div>
            
            <!-- æ’­æ”¾æ§åˆ¶æ  -->
            <div class="playback-controls">
                <button class="play-btn" id="playBtn" onclick="togglePlay()">â–¶</button>
                <div class="progress-bar" onclick="seekTo(event)">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time-display" id="timeDisplay">0:00 / 0:00</div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½Cesiumåº“ -->
    <script src="cesium/Cesium.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let viewer;
        let isPlaying = false;
        let currentBattleData = null;
        let animationTime = 0;
        let totalDuration = 60;
        let processedEvents = new Set();
        let currentViewMode = 'overview';
        let isFullscreen = false;
        
        // æˆ˜å½¹æ•°æ®ï¼ˆä¸DeepSeeké¡µé¢ä¿æŒä¸€è‡´ï¼‰
        const battlesDatabase = {
            'chibi_208': {
                name: 'èµ¤å£ä¹‹æˆ˜',
                year: 208,
                location: { lat: 29.7, lon: 113.9 },
                description: '208å¹´å†¬ï¼Œå­™æƒã€åˆ˜å¤‡è”å†›åœ¨é•¿æ±Ÿèµ¤å£åœ°åŒºå¤§è´¥æ›¹æ“ï¼Œå¥ å®šäº†ä¸‰å›½é¼ç«‹çš„åŸºç¡€ã€‚è¿™æ˜¯ä¸­å›½å¤ä»£æœ€è‘—åçš„æ°´æˆ˜ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯ç«æ”»æˆ˜æœ¯çš„ç»å…¸èŒƒä¾‹ã€‚',
                participants: [
                    { name: 'æ›¹æ“å†›', commander: 'æ›¹æ“', color: '#ff4444' },
                    { name: 'å­™åˆ˜è”å†›', commander: 'å‘¨ç‘œã€åˆ˜å¤‡', color: '#4444ff' }
                ],
                events: [
                    { time: 10, description: 'æ›¹æ“å†›é˜Ÿé›†ç»“äºé•¿æ±ŸåŒ—å²¸ï¼Œå‡†å¤‡æ¸¡æ±Ÿä½œæˆ˜', type: 'deployment' },
                    { time: 20, description: 'ä¸œå—é£èµ·ï¼Œå­™åˆ˜è”å†›å‘èµ·ç«æ”»ï¼Œç«çƒ§æ›¹æ“è¿ç¯èˆ¹', type: 'fire_attack' },
                    { time: 30, description: 'æ›¹æ“å¤§è´¥ï¼Œå¼€å§‹å…¨é¢æ’¤é€€ï¼Œå¥ å®šäº†ä¸‰å›½é¼ç«‹çš„åŸºç¡€', type: 'retreat' }
                ]
            },
            'marathon_490bc': {
                name: 'é©¬æ‹‰æ¾æˆ˜å½¹',
                year: -490,
                location: { lat: 38.1, lon: 23.9 },
                description: 'å‰490å¹´ï¼Œå¸Œè…ŠåŸé‚¦è”å†›åœ¨é©¬æ‹‰æ¾å¹³åŸå‡»è´¥æ³¢æ–¯å…¥ä¾µå†›ï¼Œæ ‡å¿—ç€å¸Œè…Šæ–‡æ˜çš„èƒœåˆ©ã€‚è¿™ä¸€æˆ˜ç¡®ç«‹äº†é‡è£…æ­¥å…µæ–¹é˜µçš„æˆ˜æœ¯ä¼˜åŠ¿ã€‚',
                participants: [
                    { name: 'æ³¢æ–¯å†›', commander: 'è¾¾ææ–¯', color: '#ffaa44' },
                    { name: 'å¸Œè…Šè”å†›', commander: 'ç±³å¤ªäºšå¾·', color: '#44aaff' }
                ],
                events: [
                    { time: 10, description: 'æ³¢æ–¯å†›é˜Ÿç™»é™†é©¬æ‹‰æ¾å¹³åŸï¼Œåˆ—é˜µå‡†å¤‡', type: 'deployment' },
                    { time: 20, description: 'å¸Œè…Šé‡è£…æ­¥å…µå‘èµ·å†²é”‹ï¼Œæ³¢æ–¯å¼“ç®­æ‰‹æºƒè´¥', type: 'assault' },
                    { time: 30, description: 'æ³¢æ–¯å†›å¤§è´¥ï¼Œå¸Œè…Šè·å¾—å†³å®šæ€§èƒœåˆ©', type: 'victory' }
                ]
            }
        };
        
        // åˆå§‹åŒ–ç³»ç»Ÿ
        async function initializeSystem() {
            try {
                console.log('ğŸš€ åˆå§‹åŒ–ç®€åŒ–ç‰ˆå†›äº‹å†å²ç³»ç»Ÿ...');
                
                // è·å–æˆ˜å½¹å‚æ•°
                const urlParams = new URLSearchParams(window.location.search);
                const battleId = urlParams.get('id');
                const battleName = urlParams.get('battle');
                
                if (battleId && battlesDatabase[battleId]) {
                    currentBattleData = battlesDatabase[battleId];
                    updateVizStatus(`æ­£åœ¨åŠ è½½ ${currentBattleData.name}...`);
                }
                
                // åˆå§‹åŒ–åœ°å›¾
                await initializeMap();
                
                // éšè—è½½å…¥ç”»é¢
                hideLoading();
                
                console.log('âœ… ç®€åŒ–ç‰ˆç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
                updateVizStatus('ç³»ç»ŸåŠ è½½å¤±è´¥');
                hideLoading();
            }
        }
        
        // æ›´æ–°å¯è§†åŒ–çŠ¶æ€
        function updateVizStatus(status) {
            const statusElement = document.getElementById('vizStatus');
            statusElement.textContent = status;
        }
        
        // åˆå§‹åŒ–åœ°å›¾
        async function initializeMap() {
            return new Promise((resolve, reject) => {
                try {
                    viewer = new Cesium.Viewer('cesiumContainer', {
                        terrainProvider: new Cesium.EllipsoidTerrainProvider(),
                        imageryProvider: new Cesium.OpenStreetMapImageryProvider({
                            url: 'https://tile.openstreetmap.org/'
                        }),
                        shouldAnimate: true,
                        animation: false,
                        timeline: false,
                        baseLayerPicker: false,
                        geocoder: false,
                        homeButton: false,
                        sceneModePicker: false,
                        navigationHelpButton: false,
                        infoBox: false,
                        selectionIndicator: false,
                        scene3DOnly: true,
                        requestRenderMode: false,
                        maximumRenderTimeChange: Infinity
                    });
                    
                    // ä¼˜åŒ–è®¾ç½®
                    viewer.scene.highDynamicRange = false;
                    viewer.scene.globe.enableLighting = false;
                    viewer.scene.skyAtmosphere.show = false;
                    viewer.scene.globe.showGroundAtmosphere = false;
                    
                    updateVizStatus('3Dåœ°å›¾å·²åŠ è½½ï¼Œå¯ä»¥æ’­æ”¾æˆ˜å½¹é‡ç°');
                    
                    if (currentBattleData) {
                        // é£è½¬åˆ°æˆ˜å½¹ä½ç½®
                        const destination = Cesium.Cartesian3.fromDegrees(
                            currentBattleData.location.lon,
                            currentBattleData.location.lat,
                            20000.0
                        );
                        
                        viewer.camera.flyTo({
                            destination: destination,
                            duration: 4.0,
                            complete: function() {
                                resolve();
                            }
                        });
                    } else {
                        resolve();
                    }
                    
                } catch (error) {
                    console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
                    updateVizStatus('åœ°å›¾åŠ è½½å¤±è´¥');
                    reject(error);
                }
            });
        }
        
        // è®¾ç½®è§†è§’
        function setView(mode) {
            if (!viewer) return;
            
            currentViewMode = mode;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.viz-control-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('view' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active');
            
            let altitude, duration;
            
            switch (mode) {
                case 'overview':
                    altitude = 30000;
                    duration = 2.0;
                    break;
                case 'tactical':
                    altitude = 10000;
                    duration = 2.0;
                    break;
                case 'aerial':
                    altitude = 3000;
                    duration = 1.5;
                    break;
            }
            
            const location = currentBattleData ? currentBattleData.location : { lat: 29.7, lon: 113.9 };
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(location.lon, location.lat, altitude),
                duration: duration
            });
        }
        
        // å…¨å±åˆ‡æ¢
        function toggleFullscreen() {
            const vizSection = document.querySelector('.visualization-section');
            
            if (!isFullscreen) {
                vizSection.style.position = 'fixed';
                vizSection.style.top = '0';
                vizSection.style.left = '0';
                vizSection.style.right = '0';
                vizSection.style.bottom = '0';
                vizSection.style.zIndex = '9999';
                vizSection.style.height = '100vh';
                isFullscreen = true;
                document.querySelector('.viz-control-btn[onclick="toggleFullscreen()"]').textContent = 'â¬‡ é€€å‡º';
                document.body.style.overflow = 'hidden';
            } else {
                vizSection.style.position = 'relative';
                vizSection.style.top = 'auto';
                vizSection.style.left = 'auto';
                vizSection.style.right = 'auto';
                vizSection.style.bottom = 'auto';
                vizSection.style.zIndex = 'auto';
                vizSection.style.height = '50vh';
                isFullscreen = false;
                document.querySelector('.viz-control-btn[onclick="toggleFullscreen()"]').textContent = 'â›¶ å…¨å±';
                document.body.style.overflow = 'hidden';
            }
        }
        
        // æ’­æ”¾æ§åˆ¶
        function togglePlay() {
            const playBtn = document.getElementById('playBtn');
            
            if (!isPlaying) {
                startPlayback();
            } else {
                pausePlayback();
            }
        }
        
        function startPlayback() {
            isPlaying = true;
            animationTime = 0;
            processedEvents.clear();
            
            document.getElementById('playBtn').innerHTML = 'â¸';
            document.getElementById('playBtn').classList.add('playing');
            updateVizStatus('æ­£åœ¨æ’­æ”¾æˆ˜å½¹é‡ç°...');
            
            startAnimationLoop();
        }
        
        function pausePlayback() {
            isPlaying = false;
            
            document.getElementById('playBtn').innerHTML = 'â–¶';
            document.getElementById('playBtn').classList.remove('playing');
            updateVizStatus('æ’­æ”¾å·²æš‚åœ');
        }
        
        function startAnimationLoop() {
            const animationInterval = setInterval(() => {
                if (!isPlaying) {
                    clearInterval(animationInterval);
                    return;
                }
                
                animationTime += 1;
                processBattleEvents();
                updateProgress();
                
                if (animationTime > totalDuration) {
                    pausePlayback();
                    animationTime = 0;
                    updateVizStatus('æ’­æ”¾å®Œæˆ');
                }
            }, 1000);
        }
        
        function processBattleEvents() {
            if (!currentBattleData) return;
            
            currentBattleData.events.forEach((event, index) => {
                const eventId = `event_${index}`;
                
                if (!processedEvents.has(eventId) && animationTime >= event.time) {
                    console.log(`âš¡ è§¦å‘äº‹ä»¶: ${event.description}`);
                    
                    triggerEvent(event);
                    processedEvents.add(eventId);
                    updateVizStatus(`äº‹ä»¶: ${event.description}`);
                }
            });
        }
        
        function triggerEvent(event) {
            createBattleEffect(event);
        }
        
        function createBattleEffect(event) {
            if (!viewer || !currentBattleData) return;
            
            const position = Cesium.Cartesian3.fromDegrees(
                currentBattleData.location.lon,
                currentBattleData.location.lat,
                200
            );
            
            switch (event.type) {
                case 'deployment':
                    createDeploymentEffect(position);
                    break;
                case 'assault':
                    createAssaultEffect(position);
                    break;
                case 'fire_attack':
                    createFireEffect(position);
                    break;
                case 'victory':
                case 'defeat':
                case 'retreat':
                    createVictoryEffect(position);
                    break;
                default:
                    createGeneralEffect(position);
            }
        }
        
        function createDeploymentEffect(position) {
            currentBattleData.participants.forEach((participant, index) => {
                const offset = (index - 0.5) * 0.005;
                const unitPosition = Cesium.Cartesian3.fromDegrees(
                    currentBattleData.location.lon + offset,
                    currentBattleData.location.lat,
                    100
                );
                
                viewer.entities.add({
                    position: unitPosition,
                    point: {
                        pixelSize: 20,
                        color: Cesium.Color.fromCssColorString(participant.color),
                        outlineColor: Cesium.Color.WHITE,
                        outlineWidth: 2
                    },
                    label: {
                        text: participant.name,
                        font: '14px Arial Black',
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE
                    }
                });
            });
        }
        
        function createAssaultEffect(position) {
            const explosionEntity = viewer.entities.add({
                position: position,
                point: {
                    pixelSize: 25,
                    color: Cesium.Color.ORANGE,
                    outlineColor: Cesium.Color.RED,
                    outlineWidth: 3
                },
                label: {
                    text: 'âš”ï¸ æ”»å‡»ï¼',
                    font: '16px Arial Black',
                    fillColor: Cesium.Color.RED,
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 2
                }
            });
            
            setTimeout(() => {
                viewer.entities.remove(explosionEntity);
            }, 4000);
        }
        
        function createFireEffect(position) {
            const fireEntity = viewer.entities.add({
                position: position,
                point: {
                    pixelSize: 20,
                    color: Cesium.Color.RED.withAlpha(0.8),
                    outlineColor: Cesium.Color.ORANGE,
                    outlineWidth: 2
                },
                label: {
                    text: 'ğŸ”¥ ç«æ”»ï¼',
                    font: '16px Arial Black',
                    fillColor: Cesium.Color.ORANGE,
                    outlineColor: Cesium.Color.RED,
                    outlineWidth: 2
                }
            });
            
            setTimeout(() => {
                viewer.entities.remove(fireEntity);
            }, 6000);
        }
        
        function createVictoryEffect(position) {
            const victoryEntity = viewer.entities.add({
                position: position,
                point: {
                    pixelSize: 30,
                    color: Cesium.Color.GOLD,
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 3
                },
                label: {
                    text: 'ğŸ† èƒœåˆ©ï¼',
                    font: '18px Arial Black',
                    fillColor: Cesium.Color.GOLD,
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 3
                }
            });
            
            setTimeout(() => {
                viewer.entities.remove(victoryEntity);
            }, 8000);
        }
        
        function createGeneralEffect(position) {
            const entity = viewer.entities.add({
                position: position,
                point: {
                    pixelSize: 15,
                    color: Cesium.Color.YELLOW,
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 2
                }
            });
            
            setTimeout(() => {
                viewer.entities.remove(entity);
            }, 3000);
        }
        
        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress() {
            const progress = (animationTime / totalDuration) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            const currentTime = formatTime(animationTime);
            const totalTime = formatTime(totalDuration);
            document.getElementById('timeDisplay').textContent = `${currentTime} / ${totalTime}`;
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        // è·³è½¬æ’­æ”¾
        function seekTo(event) {
            const progressBar = event.currentTarget;
            const rect = progressBar.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const percentage = clickX / rect.width;
            
            animationTime = Math.floor(percentage * totalDuration);
            updateProgress();
            
            // æ¸…ç©ºå·²å¤„ç†çš„äº‹ä»¶ï¼Œé‡æ–°å¤„ç†
            processedEvents.clear();
            if (viewer) {
                viewer.entities.removeAll();
                if (currentBattleData) {
                    // é‡æ–°åˆ›å»ºéƒ¨ç½²æ•ˆæœ
                    const position = Cesium.Cartesian3.fromDegrees(
                        currentBattleData.location.lon,
                        currentBattleData.location.lat,
                        200
                    );
                    createDeploymentEffect(position);
                }
            }
        }
        
        // éšè—è½½å…¥ç”»é¢
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        // ========== AIå¯¹è¯åŠŸèƒ½ï¼ˆç®€åŒ–ç‰ˆï¼‰==========
        
        // å…¨å±€å˜é‡
        let battleContext = null;
        
        // è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 80) + 'px';
            
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = !textarea.value.trim();
        }
        
        // é”®ç›˜äº‹ä»¶å¤„ç†
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessageToDOM(message, 'user');
            input.value = '';
            autoResizeTextarea(input);
            
            // æ·»åŠ AIæ€è€ƒçŠ¶æ€
            const thinkingMessage = addMessageToDOM('æ­£åœ¨åˆ†ææ‚¨çš„é—®é¢˜...', 'thinking');
            
            try {
                // è°ƒç”¨çœŸå®AIæœåŠ¡
                const aiResponse = await callAIService(message);
                
                // ç§»é™¤æ€è€ƒæ¶ˆæ¯
                thinkingMessage.remove();
                
                // æ·»åŠ AIå›å¤
                const aiMessage = addMessageToDOM(aiResponse.content, 'ai');
                
                // å¦‚æœåŒ…å«å›¾ç‰‡ï¼Œæ˜¾ç¤ºå›¾ç‰‡
                if (aiResponse.images && aiResponse.images.length > 0) {
                    displayImages(aiResponse.images, aiMessage);
                }
                
                // å¦‚æœè¯†åˆ«åˆ°æˆ˜å½¹é—®é¢˜ï¼Œæ˜¾ç¤ºå¯è§†åŒ–æŒ‰é’®
                if (aiResponse.isBattle) {
                    showVisualizationButton(aiResponse.battleName, aiMessage);
                }
                
            } catch (error) {
                thinkingMessage.remove();
                addMessageToDOM('æŠ±æ­‰ï¼ŒAIåŠ©æ‰‹æš‚æ—¶æ— æ³•å“åº”ï¼Œè¯·ç¨åå†è¯•ã€‚', 'ai');
                console.error('AIæœåŠ¡é”™è¯¯:', error);
            }
            
            sendBtn.disabled = false;
        }
        
        // è°ƒç”¨AIæœåŠ¡ - è¿æ¥çœŸå®å¤§è¯­è¨€æ¨¡å‹
        async function callAIService(message) {
            try {
                // è°ƒç”¨çœŸå®çš„å¤§è¯­è¨€æ¨¡å‹API
                const response = await fetch('/api/v1/llm/military-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: message
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // æ£€æµ‹æ˜¯å¦æ˜¯æˆ˜å½¹ç›¸å…³é—®é¢˜
                const battleName = detectBattleName(message);
                
                if (battleName) {
                    battleContext = { name: battleName, info: getBattleInfo(battleName) };
                    return {
                        content: data.response,
                        isBattle: true,
                        battleName: battleName,
                        images: await searchBattleImages(battleName)
                    };
                } else {
                    return {
                        content: data.response,
                        isBattle: false,
                        images: []
                    };
                }
                
            } catch (error) {
                console.error('AIæœåŠ¡è°ƒç”¨å¤±è´¥:', error);
                
                // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œè¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯
                return {
                    content: 'æŠ±æ­‰ï¼ŒAIåŠ©æ‰‹æš‚æ—¶æ— æ³•å“åº”ï¼Œè¯·ç¨åå†è¯•æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚',
                    isBattle: false,
                    images: []
                };
            }
        }
        
        // æ£€æµ‹æˆ˜å½¹åç§°
        function detectBattleName(message) {
            const knownBattles = ['èµ¤å£ä¹‹æˆ˜', 'é©¬æ‹‰æ¾æˆ˜å½¹', 'é»‘æ–¯å»·æ–¯æˆ˜å½¹', 'æ»‘é“å¢æˆ˜å½¹', 'è‘›åº•æ–¯å ¡æˆ˜å½¹'];
            
            for (let battle of knownBattles) {
                if (message.includes(battle)) {
                    return battle;
                }
            }
            
            // æ¨¡ç³ŠåŒ¹é…
            if (message.includes('èµ¤å£')) return 'èµ¤å£ä¹‹æˆ˜';
            if (message.includes('é©¬æ‹‰æ¾')) return 'é©¬æ‹‰æ¾æˆ˜å½¹';
            if (message.includes('é»‘æ–¯å»·æ–¯')) return 'é»‘æ–¯å»·æ–¯æˆ˜å½¹';
            if (message.includes('æ»‘é“å¢')) return 'æ»‘é“å¢æˆ˜å½¹';
            if (message.includes('è‘›åº•æ–¯å ¡')) return 'è‘›åº•æ–¯å ¡æˆ˜å½¹';
            
            return null;
        }
        
        // è·å–æˆ˜å½¹ä¿¡æ¯
        function getBattleInfo(battleName) {
            const battles = {
                'èµ¤å£ä¹‹æˆ˜': {
                    year: 208,
                    location: 'é•¿æ±Ÿèµ¤å£',
                    participants: 'æ›¹æ“å†› vs å­™åˆ˜è”å†›'
                },
                'é©¬æ‹‰æ¾æˆ˜å½¹': {
                    year: -490,
                    location: 'é©¬æ‹‰æ¾å¹³åŸ',
                    participants: 'æ³¢æ–¯å†› vs å¸Œè…Šè”å†›'
                }
            };
            
            return battles[battleName] || null;
        }
        
        // æœç´¢æˆ˜å½¹ç›¸å…³å›¾ç‰‡
        async function searchBattleImages(battleName) {
            // æ¨¡æ‹Ÿå›¾ç‰‡æœç´¢å»¶è¿Ÿ
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // è¿”å›å¯¹åº”çš„æˆ˜å½¹å›¾ç‰‡
            const battleImageMap = {
                'èµ¤å£ä¹‹æˆ˜': [
                    {
                        url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=150&fit=crop',
                        caption: 'ğŸ›ï¸ é•¿æ±Ÿèµ¤å£åœ°å½¢å›¾',
                        category: 'terrain'
                    },
                    {
                        url: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=150&fit=crop',
                        caption: 'âš”ï¸ ä¸‰å›½æˆ˜èˆ¹å’Œå…µå™¨',
                        category: 'troops'
                    }
                ],
                'é©¬æ‹‰æ¾æˆ˜å½¹': [
                    {
                        url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=150&fit=crop',
                        caption: 'ğŸ—ºï¸ å¸Œè…Šé©¬æ‹‰æ¾å¹³åŸ',
                        category: 'terrain'
                    },
                    {
                        url: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=150&fit=crop',
                        caption: 'âš”ï¸ å¸Œè…Šé‡è£…æ­¥å…µ',
                        category: 'troops'
                    }
                ]
            };
            
            return battleImageMap[battleName] || [];
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°DOM
        function addMessageToDOM(content, type) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const avatarIcon = type === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatarIcon}</div>
                <div class="message-content">${content}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageDiv.querySelector('.message-content');
        }
        
        // æ˜¾ç¤ºå›¾ç‰‡
        function displayImages(images, container) {
            images.forEach(image => {
                const imageDiv = document.createElement('div');
                imageDiv.className = 'message-image';
                imageDiv.innerHTML = `
                    <img src="${image.url}" alt="${image.caption}" loading="lazy">
                    <div class="image-caption">${image.caption}</div>
                `;
                container.appendChild(imageDiv);
            });
        }
        
        // æ˜¾ç¤ºå¯è§†åŒ–æŒ‰é’®
        function showVisualizationButton(battleName, container) {
            const button = document.createElement('button');
            button.className = 'visualization-button';
            button.innerHTML = 'ğŸ® å¼€å¯3Dæˆ˜å½¹é‡ç°';
            button.onclick = () => openVisualization(battleName);
            container.appendChild(button);
        }
        
        // æ‰“å¼€å¯è§†åŒ–é¡µé¢
        function openVisualization(battleName) {
            // è·å–æˆ˜å½¹ID
            const battleMap = {
                'èµ¤å£ä¹‹æˆ˜': 'chibi_208',
                'é©¬æ‹‰æ¾æˆ˜å½¹': 'marathon_490bc'
            };
            
            const battleId = battleMap[battleName];
            if (battleId) {
                // ç›´æ¥åœ¨å½“å‰é¡µé¢çš„ä¸‹åŠéƒ¨åˆ†åŠ è½½3Dé‡ç°
                loadBattleVisualization(battleId, battleName);
            } else {
                alert('æŠ±æ­‰ï¼Œæš‚ä¸æ”¯æŒè¯¥æˆ˜å½¹çš„3Dé‡ç°åŠŸèƒ½ã€‚');
            }
        }
        
        // åŠ è½½æˆ˜å½¹å¯è§†åŒ–åˆ°å½“å‰é¡µé¢
        function loadBattleVisualization(battleId, battleName) {
            currentBattleData = battlesDatabase[battleId];
            updateVizStatus(`æ­£åœ¨åŠ è½½ ${battleName}...`);
            
            if (viewer) {
                // é‡æ–°åˆå§‹åŒ–åœ°å›¾ä»¥æ˜¾ç¤ºæ–°æˆ˜å½¹
                initializeSystem();
            }
            
            // è®¾ç½®é»˜è®¤è§†è§’
            setTimeout(() => {
                setView('overview');
            }, 2000);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ® ç®€åŒ–ç‰ˆå†›äº‹å†å²ç³»ç»ŸåŠ è½½å®Œæˆ');
            
            // åˆå§‹åŒ–ç³»ç»Ÿ
            initializeSystem();
            
            // æ£€æŸ¥URLå‚æ•°ä¸­æ˜¯å¦æœ‰é¢„è®¾é—®é¢˜
            const urlParams = new URLSearchParams(window.location.search);
            const battleName = urlParams.get('battle');
            
            if (battleName) {
                // å»¶è¿Ÿä¸€ä¸‹è®©é¡µé¢å®Œå…¨åŠ è½½
                setTimeout(() => {
                    // è‡ªåŠ¨å‘é€é¢„è®¾é—®é¢˜
                    const chatInput = document.getElementById('chatInput');
                    const question = `è¯·è¯¦ç»†åˆ†æ${battleName}çš„æˆ˜æœ¯ç‰¹ç‚¹å’Œå†å²å½±å“`;
                    chatInput.value = question;
                    autoResizeTextarea(chatInput);
                    sendMessage();
                }, 1500);
            }
            
            // è®¾ç½®é»˜è®¤è§†è§’
            setTimeout(() => {
                setView('overview');
            }, 1000);
        });
        
        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(event) {
            switch (event.code) {
                case 'Space':
                    event.preventDefault();
                    togglePlay();
                    break;
                case 'Digit1':
                    setView('overview');
                    break;
                case 'Digit2':
                    setView('tactical');
                    break;
                case 'Digit3':
                    setView('aerial');
                    break;
                case 'KeyF':
                    if (event.ctrlKey) {
                        event.preventDefault();
                        toggleFullscreen();
                    }
                    break;
            }
        });
    </script>
</body>
</html>