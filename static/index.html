<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mrè¯¸è‘› - å†›äº‹å†å²æŒ‡æŒ¥ä¸­å¿ƒ</title>
    <style>
        :root {
            --glass-bg: rgba(10, 15, 30, 0.85);
            --glass-border: rgba(74, 144, 226, 0.3);
            --accent-color: #4a90e2;
            --text-color: #e0e0e0;
            --sidebar-width: 280px;
            --sidebar-bg: #1e1e1e;
            --sidebar-hover: #2d2d2d;
            --sidebar-active: #37373d;
            --sidebar-border: #3c3c3c;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Segoe UI', 'Roboto', 'Microsoft YaHei', sans-serif;
            background-color: #000;
            color: var(--text-color);
            display: flex;
        }

        /* Map Container - Now takes remaining space */
        #map {
            position: absolute;
            top: 0;
            left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            height: 100%;
            z-index: 1;
        }

        /* Globe Container - Same as map */
        #globe {
            position: absolute;
            top: 0;
            left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            height: 100%;
            z-index: 2;
            display: none;
        }

        /* VSCode-style Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100%;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--sidebar-border);
            z-index: 100;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
        }

        .sidebar-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--sidebar-border);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-header h1 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        /* Sidebar Item */
        .sidebar-item {
            padding: 10px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            position: relative;
        }

        .sidebar-item:hover {
            background: var(--sidebar-hover);
            border-left-color: var(--accent-color);
        }

        .sidebar-item.active {
            background: var(--sidebar-active);
            border-left-color: var(--accent-color);
        }

        .sidebar-item-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .sidebar-item-text {
            font-size: 14px;
            color: var(--text-color);
        }

        /* Sidebar Panel (Expanded Content) */
        .sidebar-panel {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            width: 380px;
            height: 100%;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            z-index: 90;
            display: none;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.5);
        }

        .sidebar-panel.active {
            display: flex;
        }

        .sidebar-panel-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
        }

        .sidebar-panel-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent-color);
        }

        .sidebar-panel-close {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .sidebar-panel-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Sidebar Resize Handle */
        .sidebar-resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            cursor: ew-resize;
            background: rgba(74, 144, 226, 0.3);
            border-right: 2px solid rgba(74, 144, 226, 0.5);
            transition: background 0.2s, border-right 0.2s;
            z-index: 1001;
        }

        .sidebar-resize-handle:hover {
            background: var(--accent-color);
            border-right: 2px solid var(--accent-color);
            width: 8px;
        }

        .sidebar-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* Tooltip */
        .sidebar-tooltip {
            position: absolute;
            left: calc(100% + 10px);
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .sidebar-item:hover .sidebar-tooltip {
            opacity: 1;
        }

        /* Sidebar Panel Styles */
        .control-group {
            margin-bottom: 12px;
            font-size: 12px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
        }

        .color-picker {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .color-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }

        .color-btn:hover {
            transform: scale(1.2);
        }

        .color-btn.active {
            border-color: white;
            box-shadow: 0 0 10px white;
        }

        input[type=range] {
            width: 100%;
            accent-color: var(--accent-color);
        }

        .toolbar-btns {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 10px;
        }

        .tool-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            color: #fff;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            padding-left: 15px;
        }

        .tool-btn:hover {
            background: var(--accent-color);
        }

        .tool-btn.active {
            background: var(--accent-color);
            box-shadow: 0 0 10px var(--accent-color);
        }

        /* Select and Input Styles in Sidebar Panel */
        .sidebar-panel-content select,
        .sidebar-panel-content input[type=text] {
            width: 100%;
            padding: 8px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--glass-border);
            color: white;
            border-radius: 4px;
            box-sizing: border-box;
        }

        /* Intelligence Log Styles */
        .intelligence-log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            font-size: 13px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            min-height: 150px;
            max-height: 300px;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(74, 144, 226, 0.1);
            border-radius: 4px;
            border-left: 3px solid var(--accent-color);
        }

        .timeline-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Video Section Styles */
        .video-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .video-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: black;
            border-radius: 4px;
            overflow: hidden;
        }

        .video-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
        }

        /* UI Overlay Container - Reduced scope */
        #ui-layer {
            position: absolute;
            top: 0;
            left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        /* Left Panel: Intelligence */
        .panel-left {
            position: absolute;
            top: 20px;
            left: 20px;
            width: var(--panel-width);
            height: 600px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            pointer-events: auto;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            transition: transform 0.3s ease;
            overflow: hidden;
            min-width: 300px;
            min-height: 400px;
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-color);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .panel-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Input Section */
        .input-group {
            position: relative;
        }

        textarea {
            width: 100%;
            height: 80px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--glass-border);
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            resize: none;
            font-family: inherit;
            font-size: 14px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-submit {
            flex: 1;
            padding: 12px;
            border: none;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-analysis {
            background: linear-gradient(90deg, #357abd, #4a90e2);
        }

        .btn-deduction {
            background: linear-gradient(90deg, #e65100, #ff9800);
        }

        .btn-submit:hover {
            opacity: 0.9;
        }

        /* Analysis Output */
        .analysis-box {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            font-size: 13px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .typing-cursor::after {
            content: 'â–‹';
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        /* Bottom Panel: Timeline */
        .panel-bottom {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: calc(100% - 40px);
            height: 60px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            pointer-events: auto;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 20px;
            overflow: hidden;
            min-width: 400px;
            min-height: 60px;
        }

        .timeline-controls {
            display: flex;
            gap: 15px;
        }

        .control-btn {
            background: none;
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: var(--accent-color);
            border-color: var(--accent-color);
            color: white;
            z-index: 10;
            box-shadow: 0 0 10px var(--accent-color);
        }

        .timeline-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            /* Standard property for compatibility */
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            outline: none;
        }

        .timeline-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent-color);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px var(--accent-color);
        }

        .time-display {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            min-width: 150px;
            text-align: right;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }

        .loader {
            width: 48px;
            height: 48px;
            border: 3px solid #FFF;
            border-radius: 50%;
            display: inline-block;
            position: relative;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        .loader::after {
            content: '';
            box-sizing: border-box;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid transparent;
            border-bottom-color: var(--accent-color);
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>

    <!-- AMap Security Config - è¯·åœ¨ .env æ–‡ä»¶ä¸­é…ç½® AMAP_SECURITY_CODE -->
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: "YOUR_AMAP_SECURITY_CODE",
        };
    </script>
    <script
        src="https://webapi.amap.com/maps?v=2.0&key=YOUR_AMAP_API_KEY&plugin=AMap.AutoComplete,AMap.PlaceSearch,AMap.Scale,AMap.ToolBar,AMap.ControlBar,AMap.MouseTool,AMap.GeometryUtil,AMap.ElasticMarker"></script>
    <!-- Loca 2.0 API -->
    <script src="https://webapi.amap.com/loca?v=2.0.0&key=YOUR_AMAP_API_KEY"></script>

    <!-- Cesium -->
    <!-- Cesium -->
    <link href="/static/cesium/Widgets/widgets.css" rel="stylesheet">
    <script>
        window.CESIUM_BASE_URL = '/static/cesium/';
    </script>
    <script src="/static/cesium/Cesium.js"></script>
    <!-- Window Manager -->
    <script src="/static/js/window-manager.js"></script>
    <!-- Drawing System -->
    <script src="/static/js/drawing-system.js"></script>

    <style>
        /* Globe Container */
        #globe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            /* Above map, below UI */
            display: none;
            /* Hidden by default */
        }

        /* Search Bar */
        .search-container {
            position: absolute;
            top: 20px;
            left: 440px;
            /* Right of the left panel */
            width: 360px;
            /* Increased width for button */
            z-index: 20;
            pointer-events: auto;
            display: flex;
            gap: 10px;
        }

        .search-input {
            flex: 1;
            padding: 12px 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            color: #fff;
            font-size: 14px;
            outline: none;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            transition: all 0.3s;
        }

        .search-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 20px rgba(74, 144, 226, 0.5);
        }

        .search-btn {
            width: 50px;
            height: 42px;
            /* Match input height roughly */
            border-radius: 21px;
            border: 1px solid var(--glass-border);
            background: var(--accent-color);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
        }

        .search-btn:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }

        /* Fix AMap Suggestion Transparency */
        .amap-sug-result {
            background-color: rgba(20, 25, 40, 0.95) !important;
            border: 1px solid var(--glass-border) !important;
            color: #e0e0e0 !important;
            border-radius: 8px !important;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5) !important;
        }

        .auto-item {
            background: transparent !important;
            color: #e0e0e0 !important;
            padding: 8px 10px !important;
        }

        .auto-item:hover {
            background-color: var(--accent-color) !important;
            color: white !important;
        }

        /* Geo Patterns */
        .geo-pattern-desert {
            width: 100%;
            height: 100%;
            background-image: radial-gradient(#FFD700 20%, transparent 20%);
            background-size: 10px 10px;
            border-radius: 50%;
            opacity: 0.6;
        }

        .geo-pattern-lake {
            width: 100%;
            height: 100%;
            background-image: radial-gradient(#00FF00 20%, transparent 20%);
            background-size: 10px 10px;
            border-radius: 50%;
            opacity: 0.6;
        }

        .geo-arrow-icon {
            font-size: 40px;
            color: red;
            font-weight: bold;
            text-shadow: 0 0 5px black;
        }

        /* View Toggle Button */
        .view-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 20;
            pointer-events: auto;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }

        .view-toggle:hover {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }

        /* Window drag handle visual feedback */
        .panel-header,
        .toolbar-title {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
        }

        .panel-header:hover,
        .toolbar-title:hover {
            background: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>

<body>

    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-overlay">
        <span class="loader"></span>
        <p style="margin-top: 20px; letter-spacing: 2px;">SYSTEM INITIALIZING...</p>
    </div>

    <!-- VSCode-style Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <span style="font-size: 40px;">ğŸª¶</span>
            <h1>Mrè¯¸è‘›</h1>
        </div>
        <div class="sidebar-content">
            <!-- æˆ˜æƒ…æ¨æ¼” -->
            <div class="sidebar-item" onclick="togglePanel('intelligence')" data-panel="intelligence">
                <span class="sidebar-item-icon">ğŸ“œ</span>
                <span class="sidebar-item-text">æˆ˜æƒ…æ¨æ¼”</span>
                <div class="sidebar-tooltip">AIæˆ˜å½¹åˆ†æä¸æ¨æ¼”ç³»ç»Ÿï¼Œæ”¯æŒæˆ˜æœ¯åˆ†æå’Œæˆ˜å½¹æ¨¡æ‹Ÿ</div>
            </div>
            
            <!-- å†å²ç–†åŸŸ -->
            <div class="sidebar-item" onclick="togglePanel('dynasty')" data-panel="dynasty">
                <span class="sidebar-item-icon">ğŸ—ºï¸</span>
                <span class="sidebar-item-text">å†å²ç–†åŸŸ</span>
                <div class="sidebar-tooltip">ä¸­å›½å†å²æœä»£ç–†åŸŸæµè§ˆï¼Œæ”¯æŒ18ä¸ªæœä»£å’Œ60+å†å²åŸå¸‚</div>
            </div>
            
            <!-- æˆ˜æœ¯ç»˜å›¾ -->
            <div class="sidebar-item" onclick="togglePanel('drawing')" data-panel="drawing">
                <span class="sidebar-item-icon">ğŸ¨</span>
                <span class="sidebar-item-text">æˆ˜æœ¯ç»˜å›¾</span>
                <div class="sidebar-tooltip">åœ°å›¾æˆ˜æœ¯ç»˜å›¾å·¥å…·ï¼Œæ”¯æŒé¢œè‰²ã€ç²—ç»†ã€é€æ˜åº¦è°ƒæ•´</div>
            </div>
            
            <!-- åˆ†éš”çº¿ -->
            <div style="height: 1px; background: var(--sidebar-border); margin: 10px 20px;"></div>
            
            <!-- åœ°çƒè§†å›¾ -->
            <div class="sidebar-item" onclick="toggleViewMode()">
                <span class="sidebar-item-icon">ğŸŒ</span>
                <span class="sidebar-item-text">åœ°çƒè§†å›¾</span>
                <div class="sidebar-tooltip">åˆ‡æ¢3Dåœ°çƒè§†å›¾å’Œå¹³é¢åœ°å›¾</div>
            </div>
        </div>
    </div>

    <!-- Sidebar Panels -->
    <!-- Intelligence Panel -->
    <div class="sidebar-panel" id="panel-intelligence">
        <div class="sidebar-panel-header">
            <span class="sidebar-panel-title">ğŸ“œ æˆ˜æƒ…æ¨æ¼”</span>
            <button class="sidebar-panel-close" onclick="togglePanel('intelligence')">âœ•</button>
        </div>
        <div class="sidebar-panel-content">
            <div class="intelligence-log" id="deduction-log">
                <div class="log-entry">ç­‰å¾…æŒ‡ä»¤...</div>
            </div>
            
            <!-- Timeline Section -->
            <div class="timeline-section">
                <div style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">ğŸ¬ æ¨æ¼”æ’­æ”¾</div>
                <div class="timeline-controls">
                    <button class="control-btn" onclick="togglePlay()">â–¶</button>
                    <button class="control-btn" onclick="resetTime()">â†º</button>
                    <div class="time-display" id="time-display">T+00:00:00</div>
                </div>
                <input type="range" class="timeline-slider" min="0" max="100" value="0" id="timeline">
            </div>
            
            <!-- Input Section -->
            <div style="margin-top: 20px;">
                <input type="text" id="user-input" class="intelligence-input" placeholder="è¾“å…¥æˆ˜å½¹ (å¦‚: è¯¸è‘›äº®åŒ—ä¼)..." onkeypress="handleKeyPress(event)">
                <div class="btn-group">
                    <button onclick="handleAnalysis()" class="btn-submit btn-analysis">åˆ†æ</button>
                    <button onclick="handleDeduction()" class="btn-submit btn-deduction">æ¨æ¼”æœç´¢</button>
                </div>
                <button onclick="handleVideoGeneration()" class="btn-submit btn-video">ğŸ¥ æˆ˜å½¹æ’­æ”¾</button>
            </div>
            
            <!-- Video Section -->
            <div id="embedded-video-section" class="video-section" style="display:none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="color: var(--accent-color); font-weight: bold;">ğŸ¥ æˆ˜å½¹è§†é¢‘</span>
                    <button onclick="closeVideoSection()" style="background:none; border:none; color:rgba(255,255,255,0.5); cursor:pointer;">âœ–</button>
                </div>
                <div class="video-container">
                    <video id="battle-video" controls style="width:100%; height:100%;">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚</video>
                    <div id="video-loading" class="video-loading">
                        <div class="loader" style="margin: 0 auto 10px auto;"></div>
                        <p style="font-size: 12px;">æ­£åœ¨ç”Ÿæˆ...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dynasty Panel -->
    <div class="sidebar-panel" id="panel-dynasty">
        <div class="sidebar-panel-header">
            <span class="sidebar-panel-title">ğŸ—ºï¸ å†å²ç–†åŸŸ</span>
            <button class="sidebar-panel-close" onclick="togglePanel('dynasty')">âœ•</button>
        </div>
        <div class="sidebar-panel-content">
            <select id="dynasty-select" onchange="switchDynasty(this.value)">
                <option value="none">-- ç°ä»£åœ°å›¾ --</option>
                <optgroup label="ä¸Šå¤ä¸‰ä»£">
                    <option value="xia_2070">å¤æœ (å‰2070-å‰1600)</option>
                    <option value="shang_1600">å•†æœ (å‰1600-å‰1046)</option>
                    <option value="zhou_1046">å‘¨æœ (å‰1046-å‰256)</option>
                </optgroup>
                <optgroup label="æ˜¥ç§‹æˆ˜å›½">
                    <option value="spring_autumn_770">æ˜¥ç§‹æ—¶æœŸ (å‰770-å‰476)</option>
                    <option value="warring_475">æˆ˜å›½æ—¶æœŸ (å‰475-å‰221)</option>
                </optgroup>
                <optgroup label="ç§¦æ±‰">
                    <option value="qin_221">ç§¦æœ (å‰221-å‰206)</option>
                    <option value="han_202">æ±‰æœ (å‰206-220)</option>
                </optgroup>
                <optgroup label="é­æ™‹å—åŒ—æœ">
                    <option value="three_kingdoms_220">ä¸‰å›½ (220-280)</option>
                    <option value="jin_265">æ™‹æœ (265-420)</option>
                </optgroup>
                <optgroup label="éš‹å”">
                    <option value="sui_581">éš‹æœ (581-618)</option>
                    <option value="tang_618">å”æœ (618-907)</option>
                </optgroup>
                <optgroup label="å®‹è¾½é‡‘å…ƒ">
                    <option value="five_dynasties_907">äº”ä»£åå›½ (907-960)</option>
                    <option value="song_960">å®‹æœ (960-1279)</option>
                    <option value="yuan_1271">å…ƒæœ (1271-1368)</option>
                </optgroup>
                <optgroup label="æ˜æ¸…">
                    <option value="ming_1368">æ˜æœ (1368-1644)</option>
                    <option value="qing_1644">æ¸…æœ (1644-1912)</option>
                </optgroup>
                <optgroup label="è¿‘ç°ä»£">
                    <option value="CCTS_1911">ä¸­åæ°‘å›½ (1912-1949)</option>
                </optgroup>
                <option value="custom">è‡ªå®šä¹‰ WMTS...</option>
            </select>
            <div id="custom-wmts" style="display:none; margin-top:15px;">
                <input type="text" id="wmts-url" placeholder="WMTS URL" style="width:100%; margin-bottom:10px;">
                <input type="text" id="wmts-layer" placeholder="Layer ID" style="width:100%; margin-bottom:10px;">
                <button onclick="applyCustomWMTS()" style="width:100%;" class="btn-submit">åº”ç”¨</button>
            </div>
        </div>
    </div>

    <!-- Drawing Panel -->
    <div class="sidebar-panel" id="panel-drawing">
        <div class="sidebar-panel-header">
            <span class="sidebar-panel-title">ğŸ¨ æˆ˜æœ¯ç»˜å›¾</span>
            <button class="sidebar-panel-close" onclick="togglePanel('drawing')">âœ•</button>
        </div>
        <div class="sidebar-panel-content">
            <div class="control-group">
                <label>é¢œè‰²:</label>
                <div class="color-picker">
                    <div class="color-btn active" style="background:red;" onclick="setDrawColor(this, '#ff0000')"></div>
                    <div class="color-btn" style="background:blue;" onclick="setDrawColor(this, '#0000ff')"></div>
                    <div class="color-btn" style="background:black;" onclick="setDrawColor(this, '#000000')"></div>
                </div>
            </div>

            <div class="control-group">
                <label>ç²—ç»†: <span id="width-val">5</span>px</label>
                <input type="range" min="1" max="20" value="5" oninput="setDrawWidth(this.value)">
            </div>

            <div class="control-group">
                <label>é€æ˜åº¦: <span id="opacity-val">1.0</span></label>
                <input type="range" min="0.1" max="1.0" step="0.1" value="1.0" oninput="setDrawOpacity(this.value)">
            </div>

            <div class="toolbar-btns">
                <button class="tool-btn" onclick="toggleDrawing(this)" id="btn-draw">âœï¸ å¼€å§‹ç»˜åˆ¶</button>
                <button class="tool-btn" onclick="toggleEraser(this)" id="btn-eraser">ğŸ§¹ æ©¡çš®æ“¦</button>
                <button class="tool-btn" onclick="playDrawing()" id="btn-play">â–¶ï¸ åŠ¨ç”»å›æ”¾</button>
                <button class="tool-btn" onclick="clearDrawing()" id="btn-clear">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰</button>
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Globe Container -->
    <div id="globe"></div>

    <!-- UI Layer -->
    <div id="ui-layer">

        <!-- Search Bar -->
        <div class="search-container">
            <input type="text" id="search-input" class="search-input" placeholder="æœç´¢åœ°ç‚¹ (ä¾‹å¦‚: é•¿å®‰)...">
            <button class="search-btn" onclick="triggerSearch()">ğŸš€</button>
        </div>

        <!-- View Toggle -->
        <button class="view-toggle" onclick="toggleViewMode()">ğŸŒ åˆ‡æ¢åœ°çƒè§†å›¾</button>

        <!-- Old floating panels removed - now in sidebar panels -->

    </div>

    <script>
        // --- Configuration ---
        const CONFIG = {
            center: [104.1954, 35.8617], // China Center
            zoom: 4,
            pitch: 60,
        };

        // --- State ---
        let map;
        let viewer; // Cesium Viewer
        let isGlobeView = false;
        let isPlaying = false;
        let currentDeductionData = null;
        let currentStepIndex = 0;
        let mapMarkers = [];
        let mapLines = [];
        let placeSearchInstance = null; // Store PlaceSearch instance
        let pulseLinkLayer = null; // Loca PulseLinkLayer
        let loca = null; // Loca Container
        let wmtsLayer = null; // Historical Map Layer
        let isHistMap = false; // Historical Map State
        let drawingSystem = null; // Drawing System Instance
        let windowManager = null; // Window Manager
        
        // --- Dynasty System State ---
        let currentDynasty = null;
        let dynastyMarkers = [];
        let historicalLayers = [];
        let dynastyLoading = false;
        let activePanel = null; // å½“å‰æ‰“å¼€çš„é¢æ¿
        let sidebarWidth = 280; // ä¾§è¾¹æ å½“å‰å®½åº¦
        let sidebarCollapsed = false; // ä¾§è¾¹æ æŠ˜å çŠ¶æ€

        // --- Sidebar Resize Function ---
        function initSidebarResize() {
            const sidebar = document.querySelector('.sidebar');
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'sidebar-resize-handle';
            resizeHandle.style.cssText = `
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 5px;
                cursor: ew-resize;
                background: var(--accent-color);
                border-radius: 2px 0 0 2px 0;
                transition: background 0.2s;
            `;
            resizeHandle.addEventListener('mouseenter', () => {
                resizeHandle.style.background = 'var(--accent-color)';
            });
            resizeHandle.addEventListener('mouseleave', () => {
                resizeHandle.style.background = 'rgba(74, 144, 226, 0.3)';
            });
            sidebar.appendChild(resizeHandle);

            let isResizing = false;
            let startX = 0;
            let startWidth = sidebarWidth;

            resizeHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                startWidth = sidebarWidth;
                document.body.style.cursor = 'ew-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                const newWidth = startWidth + (e.clientX - startX);
                if (newWidth >= 200 && newWidth <= 600) {
                    sidebarWidth = newWidth;
                    document.documentElement.style.setProperty('--sidebar-width', `${sidebarWidth}px`);
                }
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    localStorage.setItem('sidebarWidth', sidebarWidth);
                }
            });

            // åŒå‡»æŠ˜å /å±•å¼€ä¾§è¾¹æ 
            sidebar.addEventListener('dblclick', () => {
                sidebarCollapsed = !sidebarCollapsed;
                if (sidebarCollapsed) {
                    sidebar.style.width = '40px';
                    document.documentElement.style.setProperty('--sidebar-width', '40px');
                    resizeHandle.style.display = 'none';
                } else {
                    sidebar.style.width = `${sidebarWidth}px`;
                    document.documentElement.style.setProperty('--sidebar-width', `${sidebarWidth}px`);
                    resizeHandle.style.display = 'block';
                }
                localStorage.setItem('sidebarCollapsed', sidebarCollapsed);
            });

            // åŠ è½½ä¿å­˜çš„å®½åº¦
            const savedWidth = localStorage.getItem('sidebarWidth');
            if (savedWidth) {
                sidebarWidth = parseInt(savedWidth);
                document.documentElement.style.setProperty('--sidebar-width', `${sidebarWidth}px`);
            }

            const savedCollapsed = localStorage.getItem('sidebarCollapsed');
            if (savedCollapsed === 'true') {
                sidebarCollapsed = true;
                sidebar.style.width = '40px';
                document.documentElement.style.setProperty('--sidebar-width', '40px');
                resizeHandle.style.display = 'none';
            }
        }

        // --- Sidebar Panel Toggle Function ---
        function togglePanel(panelId) {
            // å…³é—­æ‰€æœ‰é¢æ¿
            const panels = document.querySelectorAll('.sidebar-panel');
            panels.forEach(panel => {
                panel.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰ä¾§è¾¹æ é¡¹ç›®çš„æ¿€æ´»çŠ¶æ€
            const items = document.querySelectorAll('.sidebar-item');
            items.forEach(item => {
                item.classList.remove('active');
            });
            
            // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰æ‰“å¼€çš„é¢æ¿ï¼Œåˆ™å…³é—­å®ƒ
            if (activePanel === panelId) {
                activePanel = null;
                return;
            }
            
            // æ‰“å¼€æŒ‡å®šé¢æ¿
            const panel = document.getElementById(`panel-${panelId}`);
            if (panel) {
                panel.classList.add('active');
                activePanel = panelId;
                
                // æ¿€æ´»å¯¹åº”çš„ä¾§è¾¹æ é¡¹ç›®
                const item = document.querySelector(`.sidebar-item[data-panel="${panelId}"]`);
                if (item) {
                    item.classList.add('active');
                }
            }
        }

        // Close video section helper function
        function closeVideoSection() {
            const videoSection = document.getElementById('embedded-video-section');
            if (videoSection) {
                videoSection.style.display = 'none';
            }
            const videoElem = document.getElementById('battle-video');
            if (videoElem) {
                videoElem.pause();
            }
        }

        // Handle Enter key press for input
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                handleDeduction();
            }
        }

        // --- Initialization ---
        window.onload = function () {
            // Initialize sidebar resize functionality
            initSidebarResize();
            
            if (typeof AMap !== 'undefined') {
                initMap();
                try {
                    if (typeof Loca !== 'undefined') {
                        initLoca();
                        console.log("Loca initialized successfully");
                    } else {
                        console.error("Loca is not defined.");
                    }
                } catch (e) {
                    console.error("Loca initialization failed:", e);
                }

                initSearch();
                addGeoLabels();

                // Init Drawing System
                drawingSystem = new DrawingSystem(map, viewer);

                // Init Window Manager
                windowManager = new WindowManager();
                windowManager.register('win-intelligence', 'æˆ˜æƒ…æ¨æ¼”', 'ğŸ“œ');
                // Timeline moved to inside intelligence window
                windowManager.register('win-drawing', 'æˆ˜æœ¯ç»˜å›¾', 'ğŸ¨');
                windowManager.register('win-dynasty', 'å†å²ç–†åŸŸ', 'ğŸ—ºï¸');
                // Removed win-video-player register

                setTimeout(() => {
                    document.getElementById('loading-screen').style.opacity = 0;
                    setTimeout(() => {
                        document.getElementById('loading-screen').style.display = 'none';
                    }, 500);
                }, 1500);
            } else {
                alert("åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key");
            }

            // Removed old makeDraggable calls as WindowManager handles it
        };

        function initMap() {
            // Using standard map with labels (doesn't require extra API permissions)
            // Satellite layer is optional and can be toggled
            map = new AMap.Map('map', {
                zoom: CONFIG.zoom,
                center: CONFIG.center,
                viewMode: '3D',
                pitch: CONFIG.pitch,
                skyColor: '#0a0f1e',
                mapStyle: 'amap://styles/normal', // Standard map with built-in labels
                features: ['bg', 'road', 'building', 'point'], // All features including labels
                showLabel: true, // Explicitly enable labels
                labelzIndex: 130 // Ensure labels are on top
            });

            // Optional: Add satellite layer (can be toggled)
            // Note: This may fail if API key doesn't have satellite permissions
            try {
                const satellite = new AMap.TileLayer.Satellite({
                    zIndex: 1,
                    opacity: 0.7 // Semi-transparent so labels show through
                });
                map.add(satellite);
                console.log('Satellite layer added (semi-transparent)');
            } catch (e) {
                console.warn('Satellite layer failed to load:', e);
            }

            // Add buildings for 3D effect at high zoom
            const buildings = new AMap.Buildings({
                zooms: [16, 18],
                zIndex: 10,
                heightFactor: 2
            });
            map.add(buildings);

            // Add controls
            map.addControl(new AMap.Scale());
            map.addControl(new AMap.ToolBar({
                position: 'RB'
            }));

            console.log('Map initialized with standard map + labels');
            console.log('Labels should be visible at all zoom levels');
        }

        function initLoca() {
            loca = new Loca.Container({
                map: map,
            });
        }

        function initCesium() {
            viewer = new Cesium.Viewer('globe', {
                animation: false,
                baseLayerPicker: false,
                fullscreenButton: false,
                vrButton: false,
                geocoder: false,
                homeButton: false,
                infoBox: false,
                sceneModePicker: false,
                selectionIndicator: false,
                timeline: false,
                navigationHelpButton: false,
                scene3DOnly: true,
                contextOptions: {
                    webgl: {
                        alpha: true
                    }
                }
            });

            viewer.scene.globe.baseColor = Cesium.Color.BLACK;
            viewer.cesiumWidget.creditContainer.style.display = "none";
        }



        function initSearch() {
            AMap.plugin(['AMap.PlaceSearch', 'AMap.AutoComplete'], function () {
                const auto = new AMap.AutoComplete({
                    input: "search-input"
                });
                placeSearchInstance = new AMap.PlaceSearch({
                    map: map
                });
                auto.on("select", function (e) {
                    placeSearchInstance.setCity(e.poi.adcode);
                    placeSearchInstance.search(e.poi.name);
                });
            });
        }

        // --- Historical Map Logic ---
        function switchDynasty(value) {
            console.log('åˆ‡æ¢æœä»£:', value);
            
            if (value === 'custom') {
                document.getElementById('custom-wmts').style.display = 'block';
                return;
            } else {
                document.getElementById('custom-wmts').style.display = 'none';
            }

            // Remove existing WMTS layer if any
            if (wmtsLayer) {
                map.remove(wmtsLayer);
                wmtsLayer = null;
            }

            // Remove Sepia Filter
            document.getElementById('map').style.filter = 'none';

            if (value === 'none') {
                isHistMap = false;
                clearHistoricalLayers();
                removeDynastyInfo();
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯å†å²æœä»£
            if (isHistoricalDynasty(value)) {
                loadDynastyMap(value);
            } else {
                // åŸæ¥çš„ WMTS é€»è¾‘
                addWMTSLayer(value);
            }
        }

        // æ£€æŸ¥æ˜¯å¦æ˜¯å†å²æœä»£
        function isHistoricalDynasty(dynastyId) {
            const historicalDynasties = [
                'xia_2070', 'shang_1600', 'zhou_1046', 'spring_autumn_770', 'warring_475',
                'qin_221', 'han_202', 'three_kingdoms_220', 'jin_265', 'sui_581', 'tang_618',
                'five_dynasties_907', 'song_960', 'yuan_1271', 'ming_1368', 'qing_1644'
            ];
            return historicalDynasties.includes(dynastyId);
        }

        function applyCustomWMTS() {
            const url = document.getElementById('wmts-url').value;
            const layer = document.getElementById('wmts-layer').value;
            if (url && layer) {
                addWMTSLayer(layer, url);
            }
        }

        function addWMTSLayer(layerId, url = 'https://gis.sinica.edu.tw/ccts/wmts') {
            console.log(`Loading WMTS Layer: ${layerId} from ${url}`);

            wmtsLayer = new AMap.TileLayer.WMTS({
                url: url,
                blend: false,
                tileSize: 256,
                zIndex: 50,
                params: {
                    Layer: layerId,
                    Style: 'default',
                    TileMatrixSet: 'GoogleMapsCompatible',
                    Format: 'image/png'
                }
            });

            // Fallback for Historical Vibe if tiles fail (or just as an effect)
            // Since we can't easily detect tile load failure globally, we can add a visual filter
            // But let's rely on the layer first.
            // If the user feels "no change", it might be because the layer is transparent or empty at that zoom.
            // Let's add a Sepia filter to the base map when historical mode is on to give immediate feedback.

            document.getElementById('map').style.filter = 'sepia(0.8) contrast(1.1)';

            map.add(wmtsLayer);
            isHistMap = true;
        }

        // ... (initSearch, triggerSearch, visualizeFeature remain same) ...

        // --- Drawing Control Functions ---
        function toggleDrawing(btn) {
            if (!drawingSystem) return;

            // Reset eraser button
            document.getElementById('btn-eraser').classList.remove('active');

            if (drawingSystem.isDrawing) {
                drawingSystem.disableDrawing();
                btn.classList.remove('active');
                btn.innerHTML = "âœï¸ å¼€å§‹ç»˜åˆ¶";
            } else {
                drawingSystem.enableDrawing();
                btn.classList.add('active');
                btn.innerHTML = "â¹ï¸ åœæ­¢ç»˜åˆ¶";
            }
        }

        function toggleEraser(btn) {
            if (!drawingSystem) return;

            // Reset draw button
            document.getElementById('btn-draw').classList.remove('active');
            document.getElementById('btn-draw').innerHTML = "âœï¸ å¼€å§‹ç»˜åˆ¶";

            drawingSystem.toggleEraser();
            if (drawingSystem.isEraser) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        }

        function setDrawColor(btn, color) {
            if (!drawingSystem) return;
            drawingSystem.setColor(color);

            // Update UI
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Reset eraser
            document.getElementById('btn-eraser').classList.remove('active');
        }

        function setDrawWidth(width) {
            if (!drawingSystem) return;
            drawingSystem.setWidth(width);
            document.getElementById('width-val').innerText = width;
        }

        function setDrawOpacity(opacity) {
            if (!drawingSystem) return;
            drawingSystem.setOpacity(opacity);
            document.getElementById('opacity-val').innerText = opacity;
        }

        function playDrawing() {
            if (drawingSystem) drawingSystem.play();
        }

        function clearDrawing() {
            if (drawingSystem) drawingSystem.clear();
        }

        function initLoca() {
            loca = new Loca.Container({
                map: map,
            });
        }

        function initCesium() {
            if (viewer) return;

            if (typeof Cesium === 'undefined') {
                console.error("Cesium library is not loaded. Please check the network or file path.");
                alert("æ— æ³•åŠ è½½åœ°çƒç»„ä»¶ (Cesium library missing)");
                return;
            }

            try {
                viewer = new Cesium.Viewer('globe', {
                    animation: false,
                    baseLayerPicker: false,
                    fullscreenButton: false,
                    vrButton: false,
                    geocoder: false,
                    homeButton: false,
                    infoBox: false,
                    sceneModePicker: false,
                    selectionIndicator: false,
                    timeline: false,
                    navigationHelpButton: false,
                    navigationInstructionsInitiallyVisible: false,
                    scene3DOnly: true,
                    shouldAnimate: true,
                    imageryProvider: new Cesium.ArcGisMapServerImageryProvider({
                        url: 'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer'
                    })
                });

                viewer.imageryLayers.addImageryProvider(new Cesium.UrlTemplateImageryProvider({
                    url: 'https://webst02.is.autonavi.com/appmaptile?style=8&x={x}&y={y}&z={z}',
                    minimumLevel: 3,
                    maximumLevel: 18
                }));

                viewer._cesiumWidget._creditContainer.style.display = "none";

                viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(104.1954, 35.8617, 10000000)
                });

                addCesiumLabels();
            } catch (e) {
                console.error("Cesium initialization failed:", e);
                alert("åœ°çƒç»„ä»¶åˆå§‹åŒ–å¤±è´¥: " + e.message);
            }
        }

        async function handleVideoGeneration() {
            const videoSection = document.getElementById('embedded-video-section');
            const videoElem = document.getElementById('battle-video');
            const loadingElem = document.getElementById('video-loading');

            // Show embedded section
            videoSection.style.display = 'block';

            // If video is already generated and valid, just play
            if (videoElem.src && videoElem.src.startsWith('http')) {
                videoElem.play();
                return;
            }

            loadingElem.style.display = 'block';
            videoElem.style.display = 'none';
        }

        function toggleViewMode() {
            const btn = document.querySelector('.view-toggle');
            const mapDiv = document.getElementById('map');
            const globeDiv = document.getElementById('globe');

            if (!isGlobeView) {
                // Switch to Globe
                initCesium();
                mapDiv.style.display = 'none';
                globeDiv.style.display = 'block';
                btn.innerText = "ğŸ—ºï¸ åˆ‡æ¢å¹³é¢åœ°å›¾";
                isGlobeView = true;

                // Sync Camera from Map to Globe
                try {
                    const center = map.getCenter();
                    const zoom = map.getZoom();
                    // Approximate height based on zoom level
                    const height = 10000000 / Math.pow(2, zoom - 4);

                    viewer.camera.flyTo({
                        destination: Cesium.Cartesian3.fromDegrees(center.lng, center.lat, height),
                        duration: 1.5
                    });
                } catch (e) {
                    console.warn("Camera sync failed:", e);
                }
            } else {
                // Switch to Map
                globeDiv.style.display = 'none';
                mapDiv.style.display = 'block';
                btn.innerText = "ğŸŒ åˆ‡æ¢åœ°çƒè§†å›¾";
                isGlobeView = false;
            }
        }

        function initSearch() {
            const autoOptions = {
                input: "search-input"
            };
            const autoComplete = new AMap.AutoComplete(autoOptions);
            placeSearchInstance = new AMap.PlaceSearch({
                map: map
            });

            autoComplete.on("select", select);

            function select(e) {
                const feature = geoData.find(item => item.name === e.poi.name || e.poi.name.includes(item.name));
                if (feature) {
                    visualizeFeature(feature);
                    return;
                }

                placeSearchInstance.setCity(e.poi.adcode);
                placeSearchInstance.search(e.poi.name);

                if (viewer) {
                    const lng = e.poi.location.lng;
                    const lat = e.poi.location.lat;
                    viewer.camera.flyTo({
                        destination: Cesium.Cartesian3.fromDegrees(lng, lat, 50000)
                    });
                }
            }
        }

        function triggerSearch() {
            const query = document.getElementById('search-input').value.trim();
            if (!query) return;

            // Check for special geo feature match
            const feature = geoData.find(item => item.name === query || query.includes(item.name));
            if (feature) {
                visualizeFeature(feature);
                return;
            }

            if (placeSearchInstance) {
                placeSearchInstance.search(query, function (status, result) {
                    // Handle result if needed, or let PlaceSearch auto-render
                    if (status === 'complete' && result.info === 'OK') {
                        // If globe view, fly to first result
                        if (viewer && result.poiList && result.poiList.pois.length > 0) {
                            const poi = result.poiList.pois[0];
                            viewer.camera.flyTo({
                                destination: Cesium.Cartesian3.fromDegrees(poi.location.lng, poi.location.lat, 50000)
                            });
                        }
                    }
                });
            }
        }

        function visualizeFeature(feature) {
            console.log("Visualizing feature:", feature.name);
            map.clearMap();

            if (pulseLinkLayer) {
                loca.remove(pulseLinkLayer);
                pulseLinkLayer = null;
            }
            addGeoLabels();

            // --- AMap Visualization ---
            if (feature.type === 'city') {
                // åŸå¸‚æ˜¾ç¤ºä¸ºè“è‰²åœ†åœˆ
                if (feature.position) {
                    const circle = new AMap.Circle({
                        center: feature.position,
                        radius: feature.radius || 20000,
                        strokeColor: "#1890ff",
                        strokeWeight: 3,
                        strokeOpacity: 1,
                        fillColor: '#1890ff',
                        fillOpacity: 0.2,
                        zIndex: 60
                    });
                    map.add(circle);
                    map.setFitView([circle]);
                }
            } else if (feature.type === 'mountain' || feature.type === 'river') {
                if (feature.path) {
                    // 1. Static Line (Base)
                    const polyline = new AMap.Polyline({
                        path: feature.path,
                        strokeColor: "red",
                        strokeWeight: 10, // Thicker line
                        strokeOpacity: 0.5,
                        zIndex: 100,
                        showDir: true // Arrows
                    });
                    map.add(polyline);
                    map.setFitView([polyline]);

                    // 2. Loca Pulse Link (Dynamic)
                    if (loca) {
                        try {
                            const geoJSON = {
                                "type": "FeatureCollection",
                                "features": [
                                    {
                                        "type": "Feature",
                                        "geometry": {
                                            "type": "LineString",
                                            "coordinates": feature.path
                                        },
                                        "properties": {
                                            "type": feature.type
                                        }
                                    }
                                ]
                            };

                            const geo = new Loca.GeoJSONSource({
                                data: geoJSON
                            });

                            pulseLinkLayer = new Loca.PulseLinkLayer({
                                loca: loca,
                                zIndex: 110,
                                opacity: 1,
                                zooms: [2, 22],
                                visible: true,
                            });

                            pulseLinkLayer.setSource(geo);
                            pulseLinkLayer.setStyle({
                                unit: 'meter',
                                dash: [40000, 0, 40000, 0],
                                lineWidth: [5000, 1000],
                                height: 0,
                                smoothSteps: 30,
                                speed: function (index, prop) {
                                    return 1000;
                                },
                                flowLength: 100000,
                                lineColors: function (index, feat) {
                                    return ['rgba(255, 0, 0, 1)', 'rgba(255, 200, 0, 0.5)', 'rgba(255, 0, 0, 0)'];
                                },
                                maxHeightScale: 0.3, // 3D arc height
                                headColor: 'rgba(255, 255, 0, 1)',
                                trailColor: 'rgba(255, 0, 0, 0)',
                            });

                            loca.add(pulseLinkLayer);
                            loca.animate.start();
                            console.log("Loca PulseLinkLayer added");
                        } catch (e) {
                            console.error("Loca PulseLinkLayer failed:", e);
                        }
                    }
                }
            } else {
                // Circle + Pattern/Arrow
                if (feature.radius) {
                    // 1. Red Circle
                    const circle = new AMap.Circle({
                        center: feature.position,
                        radius: feature.radius, // meters
                        strokeColor: "red",
                        strokeWeight: 6, // Thicker stroke
                        strokeOpacity: 1,
                        fillColor: 'red', // Add fill color
                        fillOpacity: 0.15, // Slight fill for visibility
                        zIndex: 50
                    });
                    map.add(circle);
                    map.setFitView([circle]);

                    // 2. Inner Content (Arrows or Dots)
                    let content = "";
                    if (feature.type === 'plateau') content = '<div class="geo-arrow-icon">â†‘</div>';
                    else if (feature.type === 'basin') content = '<div class="geo-arrow-icon">â†“</div>';
                    else if (feature.type === 'plain') content = '<div class="geo-arrow-icon">â†’ â†</div>';
                    else if (feature.type === 'desert') content = '<div class="geo-pattern-desert"></div>';
                    else if (feature.type === 'lake') content = '<div class="geo-pattern-lake"></div>';

                    if (content) {
                        // For patterns, we need a marker sized to the circle roughly (simplified)
                        // For arrows, just a center marker
                        const isPattern = feature.type === 'desert' || feature.type === 'lake';

                        const marker = new AMap.Marker({
                            position: feature.position,
                            content: content,
                            anchor: 'center',
                            offset: new AMap.Pixel(0, 0)
                        });

                        // If pattern, try to size it (AMap markers don't scale easily with zoom, so this is an approximation)
                        // A better way for patterns is Polygon with fill, but user asked for "Circle with dots"
                        if (isPattern) {
                            // Use a fixed large size for visibility
                            marker.setContent(`<div style="width: 200px; height: 200px; border-radius: 50%; overflow: hidden;">${content}</div>`);
                        }

                        map.add(marker);
                    }
                }
            }

            // --- Cesium Visualization ---
            if (viewer) {
                viewer.entities.removeAll(); // Clear previous
                addCesiumLabels(); // Re-add labels

                if (feature.type === 'city') {
                    // åŸå¸‚æ˜¾ç¤ºä¸ºè“è‰²æ¤­åœ†
                    if (feature.position) {
                        viewer.entities.add({
                            position: Cesium.Cartesian3.fromDegrees(feature.position[0], feature.position[1]),
                            ellipse: {
                                semiMinorAxis: feature.radius || 20000,
                                semiMajorAxis: feature.radius || 20000,
                                material: Cesium.Color.BLUE.withAlpha(0.2),
                                outline: true,
                                outlineColor: Cesium.Color.BLUE,
                                outlineWidth: 3
                            }
                        });
                        viewer.flyTo(viewer.entities);
                    }
                } else if (feature.type === 'mountain' || feature.type === 'river') {
                    if (feature.path) {
                        const cesiumPositions = feature.path.map(p => Cesium.Cartesian3.fromDegrees(p[0], p[1]));
                        viewer.entities.add({
                            polyline: {
                                positions: cesiumPositions,
                                width: 8, // Thicker
                                material: new Cesium.PolylineArrowMaterialProperty(Cesium.Color.RED), // Red Arrow
                                clampToGround: true
                            }
                        });
                        viewer.flyTo(viewer.entities);
                    }
                } else {
                    if (feature.radius) {
                        // Red Circle Outline + Fill
                        viewer.entities.add({
                            position: Cesium.Cartesian3.fromDegrees(feature.position[0], feature.position[1]),
                            ellipse: {
                                semiMinorAxis: feature.radius,
                                semiMajorAxis: feature.radius,
                                material: Cesium.Color.RED.withAlpha(0.15), // Add fill
                                outline: true,
                                outlineColor: Cesium.Color.RED,
                                outlineWidth: 5
                            }
                        });

                        // Inner Content
                        let entityProps = {
                            position: Cesium.Cartesian3.fromDegrees(feature.position[0], feature.position[1]),
                        };

                        if (feature.type === 'plateau') {
                            entityProps.label = { text: 'â†‘', font: '60px sans-serif', fillColor: Cesium.Color.RED, outlineWidth: 2 };
                        } else if (feature.type === 'basin') {
                            entityProps.label = { text: 'â†“', font: '60px sans-serif', fillColor: Cesium.Color.RED, outlineWidth: 2 };
                        } else if (feature.type === 'plain') {
                            entityProps.label = { text: 'â†’ â†', font: '60px sans-serif', fillColor: Cesium.Color.RED, outlineWidth: 2 };
                        } else if (feature.type === 'desert') {
                            // Yellow Dots (Simulated with Yellow transparent fill)
                            entityProps.ellipse = {
                                semiMinorAxis: feature.radius * 0.9,
                                semiMajorAxis: feature.radius * 0.9,
                                material: Cesium.Color.YELLOW.withAlpha(0.3)
                            };
                        } else if (feature.type === 'lake') {
                            // Green Dots (Simulated with Green transparent fill)
                            entityProps.ellipse = {
                                semiMinorAxis: feature.radius * 0.9,
                                semiMajorAxis: feature.radius * 0.9,
                                material: Cesium.Color.GREEN.withAlpha(0.3)
                            };
                        }

                        viewer.entities.add(entityProps);
                        viewer.flyTo(viewer.entities);
                    }
                }
            }
        }

        // --- Geographical Labels & Paths ---
        const geoData = [
            // å±±è„‰
            {
                name: "é•¿ç™½å±±", position: [128.05, 42.00], type: "mountain",
                path: [[127.5, 41.5], [128.05, 42.00], [128.5, 42.5]]
            },
            {
                name: "å¤ªè¡Œå±±", position: [113.50, 37.00], type: "mountain",
                path: [[113.0, 35.0], [113.5, 37.0], [114.0, 39.0], [115.5, 40.0]]
            },
            { name: "å¤§åˆ«å±±", position: [115.00, 31.00], type: "mountain", path: [[114.5, 31.5], [115.5, 30.5]] },
            {
                name: "å–œé©¬æ‹‰é›…å±±", position: [86.92, 27.98], type: "mountain",
                path: [[75.0, 35.0], [80.0, 30.0], [86.92, 27.98], [90.0, 28.0], [95.0, 29.5]]
            },
            {
                name: "ç¥è¿å±±", position: [99.00, 39.00], type: "mountain",
                path: [[95.0, 39.5], [99.0, 39.0], [103.0, 37.5]]
            },
            { name: "è‚¯ç‰¹å±±", position: [109.00, 49.00], type: "mountain", path: [[108.0, 48.5], [110.0, 49.5]] },
            {
                name: "ä¸­å¤®å±±è„‰", position: [121.00, 23.50], type: "mountain",
                path: [[121.5, 25.0], [121.0, 23.5], [120.8, 22.5]]
            },

            // æ²³æµ
            {
                name: "é»„æ²³", position: [110.00, 35.00], type: "river",
                path: [
                    [96.0, 34.0], [100.0, 35.0], [102.0, 34.0], [103.0, 36.0],
                    [106.0, 38.0], [108.0, 40.0], [111.0, 40.0], [111.0, 35.0],
                    [113.0, 34.8], [115.0, 35.0], [118.0, 37.0], [119.0, 37.5]
                ]
            },
            {
                name: "é•¿æ±Ÿ", position: [112.00, 30.00], type: "river",
                path: [
                    [91.0, 33.0], [97.0, 30.0], [100.0, 28.0], [104.0, 29.0],
                    [108.0, 30.5], [111.0, 30.0], [114.0, 29.5], [116.0, 29.8],
                    [119.0, 32.0], [121.0, 31.5], [122.0, 31.2]
                ]
            },

            // æ¹–æ³Š
            { name: "è´åŠ å°”æ¹–", position: [107.50, 53.50], type: "lake", radius: 150000 },

            // é«˜åŸ
            { name: "å†…è’™å¤é«˜åŸ", position: [115.00, 43.00], type: "plateau", radius: 400000 },
            { name: "é’è—é«˜åŸ", position: [90.00, 33.00], type: "plateau", radius: 800000 },

            // å¹³åŸ
            { name: "æ²³è¥¿èµ°å»Š", position: [102.00, 38.00], type: "plain", radius: 150000 },
            { name: "å®å¤å¹³åŸ", position: [106.00, 38.50], type: "plain", radius: 80000 },
            { name: "æˆéƒ½å¹³åŸ", position: [104.00, 30.50], type: "plain", radius: 60000 },

            // æ²™æ¼ 
            { name: "å¡”å…‹æ‹‰ç›å¹²æ²™æ¼ ", position: [83.00, 39.00], type: "desert", radius: 300000 },

            // é‡è¦åŸå¸‚å’Œæˆ˜å½¹åœ°ç‚¹
            { name: "é”¦å·", position: [121.15, 41.13], type: "city", radius: 20000 },
            { name: "æ²ˆé˜³", position: [123.43, 41.80], type: "city", radius: 30000 },
            { name: "é•¿æ˜¥", position: [125.32, 43.82], type: "city", radius: 25000 },
            { name: "åŒ—äº¬", position: [116.40, 39.90], type: "city", radius: 40000 },
            { name: "å¤©æ´¥", position: [117.20, 39.13], type: "city", radius: 25000 },
            { name: "æµå—", position: [117.00, 36.65], type: "city", radius: 25000 },
            { name: "å¾å·", position: [117.18, 34.27], type: "city", radius: 20000 },
            { name: "å—äº¬", position: [118.78, 32.04], type: "city", radius: 30000 },
            { name: "ä¸Šæµ·", position: [121.47, 31.23], type: "city", radius: 35000 },
            { name: "æ­¦æ±‰", position: [114.30, 30.58], type: "city", radius: 25000 },
            { name: "é•¿æ²™", position: [112.93, 28.19], type: "city", radius: 22000 },
            { name: "é‡åº†", position: [106.50, 29.56], type: "city", radius: 30000 },
            { name: "æˆéƒ½", position: [104.06, 30.66], type: "city", radius: 28000 },
            { name: "è¥¿å®‰", position: [108.94, 34.27], type: "city", radius: 25000 },
            { name: "å…°å·", position: [103.73, 36.03], type: "city", radius: 20000 },
            { name: "è¥¿å®", position: [101.74, 36.56], type: "city", radius: 18000 },
            { name: "é“¶å·", position: [106.27, 38.47], type: "city", radius: 15000 },
            { name: "å‘¼å’Œæµ©ç‰¹", position: [111.75, 40.84], type: "city", radius: 20000 },
            { name: "ä¹Œé²æœ¨é½", position: [87.62, 43.81], type: "city", radius: 25000 },
            { name: "æ‹‰è¨", position: [91.13, 29.65], type: "city", radius: 15000 },
            { name: "æ˜†æ˜", position: [102.71, 25.04], type: "city", radius: 22000 },
            { name: "è´µé˜³", position: [106.63, 26.58], type: "city", radius: 18000 },
            { name: "å—å®", position: [108.28, 22.82], type: "city", radius: 18000 },
            { name: "æµ·å£", position: [110.35, 20.03], type: "city", radius: 12000 },
            { name: "å¹¿å·", position: [113.23, 23.16], type: "city", radius: 30000 },
            { name: "ç¦å·", position: [119.31, 26.07], type: "city", radius: 20000 },
            { name: "æ­å·", position: [120.15, 30.28], type: "city", radius: 25000 },
            { name: "å—æ˜Œ", position: [115.89, 28.68], type: "city", radius: 18000 },
            { name: "åˆè‚¥", position: [117.23, 31.82], type: "city", radius: 20000 },
            { name: "éƒ‘å·", position: [113.62, 34.75], type: "city", radius: 22000 },
            { name: "å¤ªåŸ", position: [112.53, 37.87], type: "city", radius: 18000 },
            { name: "çŸ³å®¶åº„", position: [114.48, 38.03], type: "city", radius: 20000 }
        ];

        function addGeoLabels() {
            geoData.forEach(item => {
                const text = new AMap.Text({
                    text: item.name,
                    anchor: 'center', // Set anchor
                    draggable: false,
                    cursor: 'pointer',
                    angle: 0,
                    style: {
                        'padding': '.5rem 0.75rem',
                        'margin-bottom': '1rem',
                        'border-radius': '.25rem',
                        'background-color': 'rgba(0,0,0,0.5)',
                        'width': 'auto',
                        'border-width': 0,
                        'box-shadow': '0 2px 6px 0 rgba(114, 124, 245, .5)',
                        'text-align': 'center',
                        'font-size': '12px',
                        'color': '#fff',
                        'border': '1px solid rgba(255,255,255,0.3)'
                    },
                    position: item.position
                });
                text.setMap(map);
            });
        }

        function addCesiumLabels() {
            if (!viewer) return;

            geoData.forEach(item => {
                viewer.entities.add({
                    position: Cesium.Cartesian3.fromDegrees(item.position[0], item.position[1]),
                    label: {
                        text: item.name,
                        font: '14px sans-serif',
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                        pixelOffset: new Cesium.Cartesian2(0, -9),
                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
                        disableDepthTestDistance: Number.POSITIVE_INFINITY // Always visible
                    }
                });
            });
        }

        // --- Draggable & Resizable Logic ---
        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            const header = element.querySelector('.panel-header') || element.querySelector('.toolbar-title') || element;

            header.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        // --- Drawing Control Functions ---
        function toggleDrawing(btn) {
            if (!drawingSystem) return;

            if (drawingSystem.isDrawing) {
                drawingSystem.disableDrawing();
                btn.classList.remove('active');
                btn.innerHTML = "âœï¸ ç»˜åˆ¶";
            } else {
                drawingSystem.enableDrawing();
                btn.classList.add('active');
                btn.innerHTML = "â¹ï¸ åœæ­¢";
            }
        }

        function playDrawing() {
            if (drawingSystem) drawingSystem.play();
        }

        function clearDrawing() {
            if (drawingSystem) drawingSystem.clear();
        }

        // --- Handlers ---
        async function handleAnalysis() {
            const input = document.getElementById('user-input');
            const output = document.getElementById('deduction-log');
            const query = input.value.trim();

            if (!query) return;

            output.innerHTML = '';
            typeWriter(`> [æ¨¡å¼: æˆ˜æœ¯åˆ†æ]\n> æ¥æ”¶æŒ‡ä»¤: ${query}\n> è¿æ¥å¤§æ¨¡å‹çŸ¥è¯†åº“...\n\n`, output);

            try {
                const res = await fetch('/api/v1/llm/military-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: query })
                });
                const data = await res.json();

                typeWriter(data.response || "åˆ†æå¤±è´¥", output, true);

            } catch (e) {
                output.innerHTML += `<div class="log-entry">[ERROR] è¿æ¥å¤±è´¥: ${e.message}</div>`;
            }
        }

        async function handleDeduction() {
            const input = document.getElementById('user-input');
            const output = document.getElementById('deduction-log');
            const query = input.value.trim();

            if (!query) return;

            output.innerHTML = '';
            // Simulated "Internet Retrieval" Effect
            typeWriter(`> [æ¨¡å¼: æˆ˜å½¹æ¨æ¼”]\n> æ¥æ”¶æŒ‡ä»¤: ${query}\n`, output);
            await new Promise(r => setTimeout(r, 500));
            typeWriter(`> æ­£åœ¨è¿æ¥å†å²æ•°æ®åº“...\n`, output, true);
            await new Promise(r => setTimeout(r, 800));
            typeWriter(`> æ£€ç´¢å…³é”®è¯: "${query}"...\n`, output, true);
            await new Promise(r => setTimeout(r, 800));
            typeWriter(`> å‘ç°ç›¸å…³å²æ–™: ã€Šä¸‰å›½å¿—ã€‹ã€ã€Šèµ„æ²»é€šé‰´ã€‹...\n`, output, true);
            await new Promise(r => setTimeout(r, 600));
            typeWriter(`> æ­£åœ¨åˆæˆæˆ˜å½¹æ•°æ®...\n> æ­£åœ¨æ„å»º3Dåœºæ™¯...\n\n`, output, true);

            try {
                const res = await fetch('/api/v1/deduction/simulate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: query })
                });
                const data = await res.json();

                if (data.error) {
                    typeWriter(`[ERROR] ${data.error}`, output, true);
                    return;
                }

                currentDeductionData = data;
                currentStepIndex = 0;

                // Initialize Map for Deduction
                if (map && data.location) {
                    map.setZoomAndCenter(data.zoom || 10, data.location);
                    typeWriter(`> åœºæ™¯å·²åŠ è½½: ${data.title}\n> å‡†å¤‡å°±ç»ª,ç‚¹å‡»æ’­æ”¾å¼€å§‹æ¨æ¼”ã€‚\n`, output, true);
                }

                // Update Timeline Range
                const timeline = document.getElementById('timeline');
                timeline.max = data.steps.length - 1;
                timeline.value = 0;

            } catch (e) {
                output.innerHTML += `<div class="log-entry">[ERROR] æ¨æ¼”å¤±è´¥: ${e.message}</div>`;
            }
        }

        async function handleVideoGeneration() {
            const input = document.getElementById('user-input');
            const query = input.value.trim();

            if (!query) {
                alert("è¯·å…ˆè¾“å…¥æˆ˜å½¹åç§°ï¼");
                return;
            }

            // Show video window and loading state
            const videoSection = document.getElementById('embedded-video-section');
            if (videoSection) {
                videoSection.style.display = 'block';
            } else {
                console.error("Video section element not found!");
                return;
            }

            const videoElem = document.getElementById('battle-video');
            const loadingElem = document.getElementById('video-loading');

            if (videoElem) {
                videoElem.style.display = 'none';
                videoElem.pause();
                videoElem.src = ""; // Clear previous source
            }

            if (loadingElem) {
                loadingElem.style.display = 'block';
            }

            try {
                // Use deduction text if available, otherwise just usage the query name
                let textPrompt = query;
                let deductionSteps = null;

                if (currentDeductionData) {
                    if (currentDeductionData.description) {
                        textPrompt = currentDeductionData.title + "," + currentDeductionData.description;
                    }
                    if (currentDeductionData.steps) {
                        deductionSteps = currentDeductionData.steps;
                    }
                }

                const res = await fetch('/api/v1/multimodal/generate-video', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: textPrompt,
                        steps: deductionSteps
                    })
                });

                if (!res.ok) {
                    let errorMessage = `API Error: ${res.status}`;
                    try {
                        const errorData = await res.json();
                        if (errorData.detail) errorMessage = errorData.detail;
                    } catch (e) {
                        // Ignore json parse error
                    }
                    throw new Error(errorMessage);
                }

                const data = await res.json();

                if (data.video_url) {
                    if (videoElem) {
                        videoElem.src = data.video_url;
                        videoElem.style.display = 'block';
                        videoElem.play();
                    }
                    if (loadingElem) {
                        loadingElem.style.display = 'none';
                    }
                } else {
                    throw new Error("No video URL returned");
                }

            } catch (e) {
                console.error("Video generation failed:", e);
                if (loadingElem) {
                    loadingElem.innerHTML = `<p style="color:red">ç”Ÿæˆå¤±è´¥: ${e.message}</p>`;
                }
            }
        }

        // --- Animation Engine ---
        function renderStep(index) {
            if (!currentDeductionData || !currentDeductionData.steps[index]) return;

            const step = currentDeductionData.steps[index];
            const output = document.getElementById('deduction-log');

            // Update Log
            output.innerHTML += `<div class="log-entry" style="margin-top: 10px; border-left: 2px solid var(--accent-color); padding-left: 10px;">
                <strong style="color: var(--accent-color)">[T+${index}] ${step.time}</strong><br>
                ${step.description}
            </div>`;
            output.scrollTop = output.scrollHeight;

            // Clear previous step artifacts (optional, depending on desired persistence)
            // clearMapArtifacts(); 

            // Process Actions
            if (step.actions) {
                step.actions.forEach(action => {
                    // VALIDATION: Check for valid coordinates before creating map objects
                    if (action.type === 'marker') {
                        if (action.coordinate && action.coordinate.length === 2) {
                            const content = createColoredMarker(action.color || 'blue', action.label);
                            const marker = new AMap.Marker({
                                position: action.coordinate,
                                content: content,
                                offset: new AMap.Pixel(-15, -30),
                                title: action.label,
                                animation: 'AMAP_ANIMATION_DROP',
                                zIndex: 100
                            });
                            map.add(marker);
                            mapMarkers.push(marker);
                        } else {
                            console.warn("Invalid marker coordinate:", action);
                        }
                    } else if (action.type === 'circle') {
                        if (action.center && action.radius) {
                            const circle = new AMap.Circle({
                                center: action.center,
                                radius: action.radius,
                                fillColor: action.color || 'red',
                                fillOpacity: 0.3,
                                strokeColor: action.color || 'red',
                                strokeWeight: 2,
                                zIndex: 40
                            });
                            map.add(circle);
                            mapMarkers.push(circle); // Add to markers array for clearing
                        }
                    } else if (action.type === 'path' || action.type === 'arrow') {
                        // Check if path exists and has points, OR if from/to exist
                        const path = action.path || (action.from && action.to ? [action.from, action.to] : null);

                        if (path && path.length >= 2) {
                            const polyline = new AMap.Polyline({
                                path: path,
                                strokeColor: action.color || (action.type === 'arrow' ? "#FF33FF" : "#3366FF"),
                                strokeWeight: action.width || 6,
                                strokeOpacity: action.opacity || 0.9,
                                zIndex: 50,
                                showDir: true, // Always show direction
                                dirColor: 'white',
                                lineJoin: 'round'
                            });
                            map.add(polyline);
                            mapLines.push(polyline);
                        } else {
                            console.warn("Invalid path/arrow coordinates:", action);
                        }
                    }
                });
            }
        }

        function createColoredMarker(color, label) {
            const colorMap = {
                'red': '#ff4d4f',
                'blue': '#1890ff',
                'green': '#52c41a',
                'orange': '#fa8c16',
                'black': '#000000',
                'grey': '#8c8c8c',
                'cyan': '#13c2c2'
            };
            const hex = colorMap[color] || color;

            return `
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <div style="
                        background: ${hex}; 
                        width: 30px; 
                        height: 30px; 
                        border-radius: 50% 50% 0 50%; 
                        transform: rotate(45deg);
                        border: 2px solid white;
                        box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
                        display: flex; align-items: center; justify-content: center;
                    ">
                        <div style="width: 10px; height: 10px; background: white; border-radius: 50%;"></div>
                    </div>
                    <div style="
                        background: rgba(0,0,0,0.7); 
                        color: white; 
                        padding: 2px 6px; 
                        border-radius: 4px; 
                        font-size: 12px; 
                        margin-top: 5px;
                        white-space: nowrap;
                        transform: rotate(0deg);
                    ">${label}</div>
                </div>
            `;
        }

        function clearMapArtifacts() {
            map.remove(mapMarkers);
            map.remove(mapLines);
            mapMarkers = [];
            mapLines = [];
        }

        // --- Utilities ---
        function typeWriter(text, element, append = true) {
            if (!append) element.innerHTML = '';

            // Simple append for now to avoid complex async typing issues
            element.innerHTML += text.replace(/\n/g, '<br>');
            element.scrollTop = element.scrollHeight;
        }

        function togglePlay() {
            if (!currentDeductionData) return;

            isPlaying = !isPlaying;
            const btn = document.querySelector('.control-btn');
            btn.innerText = isPlaying ? 'â¸' : 'â–¶';

            if (isPlaying) {
                playLoop();
            }
        }

        function playLoop() {
            if (!isPlaying) return;

            const timeline = document.getElementById('timeline');
            let val = parseInt(timeline.value);

            if (val < parseInt(timeline.max)) {
                val++;
                timeline.value = val;
                renderStep(val);
                setTimeout(playLoop, 2000); // 2 seconds per step
            } else {
                isPlaying = false;
                document.querySelector('.control-btn').innerText = 'â–¶';
            }
        }

        function resetTime() {
            document.getElementById('timeline').value = 0;
            document.getElementById('time-display').innerText = 'T+00:00:00';
            clearMapArtifacts();
            currentStepIndex = 0;
        }

        // Timeline Listener
        document.getElementById('timeline').addEventListener('input', (e) => {
            const val = e.target.value;
            document.getElementById('time-display').innerText = `Step ${val}`;
            // Optional: render specific step on drag
        });

        // ========================================
        // Dynasty System Functions
        // ========================================

        // æœä»£åœ°å›¾åŠ è½½å‡½æ•°
        async function loadDynastyMap(dynastyId) {
            console.log(`æ­£åœ¨åŠ è½½æœä»£åœ°å›¾: ${dynastyId}`);
            
            if (dynastyLoading) {
                console.log('æ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }
            
            try {
                dynastyLoading = true;
                showDynastyLoading(true);
                
                // æ¸…é™¤ç°æœ‰å†å²å›¾å±‚
                clearHistoricalLayers();
                
                // åŠ è½½æœä»£æ•°æ® - ä¿®å¤APIè·¯å¾„
                const response = await fetch(`/api/v1/dynasty/dynasty/${dynastyId}`);
                if (!response.ok) {
                    throw new Error(`APIé”™è¯¯: ${response.status} ${response.statusText}`);
                }
                const dynastyData = await response.json();
                currentDynasty = dynastyData;
                
                // è®¾ç½®å†å²åœ°å›¾æ ·å¼
                applyHistoricalMapStyle(dynastyData.mapStyle);
                
                // æ·»åŠ æœä»£ä¿¡æ¯é¢æ¿
                addDynastyInfo(dynastyData);
                
                // æ·»åŠ å†å²åŸå¸‚æ ‡è®°
                await addHistoricalCities(dynastyData.majorCities);
                
                // è°ƒæ•´åœ°å›¾è§†è§’
                if (dynastyData.capital && dynastyData.capital.position) {
                    // ä½¿ç”¨æ­£ç¡®çš„é«˜å¾·åœ°å›¾APIæ–¹æ³•
                    map.setCenter(dynastyData.capital.position);
                    map.setZoom(6);
                }
                
                console.log(`æœä»£åœ°å›¾åŠ è½½å®Œæˆ: ${dynastyData.name}`);
                
            } catch (error) {
                console.error('åŠ è½½æœä»£åœ°å›¾å¤±è´¥:', error);
                showDynastyError(error.message);
            } finally {
                dynastyLoading = false;
                showDynastyLoading(false);
            }
        }

        // åº”ç”¨å†å²åœ°å›¾æ ·å¼
        function applyHistoricalMapStyle(styleConfig) {
            const mapElement = document.getElementById('map');
            
            // åº”ç”¨å†å²æ»¤é•œ
            if (styleConfig && styleConfig.filter) {
                mapElement.style.filter = styleConfig.filter;
            } else {
                mapElement.style.filter = 'sepia(0.5) contrast(1.1)';
            }
            
            // æ·»åŠ å†å²åœ°å›¾é®ç½©å±‚
            addHistoricalOverlay(styleConfig);
        }

        // æ·»åŠ å†å²åœ°å›¾é®ç½©å±‚
        function addHistoricalOverlay(styleConfig) {
            // ç§»é™¤ç°æœ‰çš„é®ç½©å±‚
            removeHistoricalOverlay();
            
            if (styleConfig && styleConfig.overlayColor) {
                const overlay = document.createElement('div');
                overlay.id = 'dynasty-overlay';
                overlay.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: ${styleConfig.overlayColor};
                    pointer-events: none;
                    z-index: 1;
                `;
                
                document.getElementById('map').appendChild(overlay);
                historicalLayers.push(overlay);
            }
        }

        // ç§»é™¤å†å²åœ°å›¾é®ç½©å±‚
        function removeHistoricalOverlay() {
            const overlay = document.getElementById('dynasty-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // æ·»åŠ å†å²åŸå¸‚æ ‡è®°
        async function addHistoricalCities(cities) {
            console.log(`æ·»åŠ  ${cities.length} ä¸ªå†å²åŸå¸‚`);
            
            for (const city of cities) {
                const marker = createHistoricalCityMarker(city);
                map.add(marker);
                dynastyMarkers.push(marker);
                
                // æ·»åŠ åŸå¸‚æ ‡ç­¾
                addCityLabel(city);
            }
        }

        // åˆ›å»ºå†å²åŸå¸‚æ ‡è®°
        function createHistoricalCityMarker(city) {
            const markerConfig = getCityMarkerConfig(city);
            
            const marker = new AMap.Marker({
                position: city.position,
                content: createCityMarkerContent(city, markerConfig),
                offset: new AMap.Pixel(-15, -30),
                title: `${city.name} (${city.modernName}) - ${city.type}`,
                zIndex: 100 + getCityImportanceScore(city.importance)
            });
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            marker.on('click', () => {
                showCityInfo(city);
            });
            
            return marker;
        }

        // åŸå¸‚æ ‡è®°é…ç½®
        function getCityMarkerConfig(city) {
            const configs = {
                'capital': { color: '#FFD700', size: 24, icon: 'ğŸ‘‘' },
                'secondary': { color: '#FF6347', size: 20, icon: 'ğŸ›ï¸' },
                'metropolis': { color: '#4169E1', size: 18, icon: 'ğŸ™ï¸' },
                'prefecture': { color: '#32CD32', size: 16, icon: 'ğŸ¯' },
                'fortress': { color: '#FF4500', size: 16, icon: 'ğŸ›¡ï¸' },
                'port': { color: '#00CED1', size: 16, icon: 'âš“' },
                'palace': { color: '#9370DB', size: 18, icon: 'ğŸ°' },
                'summer_palace': { color: '#FFB6C1', size: 16, icon: 'ğŸŒ¸' }
            };
            
            return configs[city.type] || { color: '#8C8C8C', size: 12, icon: 'ğŸ˜ï¸' };
        }

        // åˆ›å»ºåŸå¸‚æ ‡è®°å†…å®¹
        function createCityMarkerContent(city, config) {
            return `
                <div class="dynasty-city-marker" style="
                    display: flex; 
                    flex-direction: column; 
                    align-items: center; 
                    cursor: pointer;
                ">
                    <div class="city-icon" style="
                        background: ${config.color}; 
                        width: ${config.size}px; 
                        height: ${config.size}px; 
                        border-radius: 50%; 
                        border: 2px solid white;
                        display: flex; 
                        align-items: center; 
                        justify-content: center;
                        font-size: ${config.size * 0.5}px;
                        box-shadow: 2px 2px 8px rgba(0,0,0,0.5);
                        transition: all 0.3s ease;
                    ">
                        ${config.icon}
                    </div>
                    <div class="city-label" style="
                        background: rgba(0,0,0,0.8); 
                        color: white; 
                        padding: 4px 8px; 
                        border-radius: 4px; 
                        font-size: 12px; 
                        margin-top: 5px;
                        text-align: center;
                        white-space: nowrap;
                        max-width: 120px;
                        font-weight: bold;
                        border: 1px solid ${config.color};
                    ">
                        <div>${city.name}</div>
                        <div style="opacity: 0.7; font-size: 10px;">${city.modernName}</div>
                    </div>
                </div>
            `;
        }

        // è·å–åŸå¸‚é‡è¦æ€§å¾—åˆ†
        function getCityImportanceScore(importance) {
            const scores = {
                'major': 100,
                'important': 80,
                'minor': 60,
                'small': 40
            };
            return scores[importance] || 50;
        }

        // æ·»åŠ åŸå¸‚æ ‡ç­¾
        function addCityLabel(city) {
            const text = new AMap.Text({
                text: city.name,
                position: city.position,
                style: {
                    'background-color': 'rgba(0,0,0,0.8)',
                    'color': 'white',
                    'padding': '4px 8px',
                    'border-radius': '4px',
                    'font-size': '12px',
                    'border': '1px solid rgba(255,255,255,0.3)'
                },
                offset: new AMap.Pixel(0, -40)
            });
            
            map.add(text);
            dynastyMarkers.push(text);
        }

        // æ˜¾ç¤ºåŸå¸‚ä¿¡æ¯
        function showCityInfo(city) {
            const infoWindow = new AMap.InfoWindow({
                content: `
                    <div style="padding: 15px; color: black; max-width: 250px;">
                        <h3 style="margin: 0 0 10px 0; color: #333;">${city.name}</h3>
                        <p><strong>ç°ä»£åç§°ï¼š</strong>${city.modernName}</p>
                        <p><strong>åŸå¸‚ç±»å‹ï¼š</strong>${getCityTypeDisplay(city.type)}</p>
                        ${currentDynasty ? `<p><strong>æ‰€å±æœä»£ï¼š</strong>${currentDynasty.name}</p>` : ''}
                        <p><strong>åæ ‡ï¼š</strong>${city.position[1].toFixed(4)}, ${city.position[0].toFixed(4)}</p>
                    </div>
                `,
                position: city.position,
                offset: new AMap.Pixel(0, -20)
            });
            
            infoWindow.open(map, city.position);
        }

        // è·å–åŸå¸‚ç±»å‹æ˜¾ç¤ºåç§°
        function getCityTypeDisplay(type) {
            const typeNames = {
                'capital': 'é¦–éƒ½',
                'secondary': 'é™ªéƒ½',
                'metropolis': 'å¤§éƒ½ä¼š',
                'prefecture': 'å·åºœ',
                'fortress': 'è¦å¡',
                'port': 'æ¸¯å£',
                'palace': 'å®«æ®¿',
                'summer_palace': 'è¡Œå®«'
            };
            return typeNames[type] || type;
        }

        // æœä»£ä¿¡æ¯é¢æ¿
        function addDynastyInfo(dynastyData) {
            try {
                // ç§»é™¤ç°æœ‰çš„æœä»£ä¿¡æ¯é¢æ¿
                removeDynastyInfo();
                
                // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
                if (!dynastyData) {
                    console.error('æœä»£æ•°æ®ä¸ºç©º');
                    return;
                }
                
                // åˆ›å»ºæœä»£ä¿¡æ¯é¢æ¿
                const infoPanel = document.createElement('div');
                infoPanel.id = 'dynasty-info-panel';
                infoPanel.className = 'draggable-panel';
                infoPanel.style.cssText = `
                    position: absolute;
                    top: 100px;
                    left: 20px;
                    background: rgba(10, 15, 30, 0.9);
                    backdrop-filter: blur(20px);
                    border: 1px solid rgba(74, 144, 226, 0.3);
                    border-radius: 12px;
                    padding: 20px;
                    color: white;
                    z-index: 200;
                    min-width: 300px;
                    max-width: 350px;
                    box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
                    cursor: move;
                `;
                
                infoPanel.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <span style="font-size: 24px; margin-right: 10px;">${dynastyData.flag || 'ğŸ›ï¸'}</span>
                    <h3 style="margin: 0; color: ${dynastyData.color || '#4a90e2'};">
                        ${dynastyData.name}
                    </h3>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>æ—¶æœŸï¼š</strong>${dynastyData.period}
                </div>
                ${dynastyData.capital ? `
                <div style="margin-bottom: 10px;">
                    <strong>éƒ½åŸï¼š</strong>${dynastyData.capital.name} (${dynastyData.capital.modernName})
                </div>
                ` : ''}
                <div style="margin-bottom: 15px;">
                    <strong>é‡è¦åŸå¸‚ï¼š</strong>
                    <div style="margin-top: 5px; max-height: 80px; overflow-y: auto;">
                        ${dynastyData.majorCities.map(city => 
                            `<span style="
                                display: inline-block; 
                                background: rgba(74, 144, 226, 0.3); 
                                padding: 2px 6px; 
                                margin: 2px; 
                                border-radius: 4px; 
                                font-size: 12px;
                            ">${city.name}</span>`
                        ).join('')}
                    </div>
                </div>
                <button onclick="removeDynastyInfo()" style="
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: none;
                    border: none;
                    color: white;
                    cursor: pointer;
                    font-size: 16px;
                ">âœ•</button>
            `;
            
            document.body.appendChild(infoPanel);
            
            // ä½¿é¢æ¿å¯æ‹–åŠ¨
            makeDraggable(infoPanel);
            
            } catch (error) {
                console.error('æ·»åŠ æœä»£ä¿¡æ¯é¢æ¿æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showDynastyError(error.message);
            }
        }

        function removeDynastyInfo() {
            const existingPanel = document.getElementById('dynasty-info-panel');
            if (existingPanel) {
                existingPanel.remove();
            }
        }

        // æ¸…é™¤å†å²å›¾å±‚
        function clearHistoricalLayers() {
            // æ¸…é™¤æœä»£æ ‡è®°
            dynastyMarkers.forEach(marker => {
                if (marker.remove) {
                    marker.remove();
                } else if (marker.setMap) {
                    marker.setMap(null);
                }
            });
            dynastyMarkers = [];
            
            // æ¸…é™¤å†å²é®ç½©å±‚
            removeHistoricalOverlay();
            
            // æ¸…é™¤å…¶ä»–å†å²å›¾å±‚
            historicalLayers.forEach(layer => {
                if (layer.remove) {
                    layer.remove();
                }
            });
            historicalLayers = [];
            
            // é‡ç½®åœ°å›¾æ»¤é•œ
            document.getElementById('map').style.filter = 'none';
        }

        // æ˜¾ç¤ºæœä»£åŠ è½½çŠ¶æ€
        function showDynastyLoading(show) {
            const output = document.getElementById('deduction-log');
            if (show) {
                output.innerHTML = '<div class="log-entry">æ­£åœ¨åŠ è½½æœä»£æ•°æ®...</div>';
            }
        }

        // æ˜¾ç¤ºæœä»£é”™è¯¯
        function showDynastyError(error) {
            const output = document.getElementById('deduction-log');
            output.innerHTML += `<div class="log-entry" style="color: red;">[ERROR] ${error}</div>`;
        }

    </script>
</body>

</html>