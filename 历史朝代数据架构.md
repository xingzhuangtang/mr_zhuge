# ä¸­å›½å†å²æœä»£æ—¶ç©ºèåˆæŠ€æœ¯æ–¹æ¡ˆ

## æ•°æ®ç»“æ„è®¾è®¡

### 1. æœä»£åŸºç¡€æ•°æ® (dynasties.json)
```json
{
  "dynasties": [
    {
      "id": "jin_1115",
      "name": "é‡‘æœ",
      "period": "1115-1234",
      "startYear": 1115,
      "endYear": 1234,
      "capital": {
        "name": "ä¸­éƒ½",
        "position": [116.40, 39.90],
        "modernName": "åŒ—äº¬"
      },
      "territory": {
        "center": [116.00, 42.00],
        "bounds": {
          "north": 50,
          "south": 35,
          "east": 130,
          "west": 100
        },
        "majorCities": [
          {
            "name": "ä¸Šäº¬",
            "position": [126.60, 45.70],
            "modernName": "å“ˆå°”æ»¨",
            "type": "capital"
          },
          {
            "name": "ä¸œäº¬",
            "position": [123.40, 41.80],
            "modernName": "æ²ˆé˜³",
            "type": "secondary"
          },
          {
            "name": "è¥¿äº¬",
            "position": [112.53, 37.87],
            "modernName": "å¤ªåŸ",
            "type": "prefecture"
          },
          {
            "name": "å—äº¬",
            "position": [118.78, 32.04],
            "modernName": "å—äº¬",
            "type": "prefecture"
          }
        ]
      },
      "historicalEvents": [
        {
          "year": 1125,
          "event": "é‡‘ç­è¾½",
          "location": [123.40, 41.80],
          "description": "é‡‘æœå†›é˜Ÿæ”»é™·è¾½å›½ä¸œäº¬"
        },
        {
          "year": 1127,
          "event": "é–åº·ä¹‹å˜",
          "location": [114.48, 34.75],
          "description": "é‡‘å†›æ”»é™·åŒ—å®‹å¼€å°ï¼Œæ³èµ°å¾½é’¦äºŒå¸"
        }
      ],
      "mapStyle": {
        "baseColor": "#8B4513",
        "borderColor": "#CD853F",
        "cityColor": "#FFD700"
      }
    }
  ]
}
```

### 2. åŸå¸‚åç§°æ˜ å°„ (city_mappings.json)
```json
{
  "historicalToModern": {
    "ä¸­éƒ½": "åŒ—äº¬",
    "ä¸Šäº¬": "å“ˆå°”æ»¨", 
    "ä¸œäº¬": "æ²ˆé˜³",
    "è¥¿äº¬": "å¤ªåŸ",
    "å—äº¬": "å—äº¬",
    "ä¸´æ½¢": "å†…è’™å¤å·´æ—å·¦æ——",
    "å¤§å®š": "å†…è’™å¤å®åŸ",
    "æ±´äº¬": "å¼€å°",
    "æ´›é˜³": "æ´›é˜³",
    "é•¿å®‰": "è¥¿å®‰",
    "æˆéƒ½": "æˆéƒ½",
    "è¥„é˜³": "è¥„é˜³",
    "æ¨ŠåŸ": "æ¨ŠåŸ",
    "æ‰¬å·": "æ‰¬å·",
    "æ·®å®‰": "æ·®å®‰"
  },
  "dynastyCities": {
    "jin_1115": [
      {"name": "ä¸Šäº¬", "position": [126.60, 45.70]},
      {"name": "ä¸œäº¬", "position": [123.40, 41.80]},
      {"name": "è¥¿äº¬", "position": [112.53, 37.87]},
      {"name": "å—äº¬", "position": [118.78, 32.04]},
      {"name": "ä¸­éƒ½", "position": [116.40, 39.90]},
      {"name": "ä¸´æ½¢", "position": [119.40, 44.20]},
      {"name": "å¤§å®š", "position": [119.40, 41.60]},
      {"name": "æ±´äº¬", "position": [114.48, 34.75]}
    ],
    "song_960": [
      {"name": "å¼€å°", "position": [114.48, 34.75]},
      {"name": "ä¸´å®‰", "position": [120.15, 30.28]},
      {"name": "æˆéƒ½", "position": [104.06, 30.66]},
      {"name": "è¥„é˜³", "position": [112.08, 32.04]}
    ],
    "yuan_1271": [
      {"name": "å¤§éƒ½", "position": [116.40, 39.90]},
      {"name": "ä¸Šéƒ½", "position": [116.20, 42.20]},
      {"name": "æ³‰å·", "position": [118.60, 24.90]},
      {"name": "æ­å·", "position": [120.15, 30.28]}
    ]
  }
}
```

### 3. å†å²åœ°å›¾æ ·å¼é…ç½® (map_styles.json)
```json
{
  "dynastyStyles": {
    "jin_1115": {
      "filter": "sepia(0.6) saturate(1.2) hue-rotate(25deg)",
      "overlayColor": "rgba(139, 69, 19, 0.3)",
      "cityMarkers": {
        "capital": {"color": "#FFD700", "size": 20, "icon": "ğŸ‘‘"},
        "secondary": {"color": "#FF6347", "size": 16, "icon": "ğŸ›ï¸"},
        "prefecture": {"color": "#4169E1", "size": 12, "icon": "ğŸ¯"}
      }
    },
    "song_960": {
      "filter": "sepia(0.4) saturate(1.1) hue-rotate(15deg)",
      "overlayColor": "rgba(34, 139, 34, 0.3)",
      "cityMarkers": {
        "capital": {"color": "#FFD700", "size": 20, "icon": "ğŸ‘‘"},
        "major": {"color": "#DC143C", "size": 16, "icon": "ğŸ›ï¸"},
        "prefecture": {"color": "#4169E1", "size": 12, "icon": "ğŸ¯"}
      }
    }
  }
}
```

## å‰ç«¯å®ç°æ–¹æ¡ˆ

### 1. æœä»£é€‰æ‹©å™¨æ‰©å±•
```javascript
// æ‰©å±•ç°æœ‰çš„dynasty-select
const dynastySelect = document.getElementById('dynasty-select');
dynastySelect.innerHTML = `
  <option value="none">-- ç°ä»£åœ°å›¾ --</option>
  <optgroup label="å®‹è¾½é‡‘å…ƒ">
    <option value="song_960">åŒ—å®‹ (960-1127)</option>
    <option value="liao_907">è¾½æœ (907-1125)</option>
    <option value="jin_1115">é‡‘æœ (1115-1234)</option>
    <option value="yuan_1271">å…ƒæœ (1271-1368)</option>
  </optgroup>
  <optgroup label="æ˜æ¸…">
    <option value="ming_1368">æ˜æœ (1368-1644)</option>
    <option value="qing_1644">æ¸…æœ (1644-1912)</option>
  </optgroup>
  <optgroup label="è¿‘ç°ä»£">
    <option value="CCTS_1911">ä¸­åæ°‘å›½ (1912-1949)</option>
  </optgroup>
`;
```

### 2. æœä»£åœ°å›¾åŠ è½½å‡½æ•°
```javascript
async function loadDynastyMap(dynastyId) {
  try {
    // åŠ è½½æœä»£æ•°æ®
    const dynastyData = await fetch(`/api/v1/dynasty/${dynastyId}`).then(r => r.json());
    
    // æ¸…é™¤ç°æœ‰å›¾å±‚
    clearHistoricalLayers();
    
    // è®¾ç½®åœ°å›¾æ ·å¼
    applyDynastyMapStyle(dynastyId, dynastyData);
    
    // æ·»åŠ åŸå¸‚æ ‡è®°
    addDynastyCities(dynastyData);
    
    // æ·»åŠ å†å²äº‹ä»¶
    addHistoricalEvents(dynastyData);
    
    // è°ƒæ•´è§†è§’åˆ°æœä»£ä¸­å¿ƒ
    map.setCenterAndZoom(dynastyData.territory.center, 6);
    
  } catch (error) {
    console.error('åŠ è½½æœä»£åœ°å›¾å¤±è´¥:', error);
  }
}

function applyDynastyMapStyle(dynastyId, dynastyData) {
  const style = dynastyData.mapStyle;
  
  // åº”ç”¨å†å²åœ°å›¾æ»¤é•œ
  document.getElementById('map').style.filter = style.filter;
  
  // å¦‚æœæœ‰å†å²åœ°å›¾WMTSå›¾å±‚ï¼ŒåŠ è½½å®ƒ
  if (dynastyData.wmtsLayer) {
    wmtsLayer = new AMap.TileLayer.WMTS({
      url: dynastyData.wmtsLayer.url,
      params: {
        Layer: dynastyData.wmtsLayer.layer,
        Style: 'default',
        TileMatrixSet: 'GoogleMapsCompatible',
        Format: 'image/png'
      }
    });
    map.add(wmtsLayer);
  }
}

function addDynastyCities(dynastyData) {
  dynastyData.territory.majorCities.forEach(city => {
    const marker = createHistoricalCityMarker(city);
    map.add(marker);
    historicalMarkers.push(marker);
  });
}

function createHistoricalCityMarker(city) {
  const markerConfig = getCityMarkerConfig(city.type, city.dynasty);
  
  return new AMap.Marker({
    position: city.position,
    content: createCityMarkerContent(city, markerConfig),
    offset: new AMap.Pixel(-15, -30),
    title: `${city.name} (${city.modernName})`,
    zIndex: 100
  });
}

function createCityMarkerContent(city, config) {
  return `
    <div style="display: flex; flex-direction: column; align-items: center;">
      <div style="
        background: ${config.color}; 
        width: ${config.size}px; 
        height: ${config.size}px; 
        border-radius: 50%; 
        border: 2px solid white;
        display: flex; align-items: center; justify-content: center;
        font-size: ${config.size * 0.6}px;
        box-shadow: 2px 2px 8px rgba(0,0,0,0.5);
      ">
        ${config.icon}
      </div>
      <div style="
        background: rgba(0,0,0,0.8); 
        color: white; 
        padding: 4px 8px; 
        border-radius: 4px; 
        font-size: 12px; 
        margin-top: 5px;
        text-align: center;
        white-space: nowrap;
        max-width: 120px;
      ">
        ${city.name}<br>
        <small style="opacity: 0.7;">${city.modernName}</small>
      </div>
    </div>
  `;
}
```

### 3. å†å²äº‹ä»¶æ—¶é—´è½´
```javascript
function showDynastyTimeline(dynastyData) {
  const timeline = document.getElementById('timeline');
  const events = dynastyData.historicalEvents.sort((a, b) => a.year - b.year);
  
  // è®¾ç½®æ—¶é—´è½´èŒƒå›´
  timeline.min = dynastyData.startYear;
  timeline.max = dynastyData.endYear;
  timeline.value = dynastyData.startYear;
  
  // ç›‘å¬æ—¶é—´è½´å˜åŒ–
  timeline.addEventListener('input', (e) => {
    const currentYear = parseInt(e.target.value);
    showEventsForYear(currentYear, events);
  });
}

function showEventsForYear(year, events) {
  // æ¸…é™¤ç°æœ‰äº‹ä»¶æ ‡è®°
  clearEventMarkers();
  
  // æ˜¾ç¤ºå½“å¹´åŠä¹‹å‰çš„äº‹ä»¶
  events.filter(event => event.year <= year).forEach(event => {
    const eventMarker = createEventMarker(event);
    map.add(eventMarker);
    eventMarkers.push(eventMarker);
  });
}
```

### 4. åŸå¸‚æœç´¢å¢å¼º
```javascript
function initHistoricalSearch() {
  const autoComplete = new AMap.AutoComplete({
    input: "search-input"
  });
  
  autoComplete.on("select", function(e) {
    const query = e.poi.name;
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯å†å²åŸå¸‚å
    const historicalCity = findHistoricalCity(query);
    if (historicalCity) {
      showHistoricalCity(historicalCity);
      return;
    }
    
    // åŸæœ‰æœç´¢é€»è¾‘
    placeSearchInstance.setCity(e.poi.adcode);
    placeSearchInstance.search(e.poi.name);
  });
}

function findHistoricalCity(query) {
  // åœ¨å†å²åŸå¸‚æ•°æ®ä¸­æŸ¥æ‰¾
  for (const dynastyId in dynastyCities) {
    const cities = dynastyCities[dynastyId];
    const city = cities.find(c => 
      c.name === query || 
      c.modernName === query ||
      c.name.includes(query) ||
      query.includes(c.name)
    );
    if (city) {
      return { ...city, dynastyId };
    }
  }
  return null;
}
```

## åç«¯APIè®¾è®¡

### 1. æœä»£æ•°æ®API
```python
# src/api/dynasty_api.py
from fastapi import APIRouter, HTTPException
import json

router = APIRouter()

@router.get("/dynasty/{dynasty_id}")
async def get_dynasty_data(dynasty_id: str):
    """è·å–æœä»£è¯¦ç»†ä¿¡æ¯"""
    try:
        with open("knowledge_base/dynasties.json", "r", encoding="utf-8") as f:
            data = json.load(f)
        
        dynasty = next((d for d in data["dynasties"] if d["id"] == dynasty_id), None)
        if not dynasty:
            raise HTTPException(status_code=404, detail="æœä»£æœªæ‰¾åˆ°")
            
        return dynasty
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.get("/dynasties")
async def get_all_dynasties():
    """è·å–æ‰€æœ‰æœä»£åˆ—è¡¨"""
    with open("knowledge_base/dynasties.json", "r", encoding="utf-8") as f:
        data = json.load(f)
    return data["dynasties"]

@router.get("/cities/{dynasty_id}")
async def get_dynasty_cities(dynasty_id: str):
    """è·å–æŒ‡å®šæœä»£çš„åŸå¸‚æ•°æ®"""
    with open("knowledge_base/city_mappings.json", "r", encoding="utf-8") as f:
        data = json.load(f)
    
    cities = data["dynastyCities"].get(dynasty_id, [])
    return {"dynastyId": dynasty_id, "cities": cities}
```

### 2. ä¸»åº”ç”¨é›†æˆ
```python
# src/main.py ä¸­æ·»åŠ 
try:
    from src.api.dynasty_api import router as dynasty_router
    app.include_router(dynasty_router, prefix="/api/v1")
except ImportError:
    print("âš ï¸ æœä»£APIæ¨¡å—æœªæ‰¾åˆ°")
```

## æ ¸å¿ƒä¼˜åŠ¿

### 1. æ•°æ®é©±åŠ¨
- JSONæ ¼å¼å­˜å‚¨ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
- å†å²ä¸ç°ä»£åœ°åæ˜ å°„å…³ç³»æ˜ç¡®
- æ”¯æŒå¤æ‚çš„å†å²äº‹ä»¶æ—¶é—´åºåˆ—

### 2. ç”¨æˆ·ä½“éªŒ
- ä¸€é”®åˆ‡æ¢å†å²æœä»£è§†å›¾
- æ‚¬åœæ˜¾ç¤ºå†å²åœ°åå’Œç°ä»£å¯¹ç…§
- æ—¶é—´è½´æ§åˆ¶å†å²äº‹ä»¶æ˜¾ç¤º

### 3. æŠ€æœ¯æ¶æ„
- æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºç»´æŠ¤
- ç¼“å­˜æœºåˆ¶æå‡æ€§èƒ½
- å“åº”å¼è®¾è®¡é€‚é…å„ç§è®¾å¤‡

### 4. æ‰©å±•æ€§
- è½»æ¾æ·»åŠ æ–°çš„æœä»£æ•°æ®
- æ”¯æŒè‡ªå®šä¹‰åœ°å›¾æ ·å¼
- å¯é›†æˆæ›´å¤šå†å²æ•°æ®æº

